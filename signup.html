<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Sign Up â€” Calculator Gaji HASA UiTM</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script src="firebase-config.js"></script>
<script src="auth.js"></script>

<style>
    /* ===== VARIABLES & RESET ===== */
    :root {
        --primary-grad: linear-gradient(135deg, #FF6B6B 0%, #5E2A84 100%);
        --text-dark: #1f2937;
        --text-muted: #6b7280;
        --glass-bg: rgba(255, 255, 255, 0.75);
        --glass-border: rgba(255, 255, 255, 0.6);
        --radius: 16px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
        font-family: 'Outfit', sans-serif;
        background: #f3f0ff;
        color: var(--text-dark);
        
        /* FIX SCREEN - NO SCROLL ON BODY */
        height: 100vh;
        width: 100vw;
        overflow: hidden; 
        
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
    }

    /* ===== FLOATING BLOBS ===== */
    .blob {
        position: absolute;
        border-radius: 50%;
        filter: blur(80px);
        opacity: 0.6;
        z-index: -1;
        animation: float 10s ease-in-out infinite;
        pointer-events: none;
    }
    .blob1 { width: 400px; height: 400px; background: #FF6B6B; top: -100px; left: -100px; animation-delay: 0s; }
    .blob2 { width: 350px; height: 350px; background: #5E2A84; bottom: -50px; right: -50px; animation-delay: 2s; }
    .blob3 { width: 300px; height: 300px; background: #A445B2; top: 40%; left: 50%; transform: translate(-50%, -50%); opacity: 0.4; animation-delay: 4s; }

    @keyframes float {
        0%, 100% { transform: translate(0, 0); }
        50% { transform: translate(20px, -20px); }
    }

    /* ===== BACK BUTTON ===== */
    .back-nav-float {
        position: absolute;
        top: 25px; left: 25px; z-index: 100;
        display: flex; align-items: center; gap: 10px;
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        padding: 10px 20px; border-radius: 30px;
        border: 1px solid rgba(255, 255, 255, 0.4);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        text-decoration: none; color: #5E2A84;
        font-weight: 600; font-size: 0.95rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-family: 'Outfit', sans-serif;
    }
    .back-nav-float:hover { background: white; transform: translateY(-2px); box-shadow: 0 8px 20px rgba(94, 42, 132, 0.15); color: #4c1d6e; }
    .back-nav-float svg { width: 20px; height: 20px; transition: transform 0.3s ease; }
    
    @media (max-width: 768px) {
        .back-nav-float { top: 20px; left: 20px; padding: 0; width: 44px; height: 44px; border-radius: 50%; justify-content: center; gap: 0; }
        .back-nav-float span { display: none; }
    }

    /* ===== MAIN WRAPPER ===== */
    .main-wrapper {
        width: 100%; max-width: 440px; padding: 20px; z-index: 10;
        max-height: 100vh; overflow-y: auto; scrollbar-width: none;
    }
    .main-wrapper::-webkit-scrollbar { display: none; }

    .card {
        background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border); border-radius: var(--radius);
        padding: 30px; 
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.05), 0 1px 3px rgba(0,0,0,0.1);
        text-align: left;
    }

    .card h2 {
        font-family: 'Outfit', sans-serif; font-size: 1.8rem; font-weight: 800; margin-bottom: 5px;
        background: var(--primary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        text-align: center; letter-spacing: 0.5px;
    }
    .card p.subtitle { text-align: center; color: var(--text-muted); margin-bottom: 20px; font-size: 0.95rem; font-weight: 400; }

    /* ===== FORM ===== */
    .input-group { margin-bottom: 12px; position: relative; }
    
    .input {
        width: 100%; padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 10px;
        font-size: 1rem; background: rgba(255,255,255,0.9);
        font-family: 'Outfit', sans-serif; color: var(--text-dark); font-weight: 500;
    }
    .input::placeholder { font-weight: 400; color: #9ca3af; }
    .input:focus { outline: none; border-color: #5E2A84; box-shadow: 0 0 0 4px rgba(94, 42, 132, 0.1); }
    
    /* PASSWORD SHOW/HIDE WRAPPER */
    .password-wrap { position: relative; }
    .show-pass-btn {
        position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
        background: none; border: none; cursor: pointer; color: #9ca3af; padding: 5px;
        display: flex; align-items: center; justify-content: center;
    }

    /* CUSTOM SELECT & ARROW STYLING */
    .select-wrapper { position: relative; width: 100%; }
    select.input { appearance: none; -webkit-appearance: none; -moz-appearance: none; cursor: pointer; padding-right: 40px; }

    .custom-arrow {
        position: absolute; right: 15px; top: 50%; transform: translateY(-50%); pointer-events: none;
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); width: 20px; height: 20px; color: #6b7280;
    }
    .select-wrapper.active .custom-arrow { transform: translateY(-50%) rotate(-90deg); color: #5E2A84; }

    /* Button */
    .btn {
        width: 100%; padding: 14px; border: none; border-radius: 10px;
        font-weight: 700; font-size: 1.05rem; cursor: pointer;
        display: flex; justify-content: center; align-items: center; gap: 10px;
        font-family: 'Outfit', sans-serif; background: var(--primary-grad); color: white;
        box-shadow: 0 10px 20px -5px rgba(94, 42, 132, 0.3); margin-top: 15px;
        letter-spacing: 0.5px;
    }
    .btn:active { transform: scale(0.98); }
    
    .link-center { text-align: center; margin-top: 18px; display: block; color: #5E2A84; text-decoration: none; font-size: 0.95rem; font-weight: 500; }
    .link-center b { font-weight: 700; }

    #signupMsg { margin-top: 10px; font-size: 0.9rem; text-align: center; min-height: 20px; font-weight: 500; }
    .fade-in { animation: fadeIn 0.5s ease-out forwards; opacity: 0; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .spinner {
        width: 18px; height: 18px; border: 2px solid #fff; border-bottom-color: transparent;
        border-radius: 50%; display: none; animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>

<body>

    <div class="blob blob1"></div>
    <div class="blob blob2"></div>
    <div class="blob blob3"></div>

    <a href="login.html" class="back-nav-float">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        <span>Kembali ke Login</span>
    </a>

    <div class="main-wrapper fade-in">
        <div class="card">
            <h2>Daftar Akaun</h2>
            <p class="subtitle">Isi maklumat di bawah.</p>

            <form onsubmit="event.preventDefault();"> 
                
                <div class="input-group">
                    <input id="fullname" class="input" type="text" placeholder="Nama Penuh" required>
                </div>

                <div class="input-group">
                    <input id="email" class="input" type="email" placeholder="Alamat Emel" required>
                </div>

                <div class="input-group">
                    <input id="phone" class="input" type="tel" placeholder="No. Telefon" required>
                </div>

                <div class="input-group select-wrapper" id="genderWrapper">
                    <select id="gender" class="input" required>
                        <option value="" disabled selected>Pilih Jantina</option>
                        <option value="lelaki">Lelaki</option>
                        <option value="perempuan">Perempuan</option>
                    </select>
                    <svg xmlns="http://www.w3.org/2000/svg" class="custom-arrow" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                    </svg>
                </div>

                <div class="input-group select-wrapper" id="ageWrapper">
                    <select id="ageRange" class="input" required>
                        <option value="" disabled selected>Pilih Lingkungan Umur</option>
                        <option value="25-35">25-35 Tahun</option>
                        <option value="36-45">36-45 Tahun</option>
                        <option value="46-55">46-55 Tahun</option>
                        <option value="selain_itu">Selain Itu</option>
                    </select>
                    <svg xmlns="http://www.w3.org/2000/svg" class="custom-arrow" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                    </svg>
                </div>

                <div class="input-group" id="manualAgeGroup" style="display:none;">
                    <input id="manualAge" class="input" type="number" placeholder="Sila nyatakan umur anda (Contoh: 23)">
                </div>

                <div class="input-group password-wrap">
                    <input id="password" class="input" type="password" placeholder="Kata Laluan" required>
                    <button type="button" class="show-pass-btn" id="showPassBtn1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    </button>
                </div>

                <div class="input-group password-wrap">
                    <input id="confirmPassword" class="input" type="password" placeholder="Sahkan Kata Laluan" required>
                    <button type="button" class="show-pass-btn" id="showPassBtn2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    </button>
                </div>

                <button id="signupBtn" class="btn btn-primary">
                    <span>Daftar Akaun</span>
                    <span id="btnSpinner" class="spinner"></span>
                </button>

                <div id="signupMsg"></div>

                <a href="login.html" class="link-center">Sudah ada akaun? <b>Log Masuk</b></a>
            </form>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {

    // ===== VARIABLES =====
    const signupBtn = document.getElementById('signupBtn');
    const msg = document.getElementById('signupMsg');
    const passInput = document.getElementById('password');
    const confirmPassInput = document.getElementById('confirmPassword'); 
    const nameInput = document.getElementById('fullname');
    const btnSpinner = document.getElementById('btnSpinner');

    // Show/Hide Password Logic
    const showBtn1 = document.getElementById('showPassBtn1');
    const showBtn2 = document.getElementById('showPassBtn2');

    showBtn1.addEventListener('click', () => {
        const type = passInput.type === 'password' ? 'text' : 'password';
        passInput.type = type;
        showBtn1.style.color = type === 'text' ? '#5E2A84' : '#9ca3af';
    });

    showBtn2.addEventListener('click', () => {
        const type = confirmPassInput.type === 'password' ? 'text' : 'password';
        confirmPassInput.type = type;
        showBtn2.style.color = type === 'text' ? '#5E2A84' : '#9ca3af';
    });

    // ===== DROPDOWN ANIMATION LOGIC =====
    function setupDropdown(id, wrapperId) {
        const el = document.getElementById(id);
        const wrapper = document.getElementById(wrapperId);
        el.addEventListener('focus', () => wrapper.classList.add('active'));
        el.addEventListener('click', () => wrapper.classList.add('active'));
        el.addEventListener('change', () => { wrapper.classList.remove('active'); el.blur(); });
        el.addEventListener('blur', () => wrapper.classList.remove('active'));
    }

    setupDropdown('gender', 'genderWrapper');
    setupDropdown('ageRange', 'ageWrapper');

    // ===== AGE LOGIC (SELAIN ITU) =====
    const ageSelect = document.getElementById('ageRange');
    const manualAgeGroup = document.getElementById('manualAgeGroup');
    const manualAgeInput = document.getElementById('manualAge');

    ageSelect.addEventListener('change', function() {
        if(this.value === 'selain_itu') {
            manualAgeGroup.style.display = 'block';
            manualAgeInput.required = true;
            manualAgeInput.focus();
        } else {
            manualAgeGroup.style.display = 'none';
            manualAgeInput.required = false;
            manualAgeInput.value = '';
        }
    });

    // ===== AUTO UPPERCASE NAME =====
    nameInput.addEventListener('input', function() {
        this.value = this.value.toUpperCase();
    });

    // ===== HELPER FUNCTIONS =====
    function setLoading(isLoading) {
        signupBtn.disabled = isLoading;
        btnSpinner.style.display = isLoading ? 'inline-block' : 'none';
    }

    function setMessage(text, color) {
        msg.textContent = text;
        msg.style.color = color;
    }

    // ===== SIGNUP LOGIC =====
    signupBtn.addEventListener('click', async () => {
        const name   = nameInput.value.trim().toUpperCase();
        const email  = document.getElementById('email').value.trim();
        const phone  = document.getElementById('phone').value.trim();
        const pwd    = passInput.value;
        const confirmPwd = confirmPassInput.value; 
        const gender = document.getElementById('gender').value;
        const ageSelection = ageSelect.value;
        const ageManual = manualAgeInput.value.trim();

        setMessage('', '');

        // Determine Final Age
        let finalAge = '';
        if (ageSelection === 'selain_itu') {
            finalAge = ageManual;
        } else {
            finalAge = ageSelection;
        }

        // Validation
        if (!name || !email || !phone || !pwd || !confirmPwd || !gender || !finalAge) {
            setMessage('Sila lengkapkan semua ruangan termasuk umur.', '#ef4444'); 
            return;
        }
        
        // Semak Kata Laluan Sama
        if (pwd !== confirmPwd) {
            setMessage('Kata laluan tidak sepadan. Sila cuba lagi.', '#ef4444');
            return;
        }

        if (pwd.length < 6) {
            setMessage('Kata laluan mesti sekurang-kurangnya 6 aksara.', '#ef4444'); 
            return;
        }

        let role = 'pengguna';
        if(email.endsWith('@uitm.edu.my')) role = 'pentadbir';

        setLoading(true);

        try {
            // 1. Create User via Auth Function (Creates Auth + Basic Doc)
            await signupUser(name, email, phone, pwd, role, gender);

            // 2. EXPLICITLY SAVE AGE TO FIRESTORE (Fix for Auth.js Limitation)
            const user = firebase.auth().currentUser;
            if (user) {
                await db.collection('users').doc(user.uid).set({
                    age: finalAge,
                    // Re-save critical info just in case auth.js missed something
                    fullname: name,
                    email: email,
                    phone: phone,
                    gender: gender,
                    role: role,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
            }

            // 3. Logout & Redirect
            await firebase.auth().signOut();

            setMessage('Pendaftaran berjaya! Sila log masuk semula...', '#10b981'); 
            
            setTimeout(() => {
                location.href = 'login.html';
            }, 1500);

        } catch(err) {
            console.error(err);
            let errorMsg = err.message;
            if(err.code === 'auth/email-already-in-use') errorMsg = "Email ini telah didaftarkan.";
            if(err.code === 'auth/weak-password') errorMsg = "Kata laluan terlalu lemah.";
            
            setMessage(errorMsg, '#ef4444');
        } finally {
            setLoading(false);
        }
    });

    // ===== BLOB ANIMATION =====
    const blobs = document.querySelectorAll('.blob');
    document.addEventListener('mousemove', (e) => {
        const x = (e.clientX / window.innerWidth) * 20;
        const y = (e.clientY / window.innerHeight) * 20;
        blobs.forEach((blob, index) => {
            const speed = (index + 1) * 2;
            blob.style.transform = `translate(${x * speed}px, ${y * speed}px)`;
        });
    });

});
</script>
</body>
</html>
