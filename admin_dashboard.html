<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Admin - Dashboard Utama</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* =========================================
   CORE THEME
   ========================================= */
:root {
    --primary: #6C63FF; --primary-dark: #5a52d5;
    --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
    --bg-body: #F3F4F6; --surface: rgba(255, 255, 255, 0.65);
    --surface-card: rgba(255, 255, 255, 0.9);
    --text-main: #334155; --text-light: #64748b; --border: rgba(255,255,255,0.6);
    --glass: blur(12px); --shadow: 0 10px 30px -10px rgba(0,0,0,0.1);
}

body.dark-mode {
    --bg-body: #0f172a; --surface: rgba(30, 41, 59, 0.6);
    --surface-card: rgba(30, 41, 59, 0.9);
    --text-main: #f1f5f9; --text-light: #94a3b8; --border: rgba(255,255,255,0.08);
    --shadow: 0 10px 30px -10px rgba(0,0,0,0.5);
}

* { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
body { font-family: 'Poppins', sans-serif; background-color: var(--bg-body); color: var(--text-main); min-height: 100vh; overflow-x: hidden; transition: 0.3s; display: flex; flex-direction: column; }

/* BLOBS */
.bg-blobs { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; }
.blob { position: absolute; filter: blur(80px); opacity: 0.6; animation: floatBlob 10s infinite alternate; }
.blob-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: #abbdf6; }
.blob-2 { bottom: -10%; right: -10%; width: 60vw; height: 60vw; background: #F0FDFA; }
body.dark-mode .blob { opacity: 0.15; }
@keyframes floatBlob { 0% { transform: translate(0,0); } 100% { transform: translate(20px, 40px); } }

/* NAVBAR */
.navbar { 
    display: flex; justify-content: space-between; align-items: center; 
    padding: 15px 5%; margin: 20px; 
    background: var(--surface); backdrop-filter: var(--glass); 
    border-radius: 50px; position: sticky; top: 20px; z-index: 100; 
    border: 1px solid var(--border); box-shadow: var(--shadow); 
    transition: transform 0.4s ease, opacity 0.4s ease; 
}
.nav-hidden { transform: translateY(-150%); opacity: 0; pointer-events: none; }

.brand { font-weight: 800; font-size: 1.2rem; color: var(--primary); display: flex; align-items: center; gap: 10px; }

/* Navbar Right & Links */
.nav-right { display: flex; align-items: center; gap: 20px; }
.nav-links { display: flex; gap: 15px; }
.nav-link { text-decoration: none; color: var(--text-light); font-weight: 600; padding: 8px 16px; border-radius: 20px; transition: 0.3s; font-size: 0.9rem; }
.nav-link:hover, .nav-link.active { background: rgba(108, 99, 255, 0.1); color: var(--primary); }

.admin-badge { display: flex; align-items: center; gap: 10px; background: var(--bg-body); padding: 8px 20px; border-radius: 30px; font-size: 0.9rem; font-weight: 700; color: var(--text-main); border: 1px solid var(--border); box-shadow: var(--shadow); cursor: default; }
.admin-badge i { color: var(--success); font-size: 1.2rem; }
.admin-details { display: flex; flex-direction: column; line-height: 1.2; text-align: left; }
.admin-role-label { font-size: 0.65rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }

/* HAMBURGER (MOBILE) */
.hamburger { display: none; background: none; border: none; font-size: 1.5rem; color: var(--text-main); cursor: pointer; }

/* CONTAINER & LAYOUT */
.container { max-width: 1100px; margin: 0 auto; padding: 20px; padding-top: 40px; flex: 1; width: 100%; }
.page-header { margin-bottom: 30px; }
.page-title { font-size: 1.8rem; font-weight: 800; margin: 0; color: var(--text-main); }
.page-subtitle { font-size: 0.9rem; color: var(--text-light); margin-top: 5px; }

/* SUMMARY CARDS */
.summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
.summary-card { 
    background: var(--surface-card); backdrop-filter: var(--glass);
    border: 1px solid var(--border); border-radius: 24px; padding: 25px;
    display: flex; align-items: center; gap: 20px; box-shadow: var(--shadow);
    transition: transform 0.3s;
}
.summary-card:hover { transform: translateY(-5px); }
.card-icon {
    width: 60px; height: 60px; border-radius: 20px; display: flex; align-items: center; justify-content: center;
    font-size: 1.8rem; flex-shrink: 0;
}
.icon-users { background: #EEF2FF; color: #6C63FF; }
.icon-records { background: #ECFDF5; color: #10b981; }
.card-info h3 { margin: 0; font-size: 2rem; font-weight: 800; color: var(--text-main); line-height: 1; }
.card-info p { margin: 5px 0 0 0; font-size: 0.85rem; color: var(--text-light); font-weight: 600; }

/* CHARTS SECTION */
.charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
.chart-card {
    background: var(--surface-card); backdrop-filter: var(--glass);
    border: 1px solid var(--border); border-radius: 24px; padding: 25px;
    box-shadow: var(--shadow); display: flex; flex-direction: column;
}
.chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.chart-title { font-size: 1.1rem; font-weight: 700; color: var(--text-main); }
.header-controls { display: flex; gap: 10px; align-items: center; }

.filter-select {
    padding: 6px 12px; border-radius: 12px; border: 1px solid var(--border);
    background: var(--bg-body); color: var(--text-main); font-size: 0.8rem; font-weight: 600;
    cursor: pointer; outline: none; transition: 0.3s;
}
.btn-fullscreen {
    background: var(--bg-body); border: 1px solid var(--border); color: var(--text-light);
    width: 32px; height: 32px; border-radius: 10px; display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: 0.3s;
}
.btn-fullscreen:hover { background: var(--primary); color: white; border-color: var(--primary); }
.chart-container { position: relative; height: 300px; width: 100%; display: flex; align-items: center; justify-content: center; }

/* MODAL / POPOUT STYLES */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6); backdrop-filter: blur(8px);
    z-index: 2000; opacity: 0; visibility: hidden; transition: all 0.3s ease;
    display: flex; justify-content: center; align-items: center; padding: 20px;
}
.modal-overlay.show { opacity: 1; visibility: visible; }
.modal-content {
    background: var(--surface-card); width: 95%; max-width: 1200px; height: 85vh;
    border-radius: 30px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    border: 1px solid var(--border); overflow: hidden; display: flex; flex-direction: column;
    transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.modal-overlay.show .modal-content { transform: scale(1); }

.modal-header {
    padding: 20px 30px; border-bottom: 1px solid var(--border);
    display: flex; justify-content: space-between; align-items: center;
    background: rgba(255,255,255,0.05);
}
.modal-title { font-size: 1.4rem; font-weight: 800; color: var(--text-main); }
.modal-controls { display: flex; align-items: center; gap: 15px; }

.btn-close {
    background: #fee2e2; color: #ef4444; border: none; width: 40px; height: 40px;
    border-radius: 12px; font-size: 1.2rem; cursor: pointer; transition: 0.2s;
    display: flex; align-items: center; justify-content: center;
}
.btn-close:hover { background: #ef4444; color: white; transform: rotate(90deg); }

.modal-body { flex: 1; display: flex; overflow: hidden; }
.modal-chart-section { flex: 2; padding: 30px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-right: 1px solid var(--border); position: relative; }
.modal-details-section { 
    flex: 1; background: rgba(0,0,0,0.02); padding: 25px; 
    overflow-y: auto; display: flex; flex-direction: column; gap: 15px; 
}
.modal-canvas-wrapper { width: 100%; height: 100%; position: relative; }

/* DETAILED STATS ITEMS (FOR POPUP) */
.detail-card {
    background: var(--surface-card); padding: 15px; border-radius: 15px;
    border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    animation: fadeIn 0.3s ease;
}
@keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
.detail-label { font-size: 0.75rem; color: var(--text-light); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; }
.detail-value { font-size: 1rem; color: var(--text-main); font-weight: 700; margin-top: 3px; word-break: break-all; }
.detail-header { margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px dashed var(--border); font-weight: 700; color: var(--primary); display: flex; justify-content: space-between; align-items: center; }

/* FOOTER */
.footer {
    text-align: center; padding: 25px; margin-top: 20px;
    background: var(--surface); backdrop-filter: var(--glass);
    border-top: 1px solid var(--border);
    color: var(--text-light); font-size: 0.85rem; font-weight: 500;
}

/* FLOAT BTN */
.float-btn { position: fixed; width: 50px; height: 50px; border-radius: 50%; background: var(--surface); color: var(--text-main); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; z-index: 90; box-shadow: var(--shadow); transition: 0.3s; opacity: 0.6; }
.float-btn:hover { opacity: 1; }
#themeBtn { bottom: 30px; left: 30px; }

/* RESPONSIVE MOBILE */
@media(max-width: 900px) {
    /* 1. Navbar Mobile (Ikut coding asal anda) */
    .navbar { 
        flex-direction: column; 
        align-items: flex-start; 
        gap: 15px; 
        padding: 20px; 
        height: auto; 
        position: relative; 
    }
    .nav-right { 
        width: 100%; 
        flex-direction: column; 
        display: none; 
        margin-top: 15px; 
    }
    .nav-right.active { 
        display: flex; 
        animation: slideDown 0.3s ease; 
    }
    .nav-links { 
        width: 100%; 
        flex-direction: column; 
        align-items: center; 
    }
    .nav-link { 
        width: 100%; 
        text-align: center; 
        display: block; 
    }
    .hamburger { 
        display: block; 
        position: absolute; 
        right: 20px; 
        top: 20px; 
    }

    /* 2. STATISTIK BOX FIX (Supaya kemas di phone) */
    .stats-grid { 
        grid-template-columns: 1fr; /* Paksa jadi 1 lajur */
        gap: 15px; 
    }
    .stat-card { 
        padding: 20px; 
        min-height: auto; 
    }
    .stat-value { 
        font-size: 1.6rem; /* Kecilkan sikit font nombor */
    }

    /* 3. Layout Lain (Chart & Modal) */
    .charts-grid { 
        grid-template-columns: 1fr; 
    }
    .modal-body { 
        flex-direction: column; 
        overflow-y: auto; 
    }
    .modal-chart-section { 
        height: 400px; 
        border-right: none; 
        border-bottom: 1px solid var(--border); 
    }
    .modal-content { 
        height: 90vh; 
    }
    .modal-header { 
        flex-direction: column; 
        gap: 15px; 
        align-items: flex-start; 
    }
    .modal-controls { 
        width: 100%; 
        justify-content: space-between; 
    }
}

@keyframes slideDown { 
    from { opacity:0; transform:translateY(-10px); } 
    to { opacity:1; transform:translateY(0); } 
}

</style>
</head>
<body>

<div class="bg-blobs"><div class="blob blob-1"></div><div class="blob blob-2"></div></div>

<nav class="navbar" id="mainNav">
    <div class="brand"><i class="fa-solid fa-chart-line"></i> DASHBOARD</div>
    <button class="hamburger" onclick="toggleMenu()"><i class="fa-solid fa-bars"></i></button>
    
    <div class="nav-right" id="navMenu">
        <div class="admin-badge" id="adminBadge">
            <i class="fa-solid fa-circle-user"></i>
            <div class="admin-details">
                <span class="admin-role-label">Logged as</span>
                <span id="adminNameDisplay">Loading...</span>
            </div>
        </div>
        <div class="nav-links">
            <a href="dashboard.html" class="nav-link">Home</a>
            <a href="admin_dashboard.html" class="nav-link active">Dashboard</a>
            <a href="admin_users.html" class="nav-link">Users</a>
            <a href="admin_history.html" class="nav-link">Rekod</a>
            <a href="admin_salary.html" class="nav-link">Gaji</a>
        </div>
    </div>
</nav>

<div class="container">
    <div class="page-header">
        <h2 class="page-title">Selamat Datang, Admin!</h2>
        <p class="page-subtitle">Berikut adalah ringkasan data terkini sistem.</p>
    </div>

    <div class="summary-grid">
        <div class="summary-card">
            <div class="card-icon icon-users"><i class="fa-solid fa-users"></i></div>
            <div class="card-info">
                <h3 id="displayTotalUser">0</h3>
                <p>Jumlah Pengguna</p>
            </div>
        </div>
        <div class="summary-card">
            <div class="card-icon icon-records"><i class="fa-solid fa-file-invoice-dollar"></i></div>
            <div class="card-info">
                <h3 id="displayTotalRecord">0</h3>
                <p>Jumlah Rekod Pengiraan</p>
            </div>
        </div>
    </div>

    <div class="charts-grid">
        <div class="chart-card">
            <div class="chart-header">
                <div class="chart-title">Trend Pendaftaran</div>
                <div class="header-controls">
                    <select id="userFilter" class="filter-select" onchange="updateUserChart()">
                        <option value="1d">1 Hari</option>
                        <option value="7d" selected>7 Hari</option>
                        <option value="30d">30 Hari</option>
                        <option value="1y">Tahun Ini</option>
                    </select>
                    <button class="btn-fullscreen" onclick="openChartModal('user')" title="Lihat Penuh"><i class="fa-solid fa-expand"></i></button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="userChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <div class="chart-title">Statistik Sektor</div>
                <div class="header-controls">
                    <select id="recordFilter" class="filter-select" onchange="updateRecordChart()">
                        <option value="1d">1 Hari</option>
                        <option value="7d" selected>7 Hari</option>
                        <option value="30d">30 Hari</option>
                        <option value="1y">Tahun Ini</option>
                    </select>
                    <button class="btn-fullscreen" onclick="openChartModal('record')" title="Lihat Penuh"><i class="fa-solid fa-expand"></i></button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="recordChart"></canvas>
            </div>
        </div>
    </div>
</div>

<footer class="footer">
    <p>&copy; 2026 Sistem Pengurusan Kakitangan. Semua Hak Cipta Terpelihara.</p>
</footer>

<div class="modal-overlay" id="chartModal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title" id="modalTitle">Statistik Terperinci</div>
            <div class="modal-controls">
                <select id="modalFilter" class="filter-select" onchange="updateModalChart()">
                    <option value="1d">1 Hari</option>
                    <option value="7d">7 Hari</option>
                    <option value="30d">30 Hari</option>
                    <option value="1y">Tahun Ini</option>
                </select>
                <button class="btn-close" onclick="closeChartModal()"><i class="fa-solid fa-xmark"></i></button>
            </div>
        </div>
        <div class="modal-body">
            <div class="modal-chart-section">
                <div class="modal-canvas-wrapper">
                    <canvas id="bigChart"></canvas>
                </div>
                <p style="margin-top:10px; font-size:0.8rem; color:var(--text-light);"><i class="fa-solid fa-computer-mouse"></i> Klik pada carta untuk melihat perincian. Klik ruang kosong untuk reset.</p>
            </div>
            <div class="modal-details-section" id="modalDetails">
                <p style="text-align:center; color:var(--text-light);">Pilih data pada carta...</p>
            </div>
        </div>
    </div>
</div>

<button class="float-btn" id="themeBtn"><i class="fa-solid fa-moon"></i></button>

<script>
    if (!sessionStorage.getItem('admin_verified')) { window.location.href = 'admin_gate.html'; }

    const firebaseConfig = { apiKey: "AIzaSyDcCimpduiHdGyEmWHivg2tz_GkEgbnxf8", authDomain: "data-staff-6hha55.firebaseapp.com", projectId: "data-staff-6hha55", storageBucket: "data-staff-6hha55.firebasestorage.app", messagingSenderId: "834544418876", appId: "1:834544418876:web:71b355bd0f3faf73244339" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore(); const auth = firebase.auth();

    let rawUserData = [];
    let rawRecordData = [];
    let userMap = {}; // Untuk simpan ID -> Nama sebenar
    let chartInstanceUser = null;
    let chartInstanceRecord = null;
    let chartInstanceBig = null;
    let currentModalType = '';

    // THEME
    const themeBtn = document.getElementById('themeBtn');
    if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
    themeBtn.onclick = () => {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
        themeBtn.innerHTML = document.body.classList.contains('dark-mode') ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';
    };

    // NAV SCROLL HIDE
    let lastScrollTop = 0;
    const navbar = document.getElementById('mainNav');
    window.addEventListener('scroll', () => {
        let st = window.pageYOffset || document.documentElement.scrollTop;
        if (st > 100) { // Scroll down
            navbar.classList.add('nav-hidden');
        } else { // Scroll near top
            navbar.classList.remove('nav-hidden');
        }
    });

    // MOBILE MENU
    function toggleMenu() {
        document.getElementById('navMenu').classList.toggle('active');
    }

    auth.onAuthStateChanged(user => { 
        if(user) {
            loadAdminName();
            loadAllData();
        } else location.href='login.html';
    });

    async function loadAdminName() {
        const currentStafID = sessionStorage.getItem('current_admin_staf');
        if(currentStafID) {
            try {
                const snapshot = await db.collection('admin_whitelist').where('no_staf', '==', currentStafID).limit(1).get();
                if(!snapshot.empty) document.getElementById('adminNameDisplay').innerText = snapshot.docs[0].data().nama || "Pentadbir";
            } catch(e) {}
        }
    }

    // âš¡ CRITICAL FIX: Fetch Users Map First, Then Records
    async function loadAllData() {
        try {
            // 1. Fetch Users & Build Map
            const userSnap = await db.collection('users').get();
            rawUserData = [];
            userMap = {};
            
            userSnap.forEach(doc => {
                const d = doc.data();
                const realName = d.fullname || d.nama || d.name || d.email.split('@')[0];
                userMap[doc.id] = realName; // Map ID -> Name
                
                rawUserData.push({
                    id: doc.id,
                    name: realName,
                    email: d.email || "No Email",
                    createdAt: d.createdAt ? d.createdAt.toDate() : new Date(0)
                });
            });
            document.getElementById('displayTotalUser').innerText = rawUserData.length;

            // 2. Fetch Records & Map Names
            const recordSnap = await db.collection('printedSlips').get();
            rawRecordData = [];
            
            recordSnap.forEach(doc => {
                const d = doc.data();
                // Logic: Guna userMap[d.id] jika wujud (andaikan slip simpan ID user),
                // atau fallback ke field nama dalam slip
                let recordName = "User";
                if(d.userId && userMap[d.userId]) {
                    recordName = userMap[d.userId];
                } else {
                    recordName = d.fullname || d.nama_penuh || d.nama || d.name || "User";
                }

                rawRecordData.push({
                    id: doc.id,
                    name: recordName,
                    amount: d.gaji_bersih || 0,
                    timestamp: d.timestamp ? new Date(d.timestamp.seconds * 1000) : new Date(0),
                    sektor: (d.jenis_sektor || d.kategori || 'awam').toLowerCase()
                });
            });
            document.getElementById('displayTotalRecord').innerText = rawRecordData.length;

            // 3. Render
            updateUserChart();
            updateRecordChart();

        } catch(e) { console.error("Error loading data:", e); }
    }

    // FILTER HELPER
    function filterDataByTime(dataArray, timeKey, filterVal) {
        const now = new Date();
        let startTime = new Date();
        if (filterVal === '1d') startTime.setHours(0,0,0,0);
        else if (filterVal === '7d') startTime.setDate(now.getDate() - 7);
        else if (filterVal === '30d') startTime.setDate(now.getDate() - 30);
        else if (filterVal === '1y') startTime.setFullYear(now.getFullYear() - 1);
        return dataArray.filter(item => item[timeKey] >= startTime);
    }

    // CHART 1: USER
    function updateUserChart() {
        const filterVal = document.getElementById('userFilter').value;
        const filteredData = filterDataByTime(rawUserData, 'createdAt', filterVal);
        const counts = {};
        filteredData.forEach(item => {
            const dateStr = item.createdAt.toLocaleDateString('ms-MY', { day:'numeric', month:'short' });
            counts[dateStr] = (counts[dateStr] || 0) + 1;
        });

        const ctx = document.getElementById('userChart').getContext('2d');
        if(chartInstanceUser) chartInstanceUser.destroy();

        chartInstanceUser = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Object.keys(counts),
                datasets: [{
                    label: 'Pengguna Baru',
                    data: Object.values(counts),
                    borderColor: '#6C63FF',
                    backgroundColor: 'rgba(108, 99, 255, 0.2)',
                    borderWidth: 2, tension: 0.4, fill: true
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
            }
        });
    }

    // CHART 2: SECTOR
    function updateRecordChart() {
        const filterVal = document.getElementById('recordFilter').value;
        const filteredData = filterDataByTime(rawRecordData, 'timestamp', filterVal);
        let awam = 0, swasta = 0;
        filteredData.forEach(item => { if(item.sektor.includes('swasta')) swasta++; else awam++; });

        const ctx = document.getElementById('recordChart').getContext('2d');
        if(chartInstanceRecord) chartInstanceRecord.destroy();

        chartInstanceRecord = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Awam', 'Swasta'],
                datasets: [{
                    data: [awam, swasta],
                    backgroundColor: ['#6C63FF', '#10b981'],
                    borderWidth: 0, hoverOffset: 4
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } },
                cutout: '70%'
            }
        });
    }

    // MODAL LOGIC
    function openChartModal(type) {
        currentModalType = type;
        const modal = document.getElementById('chartModal');
        const title = document.getElementById('modalTitle');
        const modalFilter = document.getElementById('modalFilter');
        
        const dashboardFilterId = type === 'user' ? 'userFilter' : 'recordFilter';
        modalFilter.value = document.getElementById(dashboardFilterId).value;

        modal.classList.add('show');
        if(type === 'user') title.innerText = "Analisis Trend Pendaftaran";
        else title.innerText = "Analisis Sektor Pekerjaan";
        updateModalChart();
    }

    function closeChartModal() {
        document.getElementById('chartModal').classList.remove('show');
        if(chartInstanceBig) chartInstanceBig.destroy();
    }

    function updateModalChart() {
        if(currentModalType === 'user') renderBigUserChart();
        else renderBigRecordChart();
    }

    document.getElementById('chartModal').addEventListener('click', function(e) {
        if(e.target === this) closeChartModal();
    });

    function renderDefaultDetails(title, total, subtext) {
        const container = document.getElementById('modalDetails');
        container.innerHTML = `
            <div class="detail-header">
                <span>Ringkasan Keseluruhan</span>
                <i class="fa-solid fa-chart-pie"></i>
            </div>
            <div class="detail-card detail-highlight">
                <div class="detail-label">${title}</div>
                <div class="detail-value" style="font-size:1.5rem">${total}</div>
                <div class="detail-label" style="margin-top:5px; text-transform:none;">${subtext}</div>
            </div>
            <div class="detail-card">
                <div class="detail-label">Status</div>
                <div class="detail-value">Semua Data Dipaparkan</div>
            </div>
        `;
    }

    function renderBigUserChart() {
        const filterVal = document.getElementById('modalFilter').value;
        const filteredData = filterDataByTime(rawUserData, 'createdAt', filterVal);
        
        const grouped = {};
        filteredData.forEach(u => {
            const dateKey = u.createdAt.toLocaleDateString('ms-MY', { day:'numeric', month:'short', year:'numeric' });
            if(!grouped[dateKey]) grouped[dateKey] = [];
            grouped[dateKey].push(u);
        });

        const labels = Object.keys(grouped);
        const dataCounts = labels.map(k => grouped[k].length);

        renderDefaultDetails("Jumlah Pendaftaran", filteredData.length, "Klik titik graf untuk lihat senarai nama.");

        const ctx = document.getElementById('bigChart').getContext('2d');
        if(chartInstanceBig) chartInstanceBig.destroy();

        chartInstanceBig = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Pendaftaran', data: dataCounts,
                    borderColor: '#6C63FF', backgroundColor: 'rgba(108, 99, 255, 0.2)',
                    borderWidth: 3, pointRadius: 6, pointHoverRadius: 9, fill: true, tension: 0.3
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: {display:false} },
                onClick: (e, activeEls) => {
                    if(activeEls.length > 0) {
                        const index = activeEls[0].index;
                        const dateKey = labels[index];
                        showUserDetails(dateKey, grouped[dateKey]);
                    } else {
                        renderDefaultDetails("Jumlah Pendaftaran", filteredData.length, "Klik titik graf untuk lihat senarai nama.");
                    }
                }
            }
        });
    }

    function showUserDetails(dateKey, list) {
        const container = document.getElementById('modalDetails');
        let html = `
            <div class="detail-header">
                <span>${dateKey}</span>
                <span style="background:var(--primary); color:white; padding:2px 8px; border-radius:10px; font-size:0.7rem;">${list.length} User</span>
            </div>`;
        list.forEach(u => {
            html += `
            <div class="detail-card">
                <div class="detail-label">Nama</div>
                <div class="detail-value">${u.name}</div>
                <div class="detail-label" style="margin-top:5px;">Email</div>
                <div class="detail-value" style="font-size:0.85rem; font-weight:500;">${u.email}</div>
            </div>`;
        });
        container.innerHTML = html;
    }

    function renderBigRecordChart() {
        const filterVal = document.getElementById('modalFilter').value;
        const filteredData = filterDataByTime(rawRecordData, 'timestamp', filterVal);

        let awamList = [], swastaList = [];
        filteredData.forEach(r => {
            if(r.sektor.includes('swasta')) swastaList.push(r); else awamList.push(r);
        });

        renderDefaultDetails("Jumlah Pengiraan", filteredData.length, "Klik carta untuk lihat senarai pengiraan.");

        const ctx = document.getElementById('bigChart').getContext('2d');
        if(chartInstanceBig) chartInstanceBig.destroy();

        chartInstanceBig = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Sektor Awam', 'Sektor Swasta'],
                datasets: [{
                    data: [awamList.length, swastaList.length],
                    backgroundColor: ['#6C63FF', '#10b981'],
                    borderWidth: 2, hoverOffset: 15
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                layout: { padding: 20 },
                plugins: { legend: { position:'bottom', labels:{padding:20, font:{size:14}} } },
                onClick: (e, activeEls) => {
                    if(activeEls.length > 0) {
                        const idx = activeEls[0].index;
                        if(idx === 0) showRecordDetails('Sektor Awam', awamList, '#6C63FF');
                        else showRecordDetails('Sektor Swasta', swastaList, '#10b981');
                    } else {
                        renderDefaultDetails("Jumlah Pengiraan", filteredData.length, "Klik carta untuk lihat senarai pengiraan.");
                    }
                }
            }
        });
    }

    function showRecordDetails(title, list, color) {
        const container = document.getElementById('modalDetails');
        list.sort((a,b) => b.amount - a.amount);

        let html = `
            <div class="detail-header" style="color:${color}; border-color:${color}">
                <span>${title}</span>
                <span style="background:${color}; color:white; padding:2px 8px; border-radius:10px; font-size:0.7rem;">${list.length} Rekod</span>
            </div>`;
        
        if(list.length === 0) html += `<p style="text-align:center; margin-top:20px; color:var(--text-light);">Tiada rekod.</p>`;
        else {
            list.slice(0, 50).forEach(r => {
                html += `
                <div class="detail-card" style="border-left: 3px solid ${color}">
                    <div style="display:flex; justify-content:space-between;">
                        <div>
                            <div class="detail-label">Nama</div>
                            <div class="detail-value" style="font-size:0.9rem;">${r.name}</div>
                        </div>
                        <div style="text-align:right;">
                            <div class="detail-label">Gaji Bersih</div>
                            <div class="detail-value" style="color:${color}">RM ${parseFloat(r.amount).toFixed(2)}</div>
                        </div>
                    </div>
                    <div class="detail-label" style="margin-top:5px; text-transform:none; font-size:0.7rem;">${r.timestamp.toLocaleString()}</div>
                </div>`;
            });
            if(list.length > 50) html += `<p style="text-align:center; font-size:0.8rem; color:var(--text-light);">...dan ${list.length - 50} lagi.</p>`;
        }
        container.innerHTML = html;
    }
</script>
</body>
</html>
