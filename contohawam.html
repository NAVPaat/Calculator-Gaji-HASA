<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Kiraan Gaji — Awam</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<style>
body {
    opacity: 0; /* Mula-mula page halimunan */
    transition: opacity 0.5s ease-in-out; /* Tempoh peralihan 0.5 saat */
    pointer-events: none; /* Halang klik masa tengah loading */
}

body.loaded {
    opacity: 1; /* Muncul sepenuhnya */
    pointer-events: auto; /* Boleh klik semula */
}

    /* ===== THEME VARIABLES ===== */
    :root {
        --bg-main: #f8fafc;
        --bg-card: #ffffff;
        --text-primary: #0f172a;
        --text-secondary: #64748b;
        --brand-blue: #4f46e5;
        --brand-green: #10b981;
        --brand-warning: #f59e0b;
        --border-light: #e2e8f0;
        --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.1);
        --shadow-md: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }

    * { box-sizing: border-box; }

    body {
        margin: 0; padding: 0;
        /* FIX: Tiada padding supaya header lekat dengan nav */
        padding-top: 0; 
        font-family: 'Inter', sans-serif;
        background-color: var(--bg-main);
        color: var(--text-primary);
        min-height: 100vh;
        position: relative;
        overflow-x: hidden;
        padding-bottom: 50px;
    }

    /* BACKGROUND */
    .animated-bg {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: #f3f4f6;
        background-image: 
            radial-gradient(at 0% 0%, hsla(253,16%,7%,0) 0, transparent 50%), 
            radial-gradient(at 50% 0%, hsla(225,39%,30%,0) 0, transparent 50%), 
            radial-gradient(at 100% 0%, hsla(339,49%,30%,0) 0, transparent 50%);
        background-image: 
            radial-gradient(at 40% 20%, hsla(28,100%,74%,1) 0px, transparent 50%),
            radial-gradient(at 80% 0%, hsla(189,100%,56%,1) 0px, transparent 50%),
            radial-gradient(at 0% 50%, hsla(355,100%,93%,1) 0px, transparent 50%),
            radial-gradient(at 80% 50%, hsla(340,100%,76%,1) 0px, transparent 50%),
            radial-gradient(at 0% 100%, hsla(22,100%,77%,1) 0px, transparent 50%),
            radial-gradient(at 80% 100%, hsla(242,100%,70%,1) 0px, transparent 50%),
            radial-gradient(at 0% 0%, hsla(343,100%,76%,1) 0px, transparent 50%);
        filter: blur(60px); opacity: 0.6; z-index: -1;
        background-size: 150% 150%;
        animation: gradientFull 15s ease infinite alternate;
    }

    @keyframes gradientFull { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

    /* NAVBAR FIX: Relative (scroll away) & No Margin (Lekat Header) */
    .dashboard-nav {
        display: flex; justify-content: space-between; align-items: center; padding: 15px 30px;
        background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px);
        border-bottom: 1px solid rgba(255,255,255,0.6); 
        position: relative; /* Ikut scroll (akan hilang bila scroll bawah) */
        width: 100%;
        z-index: 999; 
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        height: 70px;
        margin-bottom: 0; /* FIX: Buang gap bawah nav */
/* Perubahan Utama Di Sini: */
    position: sticky; /* Tukar dari relative ke sticky */
    top: 0; 
    z-index: 999; 
    transition: transform 0.3s ease-in-out; /* Animasi gerak */
    will-change: transform;
    height: 70px;
    margin-bottom: 0;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
}

/* Class untuk sorok navbar bila scroll ke bawah */
.dashboard-nav.nav-hidden {
    transform: translateY(-100%);
}
    
    .nav-left { display: flex; align-items: center; gap: 12px; }
    .nav-logo { height: 48px; }
    .nav-title { font-weight: 800; font-size: 1.5rem; color: #1e293b; }
    .nav-right { display: flex; gap: 20px; align-items: center; }
    .nav-link { text-decoration: none; color: #475569; font-weight: 600; font-size: 0.9rem; transition: 0.2s; position: relative; }
    .nav-link:hover, .nav-link.active { color: var(--brand-blue); }
    .logout-btn { background: #fee2e2; color: #ef4444; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 700; cursor: pointer; transition: 0.2s; }

    /* HEADER FIX: No Margin Top (Lekat Nav) */
    .custom-header {
        text-align: center; 
        padding: 60px 20px 80px; 
        margin-top: 0 !important; /* FIX: Rapatkan ke Nav */
        margin-bottom: 30px; width: 100%;
        background-color: #eef2ff;
        background-image: 
            radial-gradient(at 80% 0%, hsla(189,100%,56%,0.3) 0px, transparent 50%),
            radial-gradient(at 0% 50%, hsla(355,100%,93%,1) 0px, transparent 50%);
        background-size: 200% 200%;
        animation: meshMove 15s ease-in-out infinite alternate;
        border-bottom-left-radius: 60px; border-bottom-right-radius: 60px;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.05); position: relative; z-index: 1;
    }
    .custom-header h1 { font-size: 1.8rem; margin: 0 0 10px 0; font-weight: 800; color: #1e293b; letter-spacing: -0.5px; }
    .custom-header p { font-size: 1rem; color: #475569; margin: 0; font-weight: 600; }
    @keyframes meshMove { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

    /* PANEL */
    .main { display: flex; justify-content: center; padding: 0 20px; position: relative; z-index: 2; }
    .panel {
        background: var(--bg-card); border: 1px solid var(--border-light); border-radius: 20px;
        padding: 35px; box-shadow: var(--shadow-md); width: 100%; max-width: 900px; transition: transform 0.3s;
    }

    /* INPUTS */
    .dropdown-wrapper { margin-bottom: 20px; }
    label { font-weight: 600; font-size: 0.9rem; color: var(--text-secondary); display: block; margin-bottom: 6px; }
    select, input[type="text"], input[type="number"] {
        width: 100%; padding: 14px; border: 1px solid var(--border-light); border-radius: 10px;
        font-size: 0.95rem; font-family: 'Inter', sans-serif; background: #f8fafc; color: var(--text-primary); outline: none; transition: 0.2s;
    }
    select:focus, input:focus { border-color: var(--brand-blue); background: #fff; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
    .row { display: flex; gap: 20px; margin-bottom: 15px; }
    .col { flex: 1; }

    /* BUTTONS */
    .btn { width: 100%; padding: 15px; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; background: var(--brand-blue); color: white; margin-top: 15px; font-size: 1rem; transition: 0.2s; box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2); }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 15px rgba(79, 70, 229, 0.3); }
    .btn.secondary { background: white; color: var(--text-secondary); border: 2px solid var(--border-light); box-shadow: none; }
    .btn.print { background: var(--brand-green); color: white; margin-top: 0; box-shadow: 0 4px 6px rgba(16, 185, 129, 0.2); }
    .action-buttons { display: flex; gap: 10px; margin-top: 15px; }

    /* NAV PILL */
    .navwrap { display: flex; justify-content: center; margin-bottom: 25px; position: relative; z-index: 2; }
    .nav { display: flex; gap: 15px; background: rgba(255,255,255,0.6); padding: 5px; border-radius: 50px; backdrop-filter: blur(10px); box-shadow: var(--shadow-sm); }
    .nav a { text-decoration: none; }
    .circle { padding: 10px 30px; border-radius: 30px; font-weight: 700; font-size: 0.9rem; transition: 0.3s; }
    .circle.active { background: var(--brand-blue); color: white; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3); }
    .circle.inactive { color: var(--text-secondary); }

    /* RESULT SECTION */
    /* RESULT SECTION */
/* UPDATE: Saya dah buang 'display: none' di hujung baris ini */
.result-box { 
    background: #fff; 
    border: 1px solid var(--border-light); 
    padding: 0; 
    border-radius: 16px; 
    margin-top: 30px; 
    overflow: hidden; 
    box-shadow: var(--shadow-sm); 
    /* display: none; <--- BUANG ATAU PADAM INI */
}
    .result-header { background: #f1f5f9; padding: 15px 25px; border-bottom: 1px solid var(--border-light); color: #0f172a; font-weight: 700; font-size: 1.1rem; }
    .result-content { padding: 25px; }
    
    .detail-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #e2e8f0; font-size: 0.9rem; color: #334155; }
    .detail-row:last-child { border-bottom: none; }
    .detail-row span:last-child { font-weight: 600; color: #0f172a; }
    
    .grand-total-box { margin-top: 20px; background: #f0fdf4; border: 1px solid #bbf7d0; padding: 20px; border-radius: 12px; text-align: center; }
    .grand-total-label { color: #166534; font-size: 0.9rem; font-weight: 600; text-transform: uppercase; margin-bottom: 5px; }
    .grand-total-amount { color: #15803d; font-size: 2rem; font-weight: 800; }

    .warning-box { margin-top: 20px; background: #fffbeb; border: 1px solid #fcd34d; color: #92400e; padding: 12px; border-radius: 8px; font-size: 0.85rem; line-height: 1.5; display: flex; gap: 10px; align-items: flex-start; }
    .warning-icon { font-size: 1.2rem; }

    /* TOOLS */
    .petunjuk-btn, #goTopBtn { position: fixed; width: 50px; height: 50px; border-radius: 50%; border: none; cursor: pointer; box-shadow: var(--shadow-md); z-index: 99; font-weight: bold; transition: 0.2s; color: white; }
    .petunjuk-btn { bottom: 30px; left: 30px; background: var(--brand-blue); font-size: 24px; }
    #goTopBtn { bottom: 30px; right: 30px; background: var(--text-primary); font-size: 20px; display: none; }
    #goTopBtn:hover { background: var(--brand-blue); transform: translateY(-3px); }

/* Hover: tukar shape + keluarkan perkataan */
.petunjuk-btn:hover {
    width: 140px;
    border-radius: 40px;
    background: #1e293b;
    color: #ffffff;
}

/* Tukar simbol kepada perkataan */
.petunjuk-btn:hover::after {
    content: "PETUNJUK";
    font-size: 16px;
    font-weight: bold;
}

/* Hilangkan simbol bila hover */
.petunjuk-btn:hover {
    font-size: 0;
}
    
.petunjuk-popup {
    /* State asal (Tersembunyi) */
    position: fixed; 
    bottom: 90px; 
    left: 30px; 
    background: white; 
    padding: 20px; 
    border-radius: 16px; 
    box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
    z-index: 100; 
    border: 1px solid var(--border-light); 
    width: 300px;
    
    /* Animasi Properties */
    opacity: 0;
    visibility: hidden;
    transform: translateY(20px); /* Mula dari bawah sikit */
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Class bila popup aktif (Muncul) */
.petunjuk-popup.active {
    opacity: 1;
    visibility: visible;
    transform: translateY(0); /* Naik ke posisi asal */
}

.petunjuk-popup table { width: 100%; font-size: 0.85rem; }
.petunjuk-popup td { padding: 6px 0; border-bottom: 1px solid #f1f5f9; }

/* Menu Desktop */
.nav-right { display: flex; gap: 20px; align-items: center; }
.nav-link { text-decoration: none; color: #475569; font-weight: 600; font-size: 0.9rem; transition: 0.2s; }
.nav-link:hover, .nav-link.active { color: var(--brand-blue); }
.logout-btn { background: #fee2e2; color: #ef4444; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 700; cursor: pointer; }

/* Burger Default Hidden */
.hamburger { display: none; cursor: pointer; flex-direction: column; gap: 5px; z-index: 50; }
.hamburger span { width: 25px; height: 3px; background-color: #0f172a; border-radius: 2px; transition: 0.3s; }


/* --- MOBILE RESPONSIVE (Title Jadi Center Sini) --- */
@media (max-width: 768px) {
    .dashboard-nav { padding: 0 20px; } /* Kurangkan padding tepi */

    /* 1. Tunjuk Burger */
    .hamburger { display: flex; }

    /* 2. MAGIC: Title Lari ke Tengah */
    .nav-title {
        position: absolute; /* Cabut dari .nav-left */
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%); /* Center betul-betul */
        
        font-size: 0.95rem; /* Kecilkan sikit */
        width: 60%; /* Hadkan lebar supaya tak langgar logo/burger */
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        z-index: 10;
    }

    /* 3. Menu Dropdown */
    .nav-right {
        position: absolute;
        top: 70px;
        left: 0;
        width: 100%;
        background: white;
        border-bottom: 1px solid #e2e8f0;
        box-shadow: 0 10px 15px rgba(0,0,0,0.05);
        
        display: flex; flex-direction: column; align-items: center;
        max-height: 0; opacity: 0; overflow: hidden;
        transition: all 0.4s ease-in-out;
        padding: 0; gap: 0;
    }

    .nav-right.active {
        max-height: 400px;
        opacity: 1;
        padding: 20px 0;
        gap: 15px;
    }

    .nav-link { width: 100%; padding: 12px; display: block; text-align: center; }
    
    /* Burger Animation */
    .nav-right.active ~ .hamburger span:nth-child(1) { transform: rotate(45deg) translate(5px, 5px); }
    .nav-right.active ~ .hamburger span:nth-child(2) { opacity: 0; }
    .nav-right.active ~ .hamburger span:nth-child(3) { transform: rotate(-45deg) translate(5px, -5px); }
}
/* === TOOLTIP STYLES (Tambah ini) === */

/* Pastikan elemen induk ada position relative */
.nav-link, .logout-btn {
    position: relative;
}

/* Kotak Teks Tooltip */
[data-tooltip]:hover::after {
    content: attr(data-tooltip);
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    margin-top: 10px;
    padding: 6px 10px;
    background-color: #1e293b; /* Warna latar gelap */
    color: #fff;
    font-size: 0.75rem;
    font-weight: 500;
    border-radius: 6px;
    white-space: nowrap;
    opacity: 0;
    animation: tooltipFade 0.3s forwards;
    pointer-events: none;
    z-index: 200;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

/* Anak Panah Kecil (Segitiga) di atas tooltip */
[data-tooltip]:hover::before {
    content: '';
    position: absolute;
    top: 100%; 
    left: 50%;
    transform: translateX(-50%);
    margin-top: 5px;
    border-width: 5px;
    border-style: solid;
    border-color: transparent transparent #1e293b transparent; /* Warna sama dengan background tooltip */
    opacity: 0;
    animation: tooltipFade 0.3s forwards;
    pointer-events: none;
}

/* Animasi Muncul */
@keyframes tooltipFade { 
    to { opacity: 1; margin-top: 10px; } 
}

/* Sembunyikan tooltip pada Mobile supaya tak semak */
@media (max-width: 768px) {
    [data-tooltip]:hover::after, [data-tooltip]:hover::before { display: none; }
}
</style>
</head>
<body data-kiraan="awam">

    <div class="animated-bg"></div>

    <nav class="dashboard-nav">
        <div class="nav-left">
            <img src="image/HASA.png" class="nav-logo" alt="Logo">
            <span class="nav-title">SISTEM KIRAAN GAJI</span>
        </div>
        <div class="hamburger" id="hamburgerBtn"><span></span><span></span><span></span></div>
    <div class="nav-right" id="navMenu">
        <a href="dashboard.html" class="nav-link" data-tooltip="Paparan Utama">Dashboard</a>
        <a href="contohawam.html" class="nav-link active" data-tooltip="Kiraan Sektor Kerajaan">Kiraan Awam</a>
        <a href="swasta.html" class="nav-link" data-tooltip="Kiraan Sektor Korporat">Kiraan Swasta</a>
        <button id="logoutBtn" class="logout-btn" data-tooltip="Keluar Sistem">Logout</button>
    </div>
</nav>

    <header class="custom-header">
        <h1>KIRAAN GAJI SEKTOR AWAM</h1> 
        <p>Kerajaan / Badan Berkanun / PBT</p>
    </header>

    <div class="navwrap">
        <div class="nav">
            <a href="contohawam.html" class="transition-link"><div class="circle active">AWAM</div></a>
            <a href="swasta.html" class="transition-link"><div class="circle inactive">SWASTA</div></a>
        </div>
    </div>

    <div class="main">
        <div class="panel">
            <div class="info-box" style="background:#eff6ff; border-left:4px solid var(--brand-blue); padding:15px; border-radius:8px; margin-bottom:20px; color:#1e3a8a;">
                <strong>Panduan:</strong> Pilih Jawatan dan Wilayah. KGT Tambahan boleh dimasukkan secara manual. Tekan butang KIRA untuk lihat perincian.
            </div>
            
            <div id="loadingMsg" style="color: red; text-align: center; font-weight: bold; display: none;"></div>

            <div class="dropdown-wrapper">
                <label>Pilih Jawatan Awam</label>
                <select id="jawatan_awam">
                    <option value="" disabled selected>Sedang memuatkan data dari Firebase...</option>
                </select>
            </div>

            <div class="row">
                <div class="col">
                    <label>Wilayah Asal</label>
                    <select id="wilayah_awam" disabled>
                        <option value="" disabled selected>-- Pilih --</option>
                        <option value="Semenanjung">Semenanjung</option>
                        <option value="Sabah">Sabah</option>
                        <option value="Sarawak">Sarawak</option>
                        <option value="Labuan">Labuan</option>
                    </select>
                </div>
                <div class="col">
                    <label>Kategori</label>
                    <input type="text" id="kategoriJawatan" readonly style="background:#f1f5f9; color:#64748b;">
                </div>
            </div>

            <div class="row">
                <div class="col"><label>Gaji Pokok (RM)</label><input type="number" id="awamGajiPokok"></div>
                <div class="col"><label>Jawatan</label><input type="text" id="awamJawatan" readonly></div>
            </div>

            <div style="margin-top:25px; border-bottom:1px solid #e2e8f0; margin-bottom:15px; padding-bottom:5px; font-weight:700; color:#475569;">
                PERINCIAN ELAUN
            </div>
            
            <div class="row">
                <div class="col"><label>ITKA</label><input type="number" id="elaun_itka_awam" readonly></div>
                <div class="col"><label>ITK</label><input type="number" id="elaun_itk_awam" readonly></div>
                <div class="col"><label>ITP</label><input type="number" id="elaun_itp_awam" readonly></div> 
            </div>    
            <div class="row">
                <div class="col"><label>BISH(Semenanjung)</label><input type="number" id="elaun_bish_awam" readonly></div>
                <div class="col"><label>BIW(Sabah/Serawak/Labuan)</label><input type="number" id="elaun_biw_awam" readonly></div>
            </div>
            <div class="row">
                <div class="col"><label>BIPK</label><input type="number" id="elaun_bipk_awam" readonly></div>
                <div class="col"><label>BIP</label><input type="number" id="elaun_bip_awam" readonly></div>
            </div>

            <div class="row">
                <div class="col"><label>KGT Tahun Ini</label><input type="number" id="kgt_tahun_ini" readonly></div>
                <div class="col"><label>KGT Tambahan (Manual)</label><input type="number" id="kgt_tambahan" placeholder="0.00" style="background:#fff; cursor:text;"></div>
            </div>

            <div class="row">
                <div class="col">
                    <label>Dapat PGT Tahun Ini?</label>
                    <select id="awamTelah"><option value="YA">YA</option><option value="TIDAK" selected>TIDAK</option></select>
                </div>
                <div class="col">
                    <label>Bulan PGT</label>
                    <select id="awamPGT">
                        <option value="Jan">Januari</option>
                        <option value="Apr">April</option>
                        <option value="Jul">Julai</option>
                        <option value="Oct">Oktober</option>
                    </select>
                </div>
            </div>

            <button class="btn" type="button" onclick="computeAwam()">KIRA GAJI AWAM</button>

            <div id="resultContent" style="display:none;">
                <div class="result-box">
                    <div class="result-header">Perincian Kiraan Gaji</div>
                    <div class="result-content">
                        <div class="detail-row"><span>Jawatan</span><span id="d-jawatan">-</span></div>
                        <div class="detail-row"><span>Wilayah</span><span id="d-wilayah">-</span></div>
                        <div class="detail-row"><span>Kategori</span><span id="d-kategori">-</span></div>
                        <div class="detail-row"><span>Gaji Pokok</span><span id="d-gaji">-</span></div>
                        
                        <div class="detail-row"><span>Bulan PGT</span><span id="d-bulan-pgt">-</span></div>

                        <br>
                        <div style="font-weight:700; color:#475569; font-size:0.85rem; margin-bottom:5px;">ELAUN & INSENTIF</div>
                        <div class="detail-row"><span>ITKA</span><span id="d-itka">0.00</span></div>
                        <div class="detail-row"><span>ITK</span><span id="d-itk">0.00</span></div>
                        <div class="detail-row"><span>ITP</span><span id="d-itp">0.00</span></div>
                        <div class="detail-row"><span>BISH(Semenanjung)</span><span id="d-bish">0.00</span></div>
                        <div class="detail-row"><span>BIW(Sabah/Serawak/Labuan)</span><span id="d-biw">0.00</span></div>
                        <div class="detail-row"><span>BIPK</span><span id="d-bipk">0.00</span></div>
                        <div class="detail-row"><span>BIP</span><span id="d-bip">0.00</span></div>

                        <br>
                        <div style="font-weight:700; color:#475569; font-size:0.85rem; margin-bottom:5px;">KENAIKAN TAHUNAN</div>
                        <div class="detail-row"><span>KGT Tahun Ini</span><span id="d-kgt">0.00</span></div>
                        <div class="detail-row"><span>KGT Tambahan</span><span id="d-kgt-add">0.00</span></div>

                        <div class="grand-total-box">
                            <div class="grand-total-label">JUMLAH PENDAPATAN KASAR</div>
                            <div class="grand-total-amount" id="d-grand-total">RM 0.00</div>
                        </div>

                        <div class="warning-box">
                            <span class="warning-icon">⚠️</span>
                            <span><strong>PERHATIAN:</strong> Jumlah yang dipaparkan adalah anggaran simulasi sahaja berdasarkan data yang dimasukkan. Sila rujuk slip gaji rasmi jabatan untuk pengesahan muktamad.</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn secondary" onclick="resetForm()">RESET</button>
                <button class="btn print" id="printBtn" onclick="printResult()" style="display:none;">CETAK SLIP</button>
            </div>
        </div>
    </div>

    <button id="petunjukBtn" class="petunjuk-btn">?</button>
    <button id="goTopBtn" title="Go to Top">↑</button>

    <div id="petunjukPopup" class="petunjuk-popup">
        <h4 style="color:var(--brand-blue); margin-top:0;">PETUNJUK ELAUN</h4>
        <table>
            <tr><td><strong>ITKA</strong></td><td>Imbuhan Tetap Khidmat Awam</td></tr>
            <tr><td><strong>ITK</strong></td><td>Imbuhan Tetap Keraian</td></tr>
            <tr><td><strong>ITP</strong></td><td>Imbuhan Tetap Perumahan</td></tr>
            <tr><td><strong>BISH</strong></td><td>Bantuan Sara Hidup</td></tr>
            <tr><td><strong>BIW</strong></td><td>Bayaran Insentif Wilayah</td></tr>
        </table>
    </div>

<script>
    // ===========================================
    // 1. CONFIG FIREBASE
    // ===========================================
    const firebaseConfig = {
        apiKey: "AIzaSyDcCimpduiHdGyEmWHivg2tz_GkEgbnxf8",
        authDomain: "data-staff-6hha55.firebaseapp.com",
        projectId: "data-staff-6hha55",
        storageBucket: "data-staff-6hha55.firebasestorage.app",
        messagingSenderId: "834544418876",
        appId: "1:834544418876:web:71b355bd0f3faf73244339",
        measurementId: "G-1VE4LRETY9"
    };

    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
        console.log("Firebase Ready.");
    }

    // ===========================================
    // 2. LOGIC JAVASCRIPT UTAMA
    // ===========================================

    const db = firebase.firestore();
    let selectedJawatanData = null;
    let lastCalculationData = null; 

    const els = {
        jawatan: document.getElementById('jawatan_awam'),
        wilayah: document.getElementById('wilayah_awam'),
        kategori: document.getElementById('kategoriJawatan'),
        gajiPokok: document.getElementById('awamGajiPokok'),
        jawatanText: document.getElementById('awamJawatan'),
        itka: document.getElementById('elaun_itka_awam'),
        itk: document.getElementById('elaun_itk_awam'),
        itp: document.getElementById('elaun_itp_awam'),
        bish: document.getElementById('elaun_bish_awam'),
        biw: document.getElementById('elaun_biw_awam'),
        bipk: document.getElementById('elaun_bipk_awam'),
        bip: document.getElementById('elaun_bip_awam'),
        kgt: document.getElementById('kgt_tahun_ini'),
        kgtAdd: document.getElementById('kgt_tambahan'),
        statusPgt: document.getElementById('awamTelah'),
        pgtDropdown: document.getElementById('awamPGT'), 
        resultArea: document.getElementById('resultContent'),
        printBtn: document.getElementById('printBtn'),
        loadingMsg: document.getElementById('loadingMsg')
    };

    // --- FETCH DATA (YANG DAH DIKEMASKINI DENGAN SORTING) ---
    db.collection('senarai_jawatan').onSnapshot((snapshot) => {
        if(snapshot.empty) {
            els.jawatan.innerHTML = '<option>Tiada Data</option>';
            return;
        }
        els.jawatan.innerHTML = '<option value="" selected>-- Sila Pilih --</option>';

        let senaraiSementara = [];
        snapshot.forEach((doc) => {
            senaraiSementara.push(doc.data());
        });

        // Susun Data (ID Susunan)
        senaraiSementara.sort((a, b) => {
            let idA = a.id_susunan || 0; 
            let idB = b.id_susunan || 0;
            return idA - idB;
        });

        senaraiSementara.forEach((data) => {
            const option = document.createElement('option');
            option.value = JSON.stringify(data);
            let nama = data.nama_jawatan || data.Nama_Jawatan || data.Jawatan || data.name || "Tiada Nama";
            option.text = nama;
            els.jawatan.appendChild(option);
        });
    });

    // --- PILIH JAWATAN ---
    els.jawatan.addEventListener('change', function() {
        if(this.value) {
            try {
                const d = JSON.parse(this.value);
                selectedJawatanData = d;
                
                els.wilayah.disabled = false;
                els.wilayah.value = ""; 

                els.jawatanText.value = d.nama_jawatan || d.Nama_Jawatan || d.Jawatan || "";
                els.kategori.value = d.kategori || d.Kategori || "";
                els.gajiPokok.value = parseFloat(d.gaji_pokok || d.Gaji_Pokok || d.gaji || 0);
                
                els.itka.value = parseFloat(d.itka || d.ITKA || 0);
                els.itk.value = parseFloat(d.itk || d.ITK || 0);
                els.itp.value = parseFloat(d.itp || d.ITP || 0);
                els.bipk.value = parseFloat(d.bipk || d.BIPK || 0);
                els.bip.value = parseFloat(d.bip || d.BIP || 0);
                
                els.kgtAdd.value = 0;
                els.bish.value = 0; els.biw.value = 0; els.kgt.value = 0;
                
                els.resultArea.style.display = 'none';
                els.printBtn.style.display = 'none';
            } catch(e) { console.error(e); }
        }
    });

    // --- PILIH WILAYAH ---
    els.wilayah.addEventListener('change', function() {
        if(!selectedJawatanData) return;
        const w = this.value;
        const d = selectedJawatanData;
        if (w === 'Semenanjung') {
            els.bish.value = parseFloat(d.bish || d.BISH || 0);
            els.biw.value = 0;
        } else {
            els.bish.value = 0;
            els.biw.value = parseFloat(d.biw || d.BIW || 0);
        }
    });

    // --- KIRAAN UTAMA ---
    window.computeAwam = function() {
        console.log("Mengira..."); 

        var elGaji = document.getElementById('awamGajiPokok');
        var elStatusPGT = document.getElementById('awamTelah'); 
        var elPGT = document.getElementById('awamPGT'); 
        var elJawatan = document.getElementById('awamJawatan');
        var elWilayah = document.getElementById('wilayah_awam');
        var elKategori = document.getElementById('kategoriJawatan');
        
        if (!elGaji) { alert("Input Gaji Pokok tiada!"); return; }

        var kgtVal = 0;
        if (typeof selectedJawatanData !== 'undefined' && selectedJawatanData) {
            var status = elStatusPGT ? elStatusPGT.value : "TIDAK"; 
            if (status === 'TIDAK') {
                kgtVal = parseFloat(selectedJawatanData.nilai_kgt || selectedJawatanData.Nilai_KGT || selectedJawatanData.KGT || selectedJawatanData.kgt || 0);
            } else {
                kgtVal = 0;
            }
        }
        
        var elKgtInput = document.getElementById('kgt_tahun_ini');
        if(elKgtInput) elKgtInput.value = kgtVal.toFixed(2);

        var gaji = parseFloat(elGaji.value) || 0;
        var kgtAdd = parseFloat(document.getElementById('kgt_tambahan').value) || 0;
        
        var itka = parseFloat(document.getElementById('elaun_itka_awam').value) || 0;
        var itk  = parseFloat(document.getElementById('elaun_itk_awam').value) || 0;
        var itp  = parseFloat(document.getElementById('elaun_itp_awam').value) || 0;
        var bish = parseFloat(document.getElementById('elaun_bish_awam').value) || 0;
        var biw  = parseFloat(document.getElementById('elaun_biw_awam').value) || 0;
        var bipk = parseFloat(document.getElementById('elaun_bipk_awam').value) || 0;
        var bip  = parseFloat(document.getElementById('elaun_bip_awam').value) || 0;

        var totalElaun = itka + itk + itp + bish + biw + bipk + bip;
        var grandTotal = gaji + kgtVal + kgtAdd + totalElaun;
        
        var txtJawatan = elJawatan ? elJawatan.value : "-";
        var txtWilayah = elWilayah ? elWilayah.value : "-";
        var txtKategori = elKategori ? elKategori.value : "-";
        var txtPGT = (elPGT && elPGT.options.length > 0) ? elPGT.options[elPGT.selectedIndex].text : "-";

        document.getElementById('d-jawatan').innerText = txtJawatan;
        document.getElementById('d-wilayah').innerText = txtWilayah;
        document.getElementById('d-kategori').innerText = txtKategori;
        document.getElementById('d-bulan-pgt').innerText = txtPGT;
        
        document.getElementById('d-gaji').innerText = gaji.toFixed(2);
        document.getElementById('d-kgt').innerText = kgtVal.toFixed(2);
        document.getElementById('d-kgt-add').innerText = kgtAdd.toFixed(2);
        
        document.getElementById('d-itka').innerText = itka.toFixed(2);
        document.getElementById('d-itk').innerText = itk.toFixed(2);
        document.getElementById('d-itp').innerText = itp.toFixed(2);
        document.getElementById('d-bish').innerText = bish.toFixed(2);
        document.getElementById('d-biw').innerText = biw.toFixed(2);
        document.getElementById('d-bipk').innerText = bipk.toFixed(2);
        document.getElementById('d-bip').innerText = bip.toFixed(2);
        
        document.getElementById('d-grand-total').innerText = "RM " + grandTotal.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');

        lastCalculationData = {
            jenis_kiraan: "Awam",
            jawatan: txtJawatan,
            wilayah: txtWilayah,
            kategori: txtKategori,
            bulanPGT: txtPGT,
            gajiPokok: gaji,
            elaunList: { itka, itk, itp, bish, biw, bipk, bip },
            kgt: kgtVal,
            kgtTambahan: kgtAdd,
            jumlahKasar: grandTotal,
            tarikh: new Date().toLocaleString()
        };

        var resultDiv = document.getElementById('resultContent');
        resultDiv.style.display = 'block'; 
        document.getElementById('printBtn').style.display = 'inline-block';
        resultDiv.scrollIntoView({ behavior: 'smooth' });

        if(typeof saveToFirebase === 'function') {
            saveToFirebase(lastCalculationData);
        }
    };

    // --- PRINT FUNCTION ---
    window.printResult = function() {
        if(!lastCalculationData) return;
        const d = lastCalculationData;
        const w = window.open('', '', 'width=800,height=800');
        w.document.write(`
            <html><head><title>Slip Gaji Simulasi</title>
            <style>
                body { font-family: sans-serif; padding: 40px; color:#000; position: relative; }
                .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
                .header h2 { margin: 0; text-transform: uppercase; }
                .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9rem; position: relative; z-index: 1; }
                th, td { border: 1px solid #000; padding: 8px; text-align: left; background: transparent; }
                th { background: #eee; }
                .right { text-align: right; }
                .total-row td { font-weight: bold; background: #eee; font-size: 1.1rem; }
                .warning { margin-top: 30px; border: 1px dashed #000; padding: 15px; font-size: 0.8rem; text-align: center; position: relative; z-index: 1; background: white; }
                .watermark {
                    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg);
                    font-size: 5rem; color: rgba(0, 0, 0, 0.1); border: 5px solid rgba(0, 0, 0, 0.1);
                    padding: 20px; z-index: 0; pointer-events: none; font-weight: bold; text-transform: uppercase; white-space: nowrap;
                }
            </style>
            </head><body>
                <div class="watermark">RUJUKAN SAHAJA</div>
                <div class="header"><h2>HASA UiTM</h2><p>Simulasi Kiraan Gaji Sektor Awam</p></div>
                <div class="info-grid">
                    <div><strong>Jawatan:</strong> ${d.jawatan}</div><div><strong>Tarikh:</strong> ${d.tarikh}</div>
                    <div><strong>Kategori:</strong> ${d.kategori}</div><div><strong>Wilayah:</strong> ${d.wilayah}</div>
                    <div><strong>Bulan PGT:</strong> ${d.bulanPGT}</div>
                </div>
                <table>
                    <tr><th>Perkara</th><th class="right">Amaun (RM)</th></tr>
                    <tr><td>Gaji Pokok</td><td class="right">${fmt(d.gajiPokok)}</td></tr>
                    <tr><td>ITKA</td><td class="right">${fmt(d.elaunList.itka)}</td></tr>
                    <tr><td>ITK</td><td class="right">${fmt(d.elaunList.itk)}</td></tr>
                    <tr><td>ITP</td><td class="right">${fmt(d.elaunList.itp)}</td></tr>
                    <tr><td>BISH (Semenanjung)</td><td class="right">${fmt(d.elaunList.bish)}</td></tr>
                    <tr><td>BIW (S/S/L)</td><td class="right">${fmt(d.elaunList.biw)}</td></tr>
                    <tr><td>BIPK</td><td class="right">${fmt(d.elaunList.bipk)}</td></tr>
                    <tr><td>BIP</td><td class="right">${fmt(d.elaunList.bip)}</td></tr>
                    <tr><td>KGT Tahun Ini</td><td class="right">${fmt(d.kgt)}</td></tr>
                    <tr><td>KGT Tambahan (Manual)</td><td class="right">${fmt(d.kgtTambahan)}</td></tr>
                    <tr class="total-row"><td>JUMLAH PENDAPATAN KASAR</td><td class="right">RM ${fmt(d.jumlahKasar)}</td></tr>
                </table>
                <div class="warning"><strong>PERHATIAN:</strong> Jumlah yang dipaparkan adalah anggaran simulasi sahaja. Sila rujuk slip gaji rasmi jabatan.</div>
                <script>window.print();<\/script>
            </body></html>
        `);
        w.document.close();
    };

    function saveToFirebase(data) {
        const user = firebase.auth().currentUser;
        const uid = user ? user.uid : "anonymous";
        db.collection('printedSlips').add({
            userId: uid,
            ...data,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => console.log("Data saved!")).catch(e => console.error("Save failed", e));
    }

    function fmt(n) { return parseFloat(n).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'); }

    window.resetForm = function() {
        window.scrollTo(0, 0); 
        setTimeout(() => location.reload(), 100); 
    };

    /* =========================================
       3. UI & EVENT LISTENERS
       ========================================= */
    
    // Force Scroll Top on Refresh
    if (history.scrollRestoration) { history.scrollRestoration = 'manual'; }
    window.scrollTo(0, 0);

    document.addEventListener("DOMContentLoaded", () => {
        // Fade Up Animation (Added Timeout for smooth start)
        setTimeout(() => document.body.classList.add("loaded"), 50);

        // 1. Hamburger Menu
        const navBtn = document.getElementById('hamburgerBtn');
        const navMenu = document.getElementById('navMenu');
        if(navBtn) navBtn.onclick = () => navMenu.classList.toggle('active');

        // 2. Petunjuk Popup (Smooth Toggle)
        const pBtn = document.getElementById('petunjukBtn');
        const pPop = document.getElementById('petunjukPopup');
        
        if(pBtn && pPop) {
            pPop.style.display = ''; // Reset display style

            pBtn.onclick = (e) => {
                e.stopPropagation();
                pPop.classList.toggle('active'); // Guna class active dari CSS swasta tadi
            };

            window.addEventListener('click', (e) => {
                if (pPop.classList.contains('active') && !pPop.contains(e.target) && e.target !== pBtn) {
                    pPop.classList.remove('active');
                }
            });
            
            const closeBtn = pPop.querySelector('button');
            if(closeBtn) {
                closeBtn.onclick = (e) => {
                    e.stopPropagation();
                    pPop.classList.remove('active');
                }
            }
        }

        // 3. Navbar Scroll & GoTop Logic
        const navbar = document.querySelector('.dashboard-nav');
        const goTop = document.getElementById('goTopBtn');
        let lastScrollTop = 0;

        window.addEventListener('scroll', () => {
            let scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            if(scrollTop < 0) return;

            // Navbar Hide/Show
            if (scrollTop > lastScrollTop && scrollTop > 50) {
                navbar.classList.add('nav-hidden');
            } else {
                navbar.classList.remove('nav-hidden');
            }
            lastScrollTop = scrollTop;

            // Go Top Show/Hide
            if (goTop) {
                goTop.style.display = scrollTop > 300 ? "block" : "none";
            }
        });

        if(goTop) goTop.onclick = () => window.scrollTo({top: 0, behavior: 'smooth'});

        // 4. Logout Logic (With Reverse Fade Up)
        document.getElementById('logoutBtn')?.addEventListener('click', async () => {
            const notif = document.createElement('div');
            notif.textContent = 'Sedang Log Keluar...';
            notif.style.cssText = "position:fixed; top:20px; left:50%; transform:translateX(-50%); background-color: var(--brand-blue); color:white; padding:12px 24px; border-radius:30px; font-weight:600; box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index:9999; opacity:0; transition:all 0.3s ease;";
            document.body.appendChild(notif);
            
            // Fade Out Effect
            document.body.classList.remove("loaded");

            setTimeout(() => { notif.style.opacity = 1; notif.style.top = '30px'; }, 10);
            setTimeout(async () => {
                await firebase.auth().signOut();
                location.href = 'login.html';
            }, 1200);
        });

        // 5. Page Transition (Links - Reverse Fade Up)
        document.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', (e) => {
                const targetUrl = link.getAttribute('href');
                if (targetUrl && targetUrl !== '#' && !targetUrl.startsWith('javascript')) {
                    e.preventDefault();
                    document.body.classList.remove("loaded"); // Turunkan opacity & gerak ke bawah
                    setTimeout(() => window.location.href = targetUrl, 600); // 600ms match CSS
                }
            });
        });
    });
</script>
</body>
</html>


