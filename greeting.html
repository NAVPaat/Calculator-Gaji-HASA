<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Greeting â€” Calculator Gaji HASA UiTM</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="firebase-config.js"></script>
<script src="auth.js"></script>

<style>
/* ===== CORE RESET ===== */
html, body {
  margin:0; padding:0;
  width:100%; height:100%;
  font-family:'Inter', sans-serif;
  overflow:hidden;
  display:flex; justify-content:center; align-items:center;
  background:#000;
}

/* ===== BACKGROUND CANVAS (DO NOT TOUCH) ===== */
#particleCanvas{
  position:absolute;
  top:0; left:0;
  width:100%; height:100%;
  z-index:0;
  pointer-events:none;
}

/* ===== ADVANCED GREETING CARD ===== */
#greetingContainer {
  position: relative;
  z-index: 1;
  text-align: center;
  padding: 40px 50px;
  border-radius: 24px;
  
  /* Glassmorphism Effect */
  background: rgba(25, 25, 25, 0.4); /* Darker elegant glass */
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  box-shadow: 0 20px 50px rgba(0,0,0,0.5);
  
  max-width: 500px;
  width: 90%;
  
  opacity: 0;
  transform: translateY(30px) scale(0.95);
  transition: opacity 0.8s cubic-bezier(0.2, 0.8, 0.2, 1), transform 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
  
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

#greetingContainer.show {
  opacity: 1;
  transform: translateY(0) scale(1);
}

/* Greeting Subtitle (Selamat Pagi) */
.greet-label {
  font-family: 'Inter', sans-serif;
  font-size: 1rem;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: rgba(255, 255, 255, 0.7);
  margin-bottom: 10px;
  font-weight: 500;
}

/* User Name (Main Text) */
.greet-name {
  font-family: 'Poppins', sans-serif;
  font-size: 2.5rem; /* Besar */
  font-weight: 700;
  color: #fff;
  line-height: 1.2;
  min-height: 60px; /* Reserve space */
  text-shadow: 0 0 20px rgba(255,255,255,0.3);
  margin-bottom: 25px;
}

/* Gradient Text Effect for Name (Optional) */
.highlight-text {
  background: linear-gradient(135deg, #fff 0%, #d1d5db 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

/* Loading Line */
.loader-wrapper {
  width: 100px;
  height: 4px;
  background: rgba(255,255,255,0.1);
  border-radius: 4px;
  overflow: hidden;
  position: relative;
  margin-top: 10px;
}

.loader-bar {
  width: 0%;
  height: 100%;
  background: linear-gradient(90deg, #FF6B6B, #5E2A84);
  border-radius: 4px;
  transition: width 2.5s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Blinking Cursor */
.cursor {
  display: inline-block;
  width: 3px;
  height: 1em; /* Ikut saiz font */
  background: #FF6B6B;
  vertical-align: middle;
  margin-left: 5px;
  animation: blink 0.8s infinite;
}

@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0; }
}

/* Exit Animation */
.fade-out {
  animation: warpSpeed 1.5s forwards cubic-bezier(0.7, 0, 0.84, 0);
}

@keyframes warpSpeed {
  0% { opacity: 1; transform: scale(1); filter: blur(0px); }
  50% { opacity: 0.8; transform: scale(1.1); filter: blur(2px); }
  100% { opacity: 0; transform: scale(2.5); filter: blur(20px); }
}

/* Mobile Adjustments */
@media (max-width: 480px) {
  #greetingContainer { padding: 30px 20px; }
  .greet-name { font-size: 1.8rem; }
}
</style>
</head>
<body>

<canvas id="particleCanvas"></canvas>

<div id="greetingContainer">
  <div class="greet-label" id="timeGreeting">SELAMAT DATANG</div>
  
  <div class="greet-name">
    <span id="typedName"></span><span class="cursor"></span>
  </div>

  <div class="loader-wrapper">
    <div class="loader-bar" id="progressLine"></div>
  </div>
</div>

<script>
// ===== 1. BACKGROUND CANVAS LOGIC (UNCHANGED) =====
const canvas = document.getElementById('particleCanvas');
const ctx = canvas.getContext('2d');
let W = canvas.width = window.innerWidth;
let H = canvas.height = window.innerHeight;

window.addEventListener('resize', ()=>{
  W = canvas.width = window.innerWidth;
  H = canvas.height = window.innerHeight;
});

const colors = ['#8e2de2','#4a00e0','#00c6ff','#7de2d1','#f7971e','#ff3cac','#ffffff','#bbbbbb'];
const starLayers = [
  {count:120, speed:0.2, size:1.2},
  {count:100, speed:0.5, size:1.8},
  {count:80, speed:0.9, size:2.4},
];
const stars = [];
for(let l of starLayers){
  for(let i=0;i<l.count;i++){
    stars.push({
      x:Math.random()*W, y:Math.random()*H, z:Math.random()*W,
      size:l.size, color: colors[Math.floor(Math.random()*colors.length)],
      speed:l.speed, alpha: Math.random()*0.7+0.3, blink: Math.random()*0.05+0.02
    });
  }
}

const nebulaLayers = [
  {x:W*0.25, y:H*0.3, r:W*0.5, color:'rgba(255,255,255,0.02)', dx:0.02, dy:0.01},
  {x:W*0.7, y:H*0.5, r:W*0.4, color:'rgba(255,255,255,0.015)', dx:-0.01, dy:0.015},
  {x:W*0.5, y:H*0.7, r:W*0.3, color:'rgba(255,255,255,0.01)', dx:0.015, dy:-0.01},
];

function drawBackground(){
  ctx.fillStyle='black';
  ctx.fillRect(0,0,W,H);
  for(let n of nebulaLayers){
    n.x += n.dx; n.y += n.dy;
    if(n.x-n.r>W) n.x=-n.r; if(n.x+n.r<0) n.x=W+n.r;
    if(n.y-n.r>H) n.y=-n.r; if(n.y+n.r<0) n.y=H+n.r;
    const gradient = ctx.createRadialGradient(n.x,n.y,0,n.x,n.y,n.r);
    gradient.addColorStop(0,n.color); gradient.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle = gradient; ctx.fillRect(0,0,W,H);
  }
  for(let s of stars){
    s.alpha += (Math.random()-0.5)*s.blink;
    s.alpha = Math.min(Math.max(s.alpha,0.3),1);
    const k = 128/s.z;
    const x = (s.x - W/2) * k + W/2;
    const y = (s.y - H/2) * k + H/2;
    const size = s.size * (1 - s.z/W) * 2;
    ctx.fillStyle = `rgba(${hexToRgb(s.color)},${s.alpha})`;
    ctx.fillRect(x,y,size,size);
    s.z -= s.speed;
    if(s.z<=0){
      s.z=W; s.x=Math.random()*W; s.y=Math.random()*H;
      s.color = colors[Math.floor(Math.random()*colors.length)];
    }
  }
  requestAnimationFrame(drawBackground);
}
drawBackground();
function hexToRgb(hex){
  hex=hex.replace('#','');
  let bigint = parseInt(hex,16);
  return `${(bigint >>16)&255},${(bigint >>8)&255},${bigint&255}`;
}

// ===== 2. ADVANCED TYPING & ANIMATION =====
function typeText(el, text, speed=70, callback){ 
  let i=0;
  const cursor = document.querySelector('.cursor');
  // Initial delay slightly
  setTimeout(() => {
    const interval = setInterval(()=>{
      if(i<text.length){
        el.textContent += text[i];
        i++;
      }else{
        clearInterval(interval);
        cursor.style.display='none'; // Hide cursor after finish
        if(callback) callback();
      }
    }, speed);
  }, 400);
}

// ===== 3. AUTH & FLOW LOGIC =====
onAuthChange(async user => {
    if(!user){ location.href='login.html'; return; }

    // Fetch User Name
    let fullname = user.email.split('@')[0];
    try{
        const doc = await firebase.firestore().collection('users').doc(user.uid).get();
        if(doc.exists && doc.data().fullname){
            fullname = doc.data().fullname;
        }
    }catch(e){ console.warn('Cannot fetch fullname:', e); }

    // Format Name (First Name Only for impact, or Fullname)
    // Ambil nama pertama sahaja jika terlalu panjang, atau biarkan full
    const displayName = fullname.length > 20 ? fullname.split(' ')[0] : fullname;

    // Time Logic
    const hour = new Date().getHours();
    let timeGreeting = 'SELAMAT DATANG';
    let emoji = 'ðŸ‘‹';
    if(hour>=5 && hour<12){ timeGreeting='SELAMAT PAGI'; emoji='ðŸŒž'; }
    else if(hour>=12 && hour<18){ timeGreeting='SELAMAT PETANG'; emoji='ðŸŒ‡'; }
    else{ timeGreeting='SELAMAT MALAM'; emoji='ðŸŒ™'; }

    // DOM Elements
    const labelEl = document.getElementById('timeGreeting');
    const nameEl = document.getElementById('typedName');
    const container = document.getElementById('greetingContainer');
    const progressBar = document.getElementById('progressLine');

    // Set Subtitle first
    labelEl.innerHTML = `${emoji} &nbsp; ${timeGreeting}`;

    // Start Sequence
    setTimeout(()=>{
        container.classList.add('show'); // 1. Card Pops up
        
        // 2. Start Typing Name
        typeText(nameEl, displayName, 60, () => {
             // 3. Typing Done
        });

        // 4. Start Progress Bar concurrently
        setTimeout(() => {
            progressBar.style.width = '100%';
        }, 500);

        // 5. Redirect Sequence
        setTimeout(() => {
            container.classList.add('fade-out'); // Warp speed effect
            setTimeout(() => window.location.href='dashboard.html', 1500);
        }, 2800); // Total wait time

    }, 300);
});
</script>
</body>
</html>
