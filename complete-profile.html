<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>Lengkapkan Profil â€” HASA UiTM</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="firebase-config.js"></script>
    <style>
        /* (Style yang sama macam sebelum ni, saya pendekkan untuk fokus pada script) */
        body { font-family: 'Inter', sans-serif; padding: 20px; display: flex; justify-content: center; }
        .card { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
        .input-group { margin-bottom: 15px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; }
        .btn { width: 100%; padding: 12px; background: linear-gradient(135deg, #FF6B6B 0%, #5E2A84 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        #statusMsg { margin-top: 10px; font-size: 0.8rem; text-align: center; color: #ef4444; }
    </style>
</head>
<body>

<div class="card">
    <h2>Lengkapkan Profil</h2>
    <p style="margin-bottom: 20px; color: #666;">Sila isi maklumat di bawah sebelum masuk ke sistem.</p>
    
    <form id="profileForm">
        <div class="input-group">
            <input type="text" id="fullname" placeholder="NAMA PENUH (IKUT IC)" required style="text-transform: uppercase;">
        </div>
        <div class="input-group">
            <input type="tel" id="phone" placeholder="NO TELEFON" required>
        </div>
        <div class="input-group">
            <select id="gender" required>
                <option value="">PILIH JANTINA</option>
                <option value="Lelaki">Lelaki</option>
                <option value="Perempuan">Perempuan</option>
            </select>
        </div>
        <button type="submit" id="saveBtn" class="btn">SIMPAN DATA & MASUK</button>
        <div id="statusMsg"></div>
    </form>
</div>

<script>
    const db = firebase.firestore();
    const auth = firebase.auth();
    let currentUid = null;
    let currentEmail = null;

    // 1. Cek Sesi User
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            console.log("User dikesan:", user.email);
            currentUid = user.uid;
            currentEmail = user.email;

            // Semak jika user ni SEBENARNYA dah ada data
            const doc = await db.collection('users').doc(user.uid).get();
            if (doc.exists && doc.data().profileCompleted === true) {
                console.log("Data dah ada, hantar ke greeting...");
                window.location.href = 'greeting.html';
            }
        } else {
            console.log("Tiada sesi, balik ke login.");
            window.location.href = 'login.html';
        }
    });

    // 2. Proses Simpan Data
    document.getElementById('profileForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const saveBtn = document.getElementById('saveBtn');
        const statusMsg = document.getElementById('statusMsg');

        if (!currentUid) {
            statusMsg.textContent = "Ralat: Sesi tidak dikesan. Sila login semula.";
            return;
        }

        saveBtn.disabled = true;
        saveBtn.textContent = "SEDANG MENYIMPAN...";

        const payload = {
            uid: currentUid,
            email: currentEmail,
            fullname: document.getElementById('fullname').value.toUpperCase(),
            phone: document.getElementById('phone').value,
            gender: document.getElementById('gender').value,
            role: 'user',
            profileCompleted: true,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        console.log("Cuba simpan data:", payload);

        try {
            // Guna .set() untuk pastikan dokumen dicipta/dikemaskini
            await db.collection('users').doc(currentUid).set(payload);
            
            console.log("Simpan BERJAYA!");
            statusMsg.style.color = "#10b981";
            statusMsg.textContent = "Data berjaya disimpan! Mengalih...";

            // Tunggu 1.5 saat baru redirect supaya database sempat 'breath'
            setTimeout(() => {
                window.location.href = 'greeting.html';
            }, 1500);

        } catch (error) {
            console.error("Ralat simpan:", error);
            saveBtn.disabled = false;
            saveBtn.textContent = "SIMPAN DATA & MASUK";
            statusMsg.textContent = "Gagal simpan: " + error.message;
        }
    });
</script>
</body>
</html>
