<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Admin - Rekod Sejarah</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<style>
/* =========================================
   CORE THEME
   ========================================= */
:root {
    --primary: #6C63FF; --primary-dark: #5a52d5;
    --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
    --info: #3b82f6; --word-blue: #2b579a;
    
    --bg-body: #F3F4F6; 
    --surface: rgba(255, 255, 255, 0.85); 
    
    --text-main: #393939; --text-light: #000000; 
    --border: rgba(255,255,255,0.6);
    --glass: blur(12px); 
    --shadow: 0 10px 30px -10px rgba(0,0,0,0.1);
    
    --btn-bg: rgba(255,255,255,0.5); 
    --btn-text: #475569;
}

body.dark-mode {
    --bg-body: #0f172a; 
    --surface: rgba(30, 41, 59, 0.85);
    --text-main: #f1f5f9; --text-light: #94a3b8; 
    --border: rgba(255,255,255,0.08);
    --btn-bg: rgba(0,0,0,0.3); 
    --btn-text: #e2e8f0;
}

* { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
body { font-family: 'Poppins', sans-serif; background-color: var(--bg-body); color: var(--text-main); min-height: 100vh; padding-bottom: 80px; transition: 0.3s; }

/* SILK CANVAS */
#silk-canvas {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
    background: #6C63FF; 
}

/* =========================================
   NAVBAR (GLASS/SEE THRU STYLE)
   ========================================= */
.navbar { 
    display: flex; justify-content: space-between; align-items: center; 
    padding: 15px 5%; margin: 20px; 
    background: rgba(255, 255, 255, 0.15); /* See-thru */
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border-radius: 50px; position: sticky; top: 20px; z-index: 100; 
    border: 1px solid rgba(255, 255, 255, 0.3); 
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1); 
    transition: transform 0.4s ease, opacity 0.4s ease, background 0.3s; 
}

body.dark-mode .navbar {
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
}

.nav-hidden { transform: translateY(-150%); opacity: 0; pointer-events: none; }

.brand { font-weight: 800; font-size: 1.2rem; color: var(--primary); display: flex; align-items: center; gap: 10px; text-shadow: 0 2px 10px rgba(0,0,0,0.05); }
.hamburger { display: none; font-size: 1.5rem; color: var(--text-main); cursor: pointer; }

.nav-right { display: flex; align-items: center; gap: 20px; }
.nav-links { display: flex; gap: 5px; }
.nav-link { text-decoration: none; color: var(--text-main); font-weight: 600; padding: 8px 16px; border-radius: 20px; transition: 0.3s; font-size: 0.9rem; }
.nav-link:hover, .nav-link.active { background: rgba(255, 255, 255, 0.2); color: var(--primary); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
body.dark-mode .nav-link:hover, body.dark-mode .nav-link.active { background: rgba(255,255,255,0.1); color: #fff; }

/* ADMIN BADGE */
.admin-badge { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.3); padding: 8px 20px; border-radius: 30px; font-size: 0.9rem; font-weight: 700; color: var(--text-main); border: 1px solid rgba(255,255,255,0.2); box-shadow: var(--shadow); cursor: default; backdrop-filter: blur(5px); }
body.dark-mode .admin-badge { background: rgba(0,0,0,0.3); border-color: rgba(255,255,255,0.1); }
.admin-badge i { color: var(--success); font-size: 1.2rem; }
.admin-details { display: flex; flex-direction: column; line-height: 1.2; text-align: left; }
.admin-role-label { font-size: 0.65rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
#adminNameDisplay { font-size: 0.9rem; font-weight: 700; }

/* CONTAINER */
.container { max-width: 1000px; margin: 0 auto; padding: 20px; padding-top: 40px; }

/* HEADER ROW */
.header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px; }
.page-title { font-size: 1.5rem; font-weight: 800; margin: 0; color: var(--text-main); }

/* ACTION BUTTONS */
.action-container { display: flex; gap: 10px; align-items: center; margin-bottom: 0; flex-wrap: wrap; }
.btn-action { display: flex; align-items: center; gap: 8px; padding: 10px 20px; border-radius: 12px; font-weight: 700; font-size: 0.85rem; border: none; cursor: pointer; transition: 0.3s; box-shadow: var(--shadow); backdrop-filter: blur(5px); }
.btn-refresh { background: rgba(59, 130, 246, 0.9); color: white; }
.btn-refresh:hover { background: #2563eb; transform: translateY(-2px); }
.btn-export { background: rgba(16, 185, 129, 0.9); color: white; }
.btn-export:hover { background: #059669; transform: translateY(-2px); }
.btn-word { background: rgba(43, 87, 154, 0.9); color: white; }
.btn-word:hover { background: #1e40a6; transform: translateY(-2px); }
.btn-clear { background: rgba(239, 68, 68, 0.9); color: white; }
.btn-clear:hover { background: #dc2626; transform: translateY(-2px); }

/* SEARCH & FILTER */
.search-container { background: var(--surface); backdrop-filter: var(--glass); padding: 10px 20px; border-radius: 50px; margin-bottom: 25px; box-shadow: var(--shadow); border: 1px solid var(--border); display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
.search-input-wrapper { display: flex; align-items: center; gap: 10px; flex: 1; min-width: 200px; }
.search-input { width: 100%; border: none; background: transparent; font-size: 1rem; color: var(--text-main); font-family: inherit; padding: 10px 0; outline: none; }
.search-icon { color: var(--text-light); font-size: 1.1rem; }
.sort-select { padding: 8px 15px; border-radius: 20px; border: 1px solid var(--border); background: rgba(255,255,255,0.4); color: var(--text-main); font-family: inherit; font-size: 0.9rem; cursor: pointer; outline: none; transition: 0.3s; }
body.dark-mode .sort-select { background: rgba(0,0,0,0.3); }
.sort-select:focus { border-color: var(--primary); }
.count-tag { background: var(--primary); color: white; padding: 8px 20px; border-radius: 30px; font-weight: 700; font-size: 0.9rem; white-space: nowrap; box-shadow: 0 4px 10px rgba(108, 99, 255, 0.3); }

/* RECORD CARD */
.record-card { 
    background: rgba(255,255,255,0.4); 
    backdrop-filter: blur(8px); 
    border-radius: 20px; margin-bottom: 15px; 
    border: 1px solid var(--border); 
    box-shadow: var(--shadow); overflow: hidden; 
    transition: transform 0.2s, background 0.3s; 
    position: relative; 
}
body.dark-mode .record-card { background: rgba(0,0,0,0.2); }
.record-header { padding: 20px 25px; cursor: pointer; display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 1px solid transparent; transition: 0.3s; }
.record-header:hover { background: rgba(255,255,255,0.2); }
.record-card.active .record-header { border-bottom-color: var(--border); background: rgba(255,255,255,0.1); }
.info-left { flex: 1; }

.user-name { margin: 0; font-size: 1.1rem; font-weight: 700; color: var(--text-main); display: flex; align-items: center; gap: 8px; }
.btn-link-user { background: transparent; border: none; color: var(--text-light); cursor: pointer; font-size: 0.9rem; transition: 0.3s; padding: 5px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
.btn-link-user:hover { color: var(--primary); background: rgba(108, 99, 255, 0.1); transform: translateX(2px) translateY(-2px); }

.user-details { font-size: 0.85rem; color: var(--text-light); margin-top: 5px; line-height: 1.5; }
.badge-sector { display: inline-block; width: 140px; text-align: center; padding: 5px 0; margin-top: 6px; margin-bottom: 6px; border-radius: 8px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
.badge-awam { background: #EEF2FF; color: #6C63FF; border: 1px solid #C7D2FE; }
.badge-swasta { background: #ECFDF5; color: #10b981; border: 1px solid #A7F3D0; }
body.dark-mode .badge-awam { background: rgba(99, 102, 241, 0.2); border-color: rgba(99, 102, 241, 0.4); color: #a5b4fc; }
body.dark-mode .badge-swasta { background: rgba(16, 185, 129, 0.2); border-color: rgba(16, 185, 129, 0.4); color: #6ee7b7; }

.header-right { text-align: right; display: flex; flex-direction: column; align-items: flex-end; gap: 5px; }
.money { display: flex; align-items: center; justify-content: flex-end; gap: 8px; font-size: 1.2rem; font-weight: 800; color: var(--primary); flex-wrap: wrap; }
.money-label { font-size: 0.75rem; font-weight: 600; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; }
.date { font-size: 0.75rem; color: var(--text-light); }
.btn-group { display: flex; gap: 10px; margin-top: 5px; }
.btn-icon { width: 35px; height: 35px; border-radius: 50%; border: 1px solid transparent; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; font-size: 0.9rem; }
.btn-trash { background: rgba(254, 226, 226, 0.8); color: #ef4444; border: none; }
.btn-trash:hover { background: #ef4444; color: white; transform: scale(1.1); }
.btn-expand { background: var(--btn-bg); color: var(--btn-text); border: 1px solid var(--border); }
.btn-expand:hover { background: var(--primary); color: white; border-color: var(--primary); }
.btn-expand i { transition: transform 0.3s; }

/* EXPANDED DETAILS */
.record-details { display: none; padding: 25px; background: rgba(0,0,0,0.02); animation: slideDown 0.3s ease; }
.record-card.active .record-details { display: block; }
@keyframes slideDown { from { opacity:0; transform:translateY(-10px); } to { opacity:1; transform:translateY(0); } }

.detail-section-title { font-size: 0.8rem; font-weight: 700; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; border-bottom: 1px dashed var(--border); padding-bottom: 5px; margin-top: 20px; }
.detail-section-title:first-child { margin-top: 0; }
.details-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
.detail-item { background: rgba(255,255,255,0.3); padding: 12px; border-radius: 12px; border: 1px solid var(--border); font-size: 0.85rem; text-align: center; overflow: hidden; }
body.dark-mode .detail-item { background: rgba(0,0,0,0.2); }
.detail-item label { display: block; font-size: 0.75rem; color: var(--text-light); margin-bottom: 4px; font-weight: 600; text-overflow: ellipsis; white-space: nowrap; overflow: hidden; }
.detail-item strong { display: block; font-weight: 700; color: var(--text-main); line-height: 1.2; }
.detail-item small { display: block; font-size: 0.7rem; color: var(--text-light); margin-top: 4px; font-weight: 500; }

/* === UPDATE: TABLE FIX (SOLID BACKGROUND) === */
.exp-table { 
    width: 100%; 
    border-collapse: separate; 
    border-spacing: 0;
    margin-top: 15px; 
    font-size: 0.85rem; 
    background: #ffffff; /* SOLID WHITE in Light Mode */
    border-radius: 12px; 
    border: 1px solid rgba(0,0,0,0.1); 
    box-shadow: 0 4px 10px rgba(0,0,0,0.03); 
    overflow: hidden;
}
body.dark-mode .exp-table {
    background: #1e293b; /* SOLID DARK in Dark Mode */
    border-color: rgba(255,255,255,0.1);
}
.exp-table th { 
    text-align: left; padding: 12px 15px; border-bottom: 2px solid #e2e8f0; 
    color: var(--primary); font-size: 0.75rem; text-transform: uppercase; 
    background: #f8fafc; font-weight: 700; letter-spacing: 0.5px;
}
body.dark-mode .exp-table th {
    background: rgba(0,0,0,0.2);
    border-bottom-color: rgba(255,255,255,0.1);
}
.exp-table td { 
    padding: 12px 15px; border-bottom: 1px solid #f1f5f9; 
    color: var(--text-main); vertical-align: middle; 
}
body.dark-mode .exp-table td {
    border-bottom-color: rgba(255,255,255,0.05);
}
.exp-table tr:last-child td { border-bottom: none; }
/* === END TABLE FIX === */

/* MODAL */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 2000; opacity: 0; transition: opacity 0.3s; }
.modal-overlay.show { display: flex; opacity: 1; }
.modal-box { background: var(--surface); padding: 30px; border-radius: 24px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.3); transform: translateY(30px); transition: transform 0.3s; border: 1px solid var(--border); }
.modal-overlay.show .modal-box { transform: translateY(0); }
.modal-icon { font-size: 2.5rem; color: #ef4444; margin-bottom: 15px; background: #fee2e2; width: 80px; height: 80px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; animation: pulseRed 2s infinite; }
@keyframes pulseRed { 0% {box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);} 70% {box-shadow: 0 0 0 15px rgba(239, 68, 68, 0);} 100% {box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);} }
.modal-title { font-size: 1.3rem; font-weight: 800; color: var(--text-main); margin-bottom: 8px; }
.modal-desc { font-size: 0.95rem; color: var(--text-light); margin-bottom: 25px; line-height: 1.5; }
.modal-actions { display: flex; gap: 12px; }
.btn-modal { flex: 1; padding: 14px; border-radius: 12px; font-weight: 700; cursor: pointer; border: none; font-size: 0.95rem; transition: 0.2s; }
.btn-cancel { background: #e2e8f0; color: #475569; }
.btn-cancel:hover { background: #cbd5e1; }
.btn-confirm-del { background: #ef4444; color: white; box-shadow: 0 5px 15px rgba(239, 68, 68, 0.3); }
.btn-confirm-del:hover { background: #dc2626; transform: translateY(-2px); }

/* FLOAT BTN & TOAST */
.float-btn { position: fixed; width: 50px; height: 50px; border-radius: 50%; background: var(--surface); color: var(--text-main); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; z-index: 90; box-shadow: var(--shadow); transition: all 0.4s; opacity: 0.5; transform: translateX(-50%); }
.float-btn:hover, .float-btn.active-float { opacity: 1; transform: translateX(0); }
#themeBtn { bottom: 30px; left: 30px; transform: translateX(-25px); }
#themeBtn:hover, #themeBtn.active-float { transform: translateX(0); }
#topBtn { bottom: 30px; right: 30px; opacity: 0; visibility: hidden; background: var(--primary); color: white; border: none; transform: translateY(20px); }
#topBtn.show { opacity: 0.5; visibility: visible; transform: translateY(0) translateX(25px); }
#topBtn.show:hover, #topBtn.show.active-float { opacity: 1; transform: translateY(0) translateX(0); }

.toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: #10b981; color: white; padding: 12px 25px; border-radius: 30px; font-weight: 600; box-shadow: 0 10px 30px rgba(0,0,0,0.2); opacity: 0; z-index: 3000; transition: 0.4s; display: flex; align-items: center; gap: 8px; }
.toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

/* RESPONSIVE */
@media(max-width: 900px) {
    .navbar { flex-direction: column; align-items: flex-start; gap: 15px; padding: 20px; height: auto; position: relative; background: rgba(255,255,255,0.3); }
    body.dark-mode .navbar { background: rgba(0,0,0,0.4); }
    .hamburger { display: block; position: absolute; right: 20px; top: 22px; }
    
    .nav-right { width: 100%; flex-direction: column; display: none; margin-top: 15px; gap: 15px; }
    .nav-right.active { display: flex; animation: slideDown 0.3s ease; }
    
    .nav-links { width: 100%; flex-direction: column; align-items: center; gap: 10px; }
    .nav-link { width: 100%; text-align: center; display: block; padding: 12px; background: rgba(255,255,255,0.1); border-radius: 15px; }
    .admin-badge { width: 100%; justify-content: center; }
    
    .header-row { flex-direction: column; align-items: flex-start; gap: 10px; }
    .action-container { width: 100%; justify-content: space-between; }
    .btn-action { flex: 1; justify-content: center; padding: 10px; }

    .record-header { flex-direction: column; align-items: flex-start; gap: 15px; }
    .header-right { text-align: left; width: 100%; display: flex; flex-direction: row; justify-content: space-between; align-items: center; border-top: 1px solid var(--border); padding-top: 10px; }
    .search-container { flex-direction: column; align-items: stretch; border-radius: 20px; padding: 15px; }
    .count-tag { text-align: center; margin-top:10px; }
    .money { justify-content: space-between; width: 100%; }
}
@keyframes slideDown { from { opacity:0; transform:translateY(-10px); } to { opacity:1; transform:translateY(0); } }
</style>
</head>
<body>

<div id="silk-canvas"></div>

<nav class="navbar" id="mainNav">
    <div class="brand"><i class="fa-solid fa-folder-open"></i> REKOD TERPERINCI</div>
    <div class="hamburger" onclick="toggleMenu()"><i class="fa-solid fa-bars"></i></div>
    
    <div class="nav-right" id="navMenu">
        <div class="admin-badge" id="adminBadge">
            <i class="fa-solid fa-circle-user"></i>
            <div class="admin-details">
                <span class="admin-role-label">Logged as</span>
                <span id="adminNameDisplay">Loading...</span>
            </div>
        </div>
        <div class="nav-links">
            <a href="dashboard.html" class="nav-link">Home</a>
            <a href="admin_dashboard.html" class="nav-link">Dashboard</a>
            <a href="admin_users.html" class="nav-link">Users</a>
            <a href="admin_history.html" class="nav-link active">Rekod</a>
            <a href="admin_salary.html" class="nav-link">Gaji</a>
            <a href="admin_feedback.html" class="nav-link">Feedback</a>
        </div>
    </div>
</nav>

<div class="container">
    <div class="header-row">
        <h2 class="page-title">Sejarah Kiraan Lengkap</h2>
        
        <div class="action-container">
            <button class="btn-action btn-refresh" onclick="loadHistory(true)">
                <i class="fa-solid fa-rotate-right"></i> Refresh
            </button>
            <button class="btn-action btn-export" onclick="exportToExcel()">
                <i class="fa-solid fa-file-excel"></i> Excel
            </button>
            <button class="btn-action btn-word" onclick="exportToWord()">
                <i class="fa-solid fa-file-word"></i> Word
            </button>
            <button class="btn-action btn-clear" onclick="openFirstWarning()">
                <i class="fa-solid fa-trash-can"></i> Padam Semua
            </button>
        </div>
    </div>

    <div class="search-container">
        <div class="search-input-wrapper">
            <i class="fa-solid fa-magnifying-glass search-icon"></i>
            <input type="text" id="searchInput" class="search-input" placeholder="Cari nama atau username..." onkeyup="filterHistory()">
        </div>
        
        <select id="sectorSelect" class="sort-select" onchange="filterHistory()" style="margin-left:5px;">
            <option value="all" selected>Semua Sektor</option>
            <option value="awam">Sektor Awam</option>
            <option value="swasta">Sektor Swasta</option>
        </select>

        <select id="sortSelect" class="sort-select" onchange="filterHistory()">
            <option value="newest" selected>Terkini</option>
            <option value="oldest">Terlama</option>
            <option value="az">Nama (A-Z)</option>
        </select>

        <div class="count-tag">
            Jumlah: <span id="totalCount">0</span>
        </div>
    </div>

    <div id="recordsList">
        <p style="text-align:center; padding:40px; background:var(--surface); border-radius:20px; color:var(--text-light);">Sedang memuatkan data...</p>
    </div>
</div>

<div class="modal-overlay" id="deleteModal">
    <div class="modal-box">
        <div class="modal-icon"><i class="fa-solid fa-trash-can"></i></div>
        <h3 class="modal-title">Padam Rekod?</h3>
        <p class="modal-desc">Adakah anda pasti mahu memadam rekod ini secara kekal? Tindakan ini tidak boleh diundur.</p>
        <div class="modal-actions">
            <button class="btn-modal btn-cancel" onclick="closeModal()">Batal</button>
            <button class="btn-modal btn-confirm-del" onclick="confirmDelete()">Ya, Padam</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="firstWarningModal">
    <div class="modal-box">
        <div class="modal-icon" style="background:#fef3c7; color:#f59e0b;"><i class="fa-solid fa-triangle-exclamation"></i></div>
        <h3 class="modal-title">Padam SEMUA Rekod?</h3>
        <p class="modal-desc">AWAS! Anda akan memadam <b>seluruh pangkalan data sejarah</b>. Adakah anda pasti? Sila pastikan anda sudah memuat turun fail Excel sebagai sandaran.</p>
        <div class="modal-actions">
            <button class="btn-modal btn-cancel" onclick="closeFirstWarning()">Batal</button>
            <button class="btn-modal btn-confirm-del" onclick="proceedToFinalWarning()" style="background:#f59e0b;">Teruskan</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="finalWarningModal">
    <div class="modal-box">
        <div class="modal-icon"><i class="fa-solid fa-skull-crossbones"></i></div>
        <h3 class="modal-title" style="color:var(--danger)">PENGESAHAN TERAKHIR</h3>
        <p class="modal-desc">Ini adalah amaran terakhir. Semua data akan hilang serta-merta dan <b>tidak boleh dikembalikan</b>. Adakah anda benar-benar pasti?</p>
        <div class="modal-actions">
            <button class="btn-modal btn-cancel" onclick="closeFinalWarning()">JANGAN PADAM</button>
            <button class="btn-modal btn-confirm-del" onclick="executeDeleteAll()">YA, SAYA FAHAM</button>
        </div>
    </div>
</div>

<button class="float-btn" id="themeBtn"><i class="fa-solid fa-moon"></i></button>
<button class="float-btn" id="topBtn" onclick="window.scrollTo({top:0, behavior:'smooth'})"><i class="fa-solid fa-arrow-up"></i></button>
<div id="toast" class="toast"><i class="fa-solid fa-check-circle"></i> <span id="toastMsg">Rekod berjaya dipadam!</span></div>

<script>
    // Config Colors (Blue Theme)
    const silkConfig = {
        speed: 4.0, scale: 0.8,
        colorLight: "#6C63FF", // Primary Indigo/Blue
        colorDark: "#0f172a",  // Dark Navy
        noiseIntensity: 1.8, rotation: 0.0
    };

    let silkUniforms;

    const vertexShader = `
        varying vec2 vUv;
        void main() { vUv = uv; gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }
    `;

    const fragmentShader = `
        varying vec2 vUv;
        uniform float uTime; uniform vec3 uColor; uniform float uSpeed; uniform float uScale; uniform float uRotation; uniform float uNoiseIntensity;
        const float e = 2.71828182845904523536;
        float noise(vec2 texCoord) { float G = e; vec2 r = (G * sin(G * texCoord)); return fract(r.x * r.y * (1.0 + texCoord.x)); }
        vec2 rotateUvs(vec2 uv, float angle) { float c = cos(angle); float s = sin(angle); mat2 rot = mat2(c, -s, s, c); return rot * uv; }
        void main() {
            float rnd = noise(gl_FragCoord.xy);
            vec2 uv = rotateUvs(vUv * uScale, uRotation);
            vec2 tex = uv * uScale;
            float tOffset = uSpeed * uTime;
            tex.y += 0.03 * sin(8.0 * tex.x - tOffset);
            float pattern = 0.6 + 0.4 * sin(5.0 * (tex.x + tex.y + cos(3.0 * tex.x + 5.0 * tex.y) + 0.02 * tOffset) + sin(20.0 * (tex.x + tex.y - 0.1 * tOffset)));
            vec4 col = vec4(uColor, 1.0) * vec4(pattern) - rnd / 15.0 * uNoiseIntensity;
            col.a = 1.0;
            gl_FragColor = col;
        }
    `;

    function initSilk() {
        const container = document.getElementById('silk-canvas');
        if(!container) return;
        const scene = new THREE.Scene();
        const camera = new THREE.OrthographicCamera(-1, 1, 1, -1, 0, 1);
        const renderer = new THREE.WebGLRenderer({ alpha: false, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        container.appendChild(renderer.domElement);

        const isDark = document.body.classList.contains('dark-mode');
        const startColor = isDark ? silkConfig.colorDark : silkConfig.colorLight;

        silkUniforms = {
            uTime: { value: 0 }, uColor: { value: new THREE.Color(startColor) },
            uSpeed: { value: silkConfig.speed }, uScale: { value: silkConfig.scale },
            uRotation: { value: silkConfig.rotation }, uNoiseIntensity: { value: silkConfig.noiseIntensity }
        };

        const geometry = new THREE.PlaneGeometry(2, 2);
        const material = new THREE.ShaderMaterial({ uniforms: silkUniforms, vertexShader: vertexShader, fragmentShader: fragmentShader });
        const plane = new THREE.Mesh(geometry, material);
        scene.add(plane);

        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            silkUniforms.uTime.value += clock.getDelta() * 0.08; 
            renderer.render(scene, camera);
        }
        animate();
        window.addEventListener('resize', () => { renderer.setSize(window.innerWidth, window.innerHeight); });
    }
    window.addEventListener('load', initSilk);
</script>

<script>
if (!sessionStorage.getItem('admin_verified')) {
    alert("Akses tidak dibenarkan. Sila sahkan No. Staf.");
    window.location.href = 'admin_gate.html';
}

const firebaseConfig = { apiKey: "AIzaSyDcCimpduiHdGyEmWHivg2tz_GkEgbnxf8", authDomain: "data-staff-6hha55.firebaseapp.com", projectId: "data-staff-6hha55", storageBucket: "data-staff-6hha55.firebasestorage.app", messagingSenderId: "834544418876", appId: "1:834544418876:web:71b355bd0f3faf73244339" };
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.firestore(); const auth = firebase.auth();

// UI HELPERS
function toggleMenu() { document.getElementById('navMenu').classList.toggle('active'); }

let lastScrollTop = 0;
const navbar = document.getElementById('mainNav');
const topBtn = document.getElementById('topBtn');
window.addEventListener('scroll', () => {
    let st = window.pageYOffset || document.documentElement.scrollTop;
    if (st > 50) navbar.classList.add('nav-hidden'); else navbar.classList.remove('nav-hidden');
    if (st > 300) topBtn.classList.add('show'); else topBtn.classList.remove('show');
});

// AUTO HIDE FLOAT BUTTONS
let floatTimer;
const floatBtns = document.querySelectorAll('.float-btn');
function showFloatBtns() {
    floatBtns.forEach(btn => btn.classList.add('active-float'));
    clearTimeout(floatTimer);
    floatTimer = setTimeout(() => { floatBtns.forEach(btn => btn.classList.remove('active-float')); }, 2500);
}
window.addEventListener('scroll', showFloatBtns);
window.addEventListener('click', showFloatBtns);

const themeBtn = document.getElementById('themeBtn');
if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
themeBtn.onclick = (e) => {
    e.stopPropagation();
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    themeBtn.innerHTML = isDark ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';
    if(silkUniforms) silkUniforms.uColor.value.set(isDark ? silkConfig.colorDark : silkConfig.colorLight);
};

function showToast(msg = "Rekod berjaya dipadam!") {
    const t = document.getElementById('toast');
    document.getElementById('toastMsg').innerText = msg;
    t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000);
}

// --- DATA LOGIC ---
let allRecords = [];
let deleteTargetId = null;

auth.onAuthStateChanged(user => { 
    if(user) {
        loadAdminName();
        loadHistory();
    } else location.href='login.html'; 
});

async function loadAdminName() {
    const currentStafID = sessionStorage.getItem('current_admin_staf');
    if(currentStafID) {
        try {
            const snapshot = await db.collection('admin_whitelist').where('no_staf', '==', currentStafID).limit(1).get();
            if(!snapshot.empty) document.getElementById('adminNameDisplay').innerText = snapshot.docs[0].data().nama || "Pentadbir";
        } catch(e) { console.error(e); }
    }
}

async function loadHistory(isRefresh = false) {
    const container = document.getElementById('recordsList');
    if(isRefresh) {
        container.innerHTML = '<p style="text-align:center; padding:40px;">Memuat semula data...</p>';
        showToast("Sedang memuat semula data...");
    }
    
    try {
        const snap = await db.collection('printedSlips').orderBy('timestamp', 'desc').get();
        if(snap.empty) { 
            container.innerHTML = '<p style="text-align:center;">Tiada rekod dijumpai.</p>'; 
            document.getElementById('totalCount').innerText = "0";
            return; 
        }
        allRecords = [];
        snap.forEach(doc => {
            let data = doc.data();
            data.id = doc.id;
            if(!data.timestamp) data.timestamp = { seconds: 0 };
            allRecords.push(data);
        });
        renderList(allRecords);
    } catch(e) { console.error(e); container.innerHTML = "Ralat memuatkan data."; }
}

function renderList(dataArr) {
    const container = document.getElementById('recordsList');
    document.getElementById('totalCount').innerText = dataArr.length;
    container.innerHTML = "";

    if(dataArr.length === 0) {
        container.innerHTML = '<p style="text-align:center; padding:20px;">Tiada rekod ditemui.</p>';
        return;
    }

    let html = '';
    dataArr.forEach(d => {
        const dateStr = d.timestamp.seconds ? new Date(d.timestamp.seconds * 1000).toLocaleString('en-MY', { 
            day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true  
        }) : '-';

        let sektor = d.jenis_sektor || d.kategori || 'Sektor Awam';
        if(sektor.toLowerCase().includes('swasta')) sektor = 'Sektor Swasta'; else sektor = 'Sektor Awam';
        
        const tagClass = sektor === 'Sektor Swasta' ? 'badge-swasta' : 'badge-awam';
        const sektorLabel = sektor.toUpperCase();
        const rm = (val) => `RM ${parseFloat(val || 0).toFixed(2)}`;

        const displayUsername = d.fullname || d.email || 'No Username';
        const mainName = d.fullname || d.nama_penuh || d.nama || d.name || 'User';

        let expTable = '';
        if(d.senarai_pengalaman && d.senarai_pengalaman.length > 0) {
            let rows = d.senarai_pengalaman.map(e => {
                let durationText = e.tempoh_format_lengkap || `${e.tempoh_bulan || 0} Bulan`;
                let dateRange = (e.tarikh_mula && e.tarikh_tamat) ? `${new Date(e.tarikh_mula).toLocaleDateString()} - ${new Date(e.tarikh_tamat).toLocaleDateString()}` : '';
                return `<tr><td><strong>${e.jawatan}</strong><br><small>${e.organisasi}</small></td><td>${e.gaji_terakhir ? 'RM '+parseFloat(e.gaji_terakhir).toFixed(2) : '-'}</td><td>${dateRange ? `<span style="font-size:0.8rem">${dateRange}</span><br>` : ''}<span style="font-weight:600; color:var(--primary); font-size:0.75rem;">${durationText}</span></td></tr>`;
            }).join('');
            expTable = `<div class="detail-section-title">Rekod Pengalaman Terdahulu</div><div style="overflow-x:auto"><table class="exp-table"><thead><tr><th width="35%">Jawatan / Organisasi</th><th width="20%">Gaji Akhir</th><th width="45%">Tempoh Perkhidmatan</th></tr></thead><tbody>${rows}<tr style="background:rgba(0,0,0,0.02)"><td colspan="2" align="right"><strong>Jumlah Pengalaman Diambil Kira:</strong></td><td><strong>${d.jumlah_tahun_pengalaman || 0} Tahun</strong></td></tr></tbody></table></div>`;
        }

        let awamInfo = '';
        if(sektor === 'Sektor Awam' && d.dapat_pgt) {
            awamInfo = `<div class="detail-section-title">Maklumat Perkhidmatan</div><div class="details-grid"><div class="detail-item"><label>Status PGT</label><strong>${d.dapat_pgt}</strong></div><div class="detail-item"><label>Bulan TPG</label><strong>${d.bulan_pergerakan || '-'}</strong></div></div>`;
        }

        let posBasikVal = parseFloat(d.bipb || 0) || (d.nama_sijil_pos_basik ? 100 : 0);
        let posBasikName = d.nama_sijil_pos_basik ? `<br><small style="color:var(--primary);">${d.nama_sijil_pos_basik}</small>` : '';

        html += `
        <div class="record-card" id="card-${d.id}">
            <div class="record-header">
                <div class="info-left" onclick="toggleCard(event, '${d.id}')">
                    <div class="user-name">
                        ${mainName}
                        <button class="btn-link-user" onclick="goToUser('${mainName}')" title="Lihat Profil">
                            <i class="fa-solid fa-arrow-up-right-from-square"></i>
                        </button>
                    </div>
                    <div class="badge-sector ${tagClass}">${sektorLabel}</div>
                    <div class="user-details">
                        <span style="color:var(--primary); font-weight:600; font-size:0.8rem;">@${displayUsername}</span><br>
                        <i class="fa-solid fa-briefcase" style="width:20px; color:var(--text-light);"></i> ${d.jawatan_terpilih || d.jawatan || '-'}<br>
                        <i class="fa-solid fa-location-dot" style="width:20px; color:var(--text-light);"></i> ${d.wilayah_asal || '-'}
                    </div>
                </div>
                <div class="header-right">
                    <div class="money">
                        <span class="money-label"><b>Jumlah Keseluruhan Gaji:</b></span>
                        <span>${rm(d.gaji_bersih)}</span>
                    </div>
                    <span class="date">${dateStr}</span>
                    <div class="btn-group">
                        <button class="btn-icon btn-trash" onclick="openDeleteModal('${d.id}')" title="Padam Rekod"><i class="fa-solid fa-trash"></i></button>
                        <button class="btn-icon btn-expand" onclick="toggleCard(event, '${d.id}')" title="Lihat Perincian"><i class="fa-solid fa-chevron-down"></i></button>
                    </div>
                </div>
            </div>
            <div class="record-details">
                ${awamInfo}
                <div class="detail-section-title">Pendapatan Utama</div>
                <div class="details-grid">
                    <div class="detail-item"><label>Gaji Pokok Asal</label><strong>${rm(d.gaji_pokok || d.gaji_pokok_asal)}</strong></div>
                    <div class="detail-item"><label>Kenaikan KGT</label><strong>${rm(d.kgt_tambahan || d.jumlah_kenaikan_kgt)}</strong></div>
                    <div class="detail-item" style="border-color:var(--primary); background:rgba(108,99,255,0.05);"><label>Gaji Pokok Baru</label><strong style="color:var(--primary);">${rm(d.gaji_pokok_baru || d.gaji_pokok)}</strong></div>
                </div>
                <div class="detail-section-title">Perincian Elaun</div>
                <div class="details-grid">
                    <div class="detail-item"><label>ITKA</label><strong>${rm(d.itka)}</strong></div>
                    <div class="detail-item"><label>ITP / Perumahan</label><strong>${rm(d.itp || d.el_perumahan)}</strong></div>
                    <div class="detail-item"><label>ITK / Keraian</label><strong>${rm(d.itk)}</strong></div>
                    <div class="detail-item"><label>BIPK / Kritikal</label><strong>${rm(d.bipk)}</strong></div>
                    <div class="detail-item"><label>BISH / COLA</label><strong>${rm(d.bish || d.cola)}</strong></div>
                    <div class="detail-item"><label>BIW / Wilayah</label><strong>${rm(d.biw || d.el_wilayah)}</strong></div>
                    <div class="detail-item"><label>BIP / Pakar</label><strong>${rm(d.bip || d.el_pakar)}</strong></div>
                    <div class="detail-item"><label>Insentif Pos Basik</label><strong>${rm(posBasikVal)}</strong>${posBasikName}</div>
                </div>
                ${expTable}
            </div>
        </div>`;
    });
    container.innerHTML = html;
}

function filterHistory() {
    const input = document.getElementById('searchInput').value.toLowerCase();
    const sortMode = document.getElementById('sortSelect').value;
    const sectorMode = document.getElementById('sectorSelect').value;

    let filtered = allRecords.filter(d => {
        const name = (d.fullname || d.nama_penuh || d.nama || "").toLowerCase();
        const username = (d.username || d.email || "").toLowerCase();
        const matchesSearch = name.includes(input) || username.includes(input);

        let sektor = d.jenis_sektor || d.kategori || 'awam';
        let isSectorMatch = true;
        if (sectorMode === 'awam') isSectorMatch = !sektor.toLowerCase().includes('swasta');
        else if (sectorMode === 'swasta') isSectorMatch = sektor.toLowerCase().includes('swasta');

        return matchesSearch && isSectorMatch;
    });

    filtered.sort((a, b) => {
        const timeA = a.timestamp ? (a.timestamp.seconds || 0) : 0;
        const timeB = b.timestamp ? (b.timestamp.seconds || 0) : 0;
        if (sortMode === 'newest') return timeB - timeA;
        if (sortMode === 'oldest') return timeA - timeB;
        if (sortMode === 'az') {
            const nameA = (a.fullname || a.nama_penuh || "").toLowerCase();
            const nameB = (b.fullname || b.nama_penuh || "").toLowerCase();
            return nameA.localeCompare(nameB);
        }
        return 0;
    });
    renderList(filtered);
}

function goToUser(name) {
    if(!name || name === 'User') { alert("Tiada nama pengguna."); return; }
    window.location.href = `admin_users.html?search=${encodeURIComponent(name)}`;
}

window.toggleCard = function(e, id) {
    if(e && e.target.closest('.btn-link-user')) return; 
    if(e) e.stopPropagation();
    const card = document.getElementById(`card-${id}`);
    const isActive = card.classList.contains('active');
    closeAllCards();
    if(!isActive) { card.classList.add('active'); const icon = card.querySelector('.fa-chevron-down'); if(icon) icon.style.transform = 'rotate(180deg)'; }
}
function closeAllCards() {
    document.querySelectorAll('.record-card.active').forEach(card => {
        card.classList.remove('active');
        const icon = card.querySelector('.fa-chevron-down');
        if(icon) icon.style.transform = 'rotate(0deg)';
    });
}
document.addEventListener('click', function(e) { if (!e.target.closest('.record-card')) closeAllCards(); });

window.openDeleteModal = function(id) { deleteTargetId = id; document.getElementById('deleteModal').classList.add('show'); }
window.closeModal = function() { document.getElementById('deleteModal').classList.remove('show'); deleteTargetId = null; }
window.confirmDelete = async function() {
    if(!deleteTargetId) return;
    try { await db.collection('printedSlips').doc(deleteTargetId).delete(); closeModal(); showToast(); allRecords = allRecords.filter(r => r.id !== deleteTargetId); filterHistory(); } catch(e) { alert("Ralat."); closeModal(); }
}

// --- EXPORT TO EXCEL ---
function exportToExcel() {
    if(allRecords.length === 0) { alert("Tiada data untuk dieksport."); return; }
    
    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent += "Nama Penuh,Email,Sektor,Jawatan,Wilayah,Gaji Bersih,Tarikh\n";

    allRecords.forEach(r => {
        const name = (r.fullname || r.nama_penuh || "User").replace(/,/g, " ");
        const email = r.email || "-";
        const sector = (r.jenis_sektor || r.kategori || "").replace(/,/g, " ");
        const job = (r.jawatan_terpilih || r.jawatan || "").replace(/,/g, " ");
        const loc = r.wilayah_asal || "-";
        const total = r.gaji_bersih || 0;
        
        let dateStr = "-";
        if(r.timestamp.seconds) {
            const d = new Date(r.timestamp.seconds * 1000);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            const hour = String(d.getHours()).padStart(2, '0');
            const min = String(d.getMinutes()).padStart(2, '0');
            const sec = String(d.getSeconds()).padStart(2, '0');
            dateStr = `"${day}/${month}/${year} ${hour}:${min}:${sec}"`;
        }

        csvContent += `${name},${email},${sector},${job},${loc},${total},${dateStr}\n`;
    });

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "Rekod_Sejarah_Gaji.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// --- EXPORT TO WORD ---
function exportToWord() {
    if (allRecords.length === 0) { alert("Tiada data untuk dieksport."); return; }

    let tableRows = "";
    allRecords.forEach((r, index) => {
        const dateStr = r.timestamp.seconds ? new Date(r.timestamp.seconds * 1000).toLocaleString('en-MY', { 
            day: 'numeric', month: 'short', year: 'numeric', 
            hour: '2-digit', minute: '2-digit', hour12: true 
        }) : "-";
        
        const name = r.fullname || r.nama_penuh || "User";
        const email = r.email || "-";
        const sector = r.jenis_sektor || r.kategori || "-";
        const job = r.jawatan_terpilih || r.jawatan || "-";
        const loc = r.wilayah_asal || "-";
        const total = parseFloat(r.gaji_bersih || 0).toFixed(2);

        tableRows += `
            <tr>
                <td style="text-align:center;">${index + 1}</td>
                <td>${name}</td>
                <td>${email}</td>
                <td>${sector}</td>
                <td>${job}</td>
                <td>${loc}</td>
                <td>RM ${total}</td>
                <td>${dateStr}</td>
            </tr>
        `;
    });

    const htmlContent = `
        <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
        <head>
            <meta charset='utf-8'>
            <title>Laporan Gaji Lengkap</title>
            <style>
                body { font-family: Arial, sans-serif; font-size: 11px; }
                .header { text-align: center; margin-bottom: 20px; }
                h2 { color: #2b579a; margin-bottom: 5px; }
                p { margin: 0; color: #555; }
                table { border-collapse: collapse; width: 100%; margin-top: 10px; font-size: 10px; }
                th { background-color: #2b579a; color: white; padding: 8px; border: 1px solid #ddd; text-align: left; }
                td { padding: 6px; border: 1px solid #ddd; vertical-align: top; }
                tr:nth-child(even) { background-color: #f9f9f9; }
            </style>
        </head>
        <body>
            <div class="header">
                <h2>Laporan Sejarah Kiraan Gaji</h2>
                <p>Dijana pada: ${new Date().toLocaleString('en-MY', { hour12: true })}</p>
                <p>Jumlah Rekod: ${allRecords.length}</p>
            </div>
            <table>
                <thead>
                    <tr>
                        <th style="width: 30px; text-align:center;">No.</th>
                        <th>Nama Penuh</th>
                        <th>Email</th>
                        <th>Sektor</th>
                        <th>Jawatan</th>
                        <th>Wilayah</th>
                        <th>Gaji Bersih</th>
                        <th>Tarikh Kiraan</th>
                    </tr>
                </thead>
                <tbody>
                    ${tableRows}
                </tbody>
            </table>
        </body>
        </html>
    `;

    const blob = new Blob(['\ufeff', htmlContent], { type: 'application/msword' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = "Laporan_Lengkap_Gaji.doc";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// --- DOUBLE WARNING DELETE ALL ---
window.openFirstWarning = function() { document.getElementById('firstWarningModal').classList.add('show'); }
window.closeFirstWarning = function() { document.getElementById('firstWarningModal').classList.remove('show'); }

window.proceedToFinalWarning = function() {
    closeFirstWarning();
    setTimeout(() => {
        document.getElementById('finalWarningModal').classList.add('show');
    }, 300);
}

window.closeFinalWarning = function() { document.getElementById('finalWarningModal').classList.remove('show'); }

window.executeDeleteAll = async function() {
    const total = allRecords.length;
    if(total === 0) { alert("Tiada rekod untuk dipadam."); closeFinalWarning(); return; }

    try {
        const batchSize = 400; 
        const chunks = [];
        
        for (let i = 0; i < total; i += batchSize) {
            chunks.push(allRecords.slice(i, i + batchSize));
        }

        for (const chunk of chunks) {
            const batch = db.batch();
            chunk.forEach(doc => {
                const ref = db.collection('printedSlips').doc(doc.id);
                batch.delete(ref);
            });
            await batch.commit();
        }

        closeFinalWarning();
        showToast("Semua rekod berjaya dipadam!");
        allRecords = [];
        filterHistory();

    } catch (error) {
        console.error("Error deleting all:", error);
        alert("Ralat semasa memadam data.");
    }
}
</script>
</body>
</html>
