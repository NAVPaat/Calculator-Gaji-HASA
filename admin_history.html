<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Admin - Rekod Sejarah</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<style>
/* =========================================
   CORE THEME
   ========================================= */
:root {
    --primary: #6C63FF; --primary-dark: #5a52d5;
    --bg-body: #F3F4F6; --surface: rgba(255, 255, 255, 0.95);
    --text-main: #334155; --text-light: #64748b; --border: rgba(255,255,255,0.6);
    --glass: blur(12px); --shadow: 0 10px 30px -10px rgba(0,0,0,0.1);
}

body.dark-mode {
    --bg-body: #0f172a; --surface: rgba(30, 41, 59, 0.95);
    --text-main: #f1f5f9; --text-light: #94a3b8; --border: rgba(255,255,255,0.08);
}

* { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
body { font-family: 'Poppins', sans-serif; background-color: var(--bg-body); color: var(--text-main); min-height: 100vh; padding-bottom: 80px; transition: 0.3s; }

/* BLOBS */
.bg-blobs { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; }
.blob { position: absolute; filter: blur(80px); opacity: 0.6; animation: floatBlob 10s infinite alternate; }
.blob-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: #abbdf6; }
.blob-2 { bottom: -10%; right: -10%; width: 60vw; height: 60vw; background: #F0FDFA; }
body.dark-mode .blob { opacity: 0.15; }
@keyframes floatBlob { 0% { transform: translate(0,0); } 100% { transform: translate(20px, 40px); } }

/* NAVBAR */
.navbar { display: flex; justify-content: space-between; align-items: center; padding: 15px 5%; margin: 20px; background: var(--surface); backdrop-filter: var(--glass); border-radius: 50px; position: sticky; top: 20px; z-index: 100; border: 1px solid var(--border); box-shadow: var(--shadow); transition: transform 0.3s; }
.nav-hidden { transform: translateY(-150%); }
.brand { font-weight: 800; font-size: 1.2rem; color: var(--primary); display: flex; align-items: center; gap: 10px; }
.nav-links { display: flex; gap: 20px; }
.nav-link { text-decoration: none; color: var(--text-light); font-weight: 600; padding: 8px 16px; border-radius: 20px; transition: 0.3s; font-size: 0.9rem; }
.nav-link:hover, .nav-link.active { background: rgba(108, 99, 255, 0.1); color: var(--primary); }

/* CONTAINER */
.container { max-width: 1000px; margin: 0 auto; padding: 20px; padding-top: 40px; }

/* SEARCH & FILTER CONTAINER */
.search-container {
    background: var(--surface); backdrop-filter: var(--glass);
    padding: 10px 20px; border-radius: 50px; margin-bottom: 25px;
    box-shadow: var(--shadow); border: 1px solid var(--border);
    display: flex; align-items: center; gap: 15px; flex-wrap: wrap;
}

.search-input-wrapper {
    display: flex; align-items: center; gap: 10px; flex: 1; min-width: 200px;
}
.search-input {
    width: 100%; border: none; background: transparent;
    font-size: 1rem; color: var(--text-main); font-family: inherit;
    padding: 10px 0; outline: none;
}
.search-icon { color: var(--text-light); font-size: 1.1rem; }

/* SORT DROPDOWN */
.sort-select {
    padding: 8px 15px; border-radius: 20px; border: 1px solid var(--border);
    background: rgba(255,255,255,0.5); color: var(--text-main); font-family: inherit; font-size: 0.9rem;
    cursor: pointer; outline: none; transition: 0.3s;
}
body.dark-mode .sort-select { background: rgba(0,0,0,0.2); }
.sort-select:focus { border-color: var(--primary); }

/* COUNT TAG */
.count-tag {
    background: var(--primary); color: white; padding: 8px 20px;
    border-radius: 30px; font-weight: 700; font-size: 0.9rem;
    white-space: nowrap; box-shadow: 0 4px 10px rgba(108, 99, 255, 0.3);
}

/* RECORD CARD */
.record-card {
    background: var(--surface); backdrop-filter: var(--glass); border-radius: 20px;
    margin-bottom: 15px; border: 1px solid var(--border); box-shadow: var(--shadow);
    overflow: hidden; transition: transform 0.2s; position: relative;
}
.record-header {
    padding: 20px 25px; cursor: pointer; display: flex; justify-content: space-between; align-items: flex-start;
    border-bottom: 1px solid transparent; transition: 0.3s;
}
.record-header:hover { background: rgba(108, 99, 255, 0.05); }
.record-card.active .record-header { border-bottom-color: var(--border); background: rgba(108, 99, 255, 0.05); }

/* INFO LEFT */
.info-left { flex: 1; }
.user-name { margin: 0; font-size: 1.1rem; font-weight: 700; color: var(--text-main); }
.user-details { font-size: 0.85rem; color: var(--text-light); margin-top: 5px; line-height: 1.5; }

/* BADGE SEKTOR */
.badge-sector {
    display: inline-block; width: 140px; text-align: center;
    padding: 5px 0; margin-top: 6px; margin-bottom: 6px;
    border-radius: 8px; font-size: 0.7rem; font-weight: 800; 
    text-transform: uppercase; letter-spacing: 0.5px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.badge-awam { background: #EEF2FF; color: #6C63FF; border: 1px solid #C7D2FE; }
.badge-swasta { background: #ECFDF5; color: #10b981; border: 1px solid #A7F3D0; }

/* INFO RIGHT */
.header-right { text-align: right; display: flex; flex-direction: column; align-items: flex-end; gap: 5px; }
.money { font-size: 1.2rem; font-weight: 800; color: var(--primary); }
.date { font-size: 0.75rem; color: var(--text-light); }

.btn-trash {
    background: #fee2e2; color: #ef4444; border: none; width: 35px; height: 35px;
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
    cursor: pointer; margin-top: 5px; transition: 0.2s;
}
.btn-trash:hover { background: #ef4444; color: white; transform: scale(1.1); }

/* EXPANDED DETAILS */
.record-details { display: none; padding: 25px; background: rgba(0,0,0,0.02); animation: slideDown 0.3s ease; }
.record-card.active .record-details { display: block; }
@keyframes slideDown { from { opacity:0; transform:translateY(-10px); } to { opacity:1; transform:translateY(0); } }

.detail-section-title { font-size: 0.8rem; font-weight: 700; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; border-bottom: 1px dashed var(--border); padding-bottom: 5px; margin-top: 20px; }
.detail-section-title:first-child { margin-top: 0; }

.details-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
.detail-item { background: var(--surface); padding: 12px; border-radius: 12px; border: 1px solid var(--border); font-size: 0.85rem; text-align: center; overflow: hidden; }
.detail-item label { display: block; font-size: 0.75rem; color: var(--text-light); margin-bottom: 4px; font-weight: 600; text-overflow: ellipsis; white-space: nowrap; overflow: hidden; }
.detail-item strong { display: block; font-weight: 700; color: var(--text-main); line-height: 1.2; }
.detail-item small { display: block; font-size: 0.7rem; color: var(--text-light); margin-top: 4px; font-weight: 500; }

/* TABLE PENGALAMAN */
.exp-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85rem; }
.exp-table th { text-align: left; padding: 10px; border-bottom: 2px solid var(--border); color: var(--primary); font-size: 0.75rem; text-transform: uppercase; background: rgba(0,0,0,0.02); }
.exp-table td { padding: 10px; border-bottom: 1px solid var(--border); color: var(--text-main); vertical-align: top; }
.exp-table tr:last-child td { border-bottom: none; }

/* MODAL */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
    display: none; justify-content: center; align-items: center; z-index: 2000;
    opacity: 0; transition: opacity 0.3s;
}
.modal-overlay.show { display: flex; opacity: 1; }
.modal-box {
    background: var(--surface); padding: 30px; border-radius: 24px;
    width: 90%; max-width: 400px; text-align: center;
    box-shadow: 0 20px 50px rgba(0,0,0,0.2);
    transform: translateY(30px); transition: transform 0.3s; border: 1px solid var(--border);
}
.modal-overlay.show .modal-box { transform: translateY(0); }
.modal-icon {
    font-size: 2.5rem; color: #ef4444; margin-bottom: 15px;
    background: #fee2e2; width: 80px; height: 80px;
    border-radius: 50%; display: inline-flex; align-items: center; justify-content: center;
    animation: pulseRed 2s infinite;
}
@keyframes pulseRed { 0% {box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);} 70% {box-shadow: 0 0 0 15px rgba(239, 68, 68, 0);} 100% {box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);} }
.modal-title { font-size: 1.3rem; font-weight: 800; color: var(--text-main); margin-bottom: 8px; }
.modal-desc { font-size: 0.95rem; color: var(--text-light); margin-bottom: 25px; line-height: 1.5; }
.modal-actions { display: flex; gap: 12px; }
.btn-modal { flex: 1; padding: 14px; border-radius: 12px; font-weight: 700; cursor: pointer; border: none; font-size: 0.95rem; transition: 0.2s; }
.btn-cancel { background: #e2e8f0; color: #475569; }
.btn-cancel:hover { background: #cbd5e1; }
.btn-confirm-del { background: #ef4444; color: white; box-shadow: 0 5px 15px rgba(239, 68, 68, 0.3); }
.btn-confirm-del:hover { background: #dc2626; transform: translateY(-2px); }

/* FLOAT & TOAST */
.float-btn { position: fixed; width: 50px; height: 50px; border-radius: 50%; background: var(--surface); color: var(--text-main); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; z-index: 90; box-shadow: var(--shadow); transition: 0.3s; }
#themeBtn { bottom: 30px; left: 30px; }
#topBtn { bottom: 30px; right: 30px; opacity: 0; visibility: hidden; background: var(--primary); color: white; border: none; }
#topBtn.show { opacity: 1; visibility: visible; }
.toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: #10b981; color: white; padding: 12px 25px; border-radius: 30px; font-weight: 600; box-shadow: 0 10px 30px rgba(0,0,0,0.2); opacity: 0; z-index: 3000; transition: 0.4s; display: flex; align-items: center; gap: 8px; }
.toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

@media(max-width: 768px) {
    .navbar { flex-direction: column; gap: 15px; }
    .record-header { flex-direction: column; align-items: flex-start; gap: 15px; }
    .header-right { text-align: left; width: 100%; display: flex; flex-direction: row; justify-content: space-between; align-items: center; border-top: 1px solid var(--border); padding-top: 10px; }
    .search-container { flex-direction: column; align-items: stretch; border-radius: 20px; padding: 15px; }
    .count-tag { text-align: center; margin-top:10px; }
}
</style>
</head>
<body>

<div class="bg-blobs"><div class="blob blob-1"></div><div class="blob blob-2"></div></div>

<nav class="navbar" id="mainNav">
    <div class="brand"><i class="fa-solid fa-folder-open"></i> REKOD TERPERINCI</div>
    <div class="nav-links">
        <a href="dashboard.html" class="nav-link">Home</a>
        <a href="admin_users.html" class="nav-link">Users</a>
        <a href="admin_salary.html" class="nav-link">Gaji</a>
        <a href="admin_history.html" class="nav-link active">Rekod</a>
    </div>
</nav>

<div class="container">
    <h2 style="margin-bottom:20px; color:var(--text-main);">Sejarah Kiraan Lengkap</h2>
    
    <div class="search-container">
        <div class="search-input-wrapper">
            <i class="fa-solid fa-magnifying-glass search-icon"></i>
            <input type="text" id="searchInput" class="search-input" placeholder="Cari nama pemohon..." onkeyup="filterHistory()">
        </div>
        
        <select id="sortSelect" class="sort-select" onchange="filterHistory()">
            <option value="newest" selected>Terkini</option>
            <option value="oldest">Terlama</option>
            <option value="az">Nama (A-Z)</option>
        </select>

        <div class="count-tag">
            Jumlah: <span id="totalCount">0</span>
        </div>
    </div>

    <div id="recordsList">
        <p style="text-align:center; padding:40px; background:var(--surface); border-radius:20px; color:var(--text-light);">Sedang memuatkan data...</p>
    </div>
</div>

<div class="modal-overlay" id="deleteModal">
    <div class="modal-box">
        <div class="modal-icon"><i class="fa-solid fa-trash-can"></i></div>
        <h3 class="modal-title">Padam Rekod?</h3>
        <p class="modal-desc">Adakah anda pasti mahu memadam rekod ini secara kekal? Tindakan ini tidak boleh diundur.</p>
        <div class="modal-actions">
            <button class="btn-modal btn-cancel" onclick="closeModal()">Batal</button>
            <button class="btn-modal btn-confirm-del" onclick="confirmDelete()">Ya, Padam</button>
        </div>
    </div>
</div>

<button class="float-btn" id="themeBtn"><i class="fa-solid fa-moon"></i></button>
<button class="float-btn" id="topBtn" onclick="window.scrollTo({top:0, behavior:'smooth'})"><i class="fa-solid fa-arrow-up"></i></button>
<div id="toast" class="toast"><i class="fa-solid fa-check-circle"></i> Rekod berjaya dipadam!</div>

<script>
// --- ADMIN SECURITY CHECK ---
// Letak ini betul-betul lepas firebase config
if (!sessionStorage.getItem('admin_verified')) {
    alert("Akses tidak dibenarkan. Sila sahkan No. Staf.");
    window.location.href = 'admin_gate.html';
}
    const firebaseConfig = { apiKey: "AIzaSyDcCimpduiHdGyEmWHivg2tz_GkEgbnxf8", authDomain: "data-staff-6hha55.firebaseapp.com", projectId: "data-staff-6hha55", storageBucket: "data-staff-6hha55.firebasestorage.app", messagingSenderId: "834544418876", appId: "1:834544418876:web:71b355bd0f3faf73244339" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore(); const auth = firebase.auth();

    // UI Helpers
    let lastScrollTop = 0;
    const navbar = document.getElementById('mainNav');
    const topBtn = document.getElementById('topBtn');
    window.addEventListener('scroll', () => {
        let st = window.pageYOffset || document.documentElement.scrollTop;
        if (st > lastScrollTop && st > 100) navbar.classList.add('nav-hidden'); else navbar.classList.remove('nav-hidden');
        lastScrollTop = st;
        if (st > 300) topBtn.classList.add('show'); else topBtn.classList.remove('show');
    });

    const themeBtn = document.getElementById('themeBtn');
    if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
    themeBtn.onclick = () => {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
        themeBtn.innerHTML = document.body.classList.contains('dark-mode') ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';
    };

    function showToast() {
        const t = document.getElementById('toast');
        t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000);
    }

    // --- DATA LOGIC ---
    let allRecords = [];
    let deleteTargetId = null;

    auth.onAuthStateChanged(user => { if(user) loadHistory(); else location.href='login.html'; });

    async function loadHistory() {
        const container = document.getElementById('recordsList');
        try {
            // Get ALL records (no limit) to enable proper frontend sorting
            const snap = await db.collection('printedSlips').orderBy('timestamp', 'desc').get();
            if(snap.empty) { 
                container.innerHTML = '<p style="text-align:center;">Tiada rekod dijumpai.</p>'; 
                document.getElementById('totalCount').innerText = "0";
                return; 
            }

            allRecords = [];
            snap.forEach(doc => {
                let data = doc.data();
                data.id = doc.id;
                // Add sorting fallback for missing timestamp
                if(!data.timestamp) data.timestamp = { seconds: 0 };
                allRecords.push(data);
            });

            // Initial render
            renderList(allRecords);

        } catch(e) { console.error(e); container.innerHTML = "Ralat memuatkan data."; }
    }

    function renderList(dataArr) {
        const container = document.getElementById('recordsList');
        document.getElementById('totalCount').innerText = dataArr.length;
        container.innerHTML = "";

        if(dataArr.length === 0) {
            container.innerHTML = '<p style="text-align:center; padding:20px;">Tiada rekod ditemui.</p>';
            return;
        }

        let html = '';
        dataArr.forEach(d => {
            const dateStr = d.timestamp.seconds ? new Date(d.timestamp.seconds * 1000).toLocaleString('ms-MY', { day:'numeric', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit' }) : '-';
            
            // SEKTOR & COLOR LOGIC
            let sektor = d.jenis_sektor || d.kategori || 'Sektor Awam';
            if(sektor.toLowerCase().includes('swasta')) sektor = 'Sektor Swasta';
            else sektor = 'Sektor Awam';
            
            const tagClass = sektor === 'Sektor Swasta' ? 'badge-swasta' : 'badge-awam';
            const sektorLabel = sektor.toUpperCase();

            // Currency
            const rm = (val) => `RM ${parseFloat(val || 0).toFixed(2)}`;

            // Experience Table (Jika Swasta)
            let expTable = '';
            if(d.senarai_pengalaman && d.senarai_pengalaman.length > 0) {
                let rows = d.senarai_pengalaman.map(e => {
                    // Logic: Guna format lengkap baru (dari swasta.html) jika ada, jika tidak guna format lama
                    let durationText = e.tempoh_format_lengkap || `${e.tempoh_bulan || 0} Bulan`;
                    
                    // Tarikh format
                    let dateRange = '';
                    if(e.tarikh_mula && e.tarikh_tamat) {
                        // Kalau format string "YYYY-MM-DD"
                        dateRange = `${new Date(e.tarikh_mula).toLocaleDateString()} - ${new Date(e.tarikh_tamat).toLocaleDateString()}`;
                    }

                    let gajiLast = e.gaji_terakhir ? `RM ${parseFloat(e.gaji_terakhir).toFixed(2)}` : '-';
                    
                    return `
                        <tr>
                            <td><strong>${e.jawatan}</strong><br><small>${e.organisasi}</small></td>
                            <td>${gajiLast}</td>
                            <td>
                                ${dateRange ? `<span style="font-size:0.8rem">${dateRange}</span><br>` : ''}
                                <span style="font-weight:600; color:var(--primary); font-size:0.75rem;">${durationText}</span>
                            </td>
                        </tr>`;
                }).join('');
                
                expTable = `
                    <div class="detail-section-title">Rekod Pengalaman Terdahulu</div>
                    <div style="overflow-x:auto">
                        <table class="exp-table">
                            <thead>
                                <tr>
                                    <th width="35%">Jawatan / Organisasi</th>
                                    <th width="20%">Gaji Akhir</th>
                                    <th width="45%">Tempoh Perkhidmatan</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rows}
                                <tr style="background:rgba(0,0,0,0.02)">
                                    <td colspan="2" align="right"><strong>Jumlah Pengalaman Diambil Kira:</strong></td>
                                    <td><strong>${d.jumlah_tahun_pengalaman || 0} Tahun</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // Info PGT (Jika Awam)
            let awamInfo = '';
            if(sektor === 'Sektor Awam' && d.dapat_pgt) {
                awamInfo = `
                    <div class="detail-section-title">Maklumat Perkhidmatan</div>
                    <div class="details-grid">
                        <div class="detail-item"><label>Status PGT</label><strong>${d.dapat_pgt}</strong></div>
                        <div class="detail-item"><label>Bulan TPG</label><strong>${d.bulan_pergerakan || '-'}</strong></div>
                    </div>
                `;
            }

            // Pos Basik Name & Amount
            let posBasikVal = parseFloat(d.bipb || 0) || (d.nama_sijil_pos_basik ? 100 : 0);
            let posBasikName = d.nama_sijil_pos_basik ? `<br><small style="color:var(--primary);">${d.nama_sijil_pos_basik}</small>` : '';

            // HTML Structure
            html += `
            <div class="record-card" id="card-${d.id}">
                <div class="record-header">
                    <div class="info-left" onclick="toggleCard('${d.id}')">
                        <div class="user-name">${d.nama_penuh || 'User'}</div>
                        <div class="badge-sector ${tagClass}">${sektorLabel}</div>
                        <div class="user-details">
                            <i class="fa-solid fa-briefcase" style="width:20px; color:var(--primary);"></i> ${d.jawatan_terpilih || d.jawatan || '-'}<br>
                            <i class="fa-solid fa-location-dot" style="width:20px; color:var(--primary);"></i> ${d.wilayah_asal || '-'}
                        </div>
                    </div>
                    
                    <div class="header-right">
                        <div class="money">${rm(d.gaji_bersih)}</div>
                        <span class="date">${dateStr}</span>
                        <div style="display:flex; gap:10px; margin-top:5px;">
                            <button class="btn-trash" onclick="openDeleteModal('${d.id}')" title="Padam Rekod"><i class="fa-solid fa-trash"></i></button>
                            <button class="btn-trash" onclick="toggleCard('${d.id}')" style="background:#f1f5f9; color:var(--text-main);"><i class="fa-solid fa-chevron-down"></i></button>
                        </div>
                    </div>
                </div>
                
                <div class="record-details">
                    ${awamInfo}

                    <div class="detail-section-title">Pendapatan Utama</div>
                    <div class="details-grid">
                        <div class="detail-item"><label>Gaji Pokok Asal</label><strong>${rm(d.gaji_pokok || d.gaji_pokok_asal)}</strong></div>
                        <div class="detail-item"><label>Kenaikan KGT</label><strong>${rm(d.kgt_tambahan || d.jumlah_kenaikan_kgt)}</strong></div>
                        <div class="detail-item" style="border-color:var(--primary); background:rgba(108,99,255,0.05);"><label>Gaji Pokok Baru</label><strong style="color:var(--primary);">${rm(d.gaji_pokok_baru || d.gaji_pokok)}</strong></div>
                    </div>

                    <div class="detail-section-title">Perincian Elaun</div>
                    <div class="details-grid">
                        <div class="detail-item"><label>ITKA</label><strong>${rm(d.itka)}</strong></div>
                        <div class="detail-item"><label>ITP / Perumahan</label><strong>${rm(d.itp || d.el_perumahan)}</strong></div>
                        <div class="detail-item"><label>ITK / Keraian</label><strong>${rm(d.itk)}</strong></div>
                        <div class="detail-item"><label>BIPK / Kritikal</label><strong>${rm(d.bipk)}</strong></div>
                        <div class="detail-item"><label>BISH / COLA</label><strong>${rm(d.bish || d.cola)}</strong></div>
                        <div class="detail-item"><label>BIW / Wilayah</label><strong>${rm(d.biw || d.el_wilayah)}</strong></div>
                        <div class="detail-item"><label>BIP / Pakar</label><strong>${rm(d.bip || d.el_pakar)}</strong></div>
                        <div class="detail-item"><label>Insentif Pos Basik</label><strong>${rm(posBasikVal)}</strong>${posBasikName}</div>
                    </div>

                    ${expTable}
                </div>
            </div>`;
        });
        container.innerHTML = html;
    }

    // --- SEARCH & FILTER LOGIC ---
    function filterHistory() {
        const input = document.getElementById('searchInput').value.toLowerCase();
        const sortMode = document.getElementById('sortSelect').value;

        // 1. Search Filter
        let filtered = allRecords.filter(d => {
            const name = (d.nama_penuh || "").toLowerCase();
            const email = (d.email || "").toLowerCase();
            return name.includes(input) || email.includes(input);
        });

        // 2. Sort Logic
        filtered.sort((a, b) => {
            const timeA = a.timestamp ? (a.timestamp.seconds || 0) : 0;
            const timeB = b.timestamp ? (b.timestamp.seconds || 0) : 0;
            const nameA = (a.nama_penuh || "").toLowerCase();
            const nameB = (b.nama_penuh || "").toLowerCase();

            if (sortMode === 'newest') return timeB - timeA;
            if (sortMode === 'oldest') return timeA - timeB;
            if (sortMode === 'az') return nameA.localeCompare(nameB);
            return 0;
        });

        renderList(filtered);
    }

    window.toggleCard = function(id) {
        const card = document.getElementById(`card-${id}`);
        card.classList.toggle('active');
        const icon = card.querySelector('.fa-chevron-down');
        if(card.classList.contains('active')) icon.style.transform = 'rotate(180deg)';
        else icon.style.transform = 'rotate(0deg)';
    }

    // --- MODAL LOGIC ---
    window.openDeleteModal = function(id) {
        deleteTargetId = id;
        document.getElementById('deleteModal').classList.add('show');
    }
    window.closeModal = function() {
        document.getElementById('deleteModal').classList.remove('show');
        deleteTargetId = null;
    }
    window.confirmDelete = async function() {
        if(!deleteTargetId) return;
        try {
            await db.collection('printedSlips').doc(deleteTargetId).delete();
            closeModal();
            showToast();
            allRecords = allRecords.filter(r => r.id !== deleteTargetId);
            filterHistory();
        } catch(e) { alert("Ralat."); closeModal(); }
    }
</script>
</body>
</html>