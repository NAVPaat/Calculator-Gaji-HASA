<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Login â€” Calculator Gaji HASA UiTM</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script src="firebase-config.js"></script>

<style>
    /* ===== VARIABLES & RESET ===== */
    :root {
        --primary-grad: linear-gradient(135deg, #FF6B6B 0%, #5E2A84 100%);
        --text-dark: #1f2937;
        --text-muted: #6b7280;
        --radius: 16px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
        font-family: 'Inter', sans-serif;
        background: #fff;
        color: var(--text-dark);
        min-height: 100vh;
        width: 100%;
        overflow-x: hidden;
    }

    /* ===== SPLIT LAYOUT CONTAINER ===== */
    .split-container {
        display: flex;
        min-height: 100vh;
        width: 100%;
    }

    /* ===== LEFT SIDE (BRANDING) ===== */
    .branding-section {
        flex: 1; 
        background: var(--primary-grad);
        position: relative;
        display: flex;
        flex-direction: column;
        justify-content: center;
        padding: 40px;
        color: white;
        overflow: hidden;
    }

    .blob {
        position: absolute; border-radius: 50%; filter: blur(60px); opacity: 0.4; z-index: 0;
        animation: float 10s ease-in-out infinite; pointer-events: none;
    }
    .blob1 { width: 300px; height: 300px; background: #fff; top: -50px; left: -50px; opacity: 0.2; }
    .blob2 { width: 250px; height: 250px; background: #FF6B6B; bottom: -50px; right: -50px; animation-delay: 2s; }
    
    @keyframes float {
        0%, 100% { transform: translate(0, 0); }
        50% { transform: translate(20px, -20px); }
    }

    .branding-content {
        position: relative;
        z-index: 1; 
        max-width: 450px;
        margin: 0 auto;
    }

    .app-title {
        font-family: 'Poppins', sans-serif; font-weight: 800;
        font-size: 2.5rem; line-height: 1.2; margin-bottom: 15px;
        text-transform: uppercase; letter-spacing: -0.5px;
    }
    .app-subtitle {
        font-size: 1.1rem; line-height: 1.5; opacity: 0.9;
    }

    .back-nav-white {
        position: absolute; top: 30px; left: 30px; z-index: 10;
        display: flex; align-items: center; gap: 8px;
        color: white; text-decoration: none; font-weight: 600; font-size: 0.9rem;
        padding: 8px 12px; border-radius: 20px;
        background: rgba(255,255,255,0.1); backdrop-filter: blur(5px);
        transition: background 0.2s;
    }
    .back-nav-white:hover { background: rgba(255,255,255,0.2); }
    .back-nav-white svg { width: 20px; height: 20px; }

    /* ===== RIGHT SIDE (FORM) ===== */
    .form-section {
        flex: 1; 
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        background: #f9fafb;
    }

    .form-wrapper {
        width: 100%;
        max-width: 400px;
        padding: 30px;
        background: white;
        border-radius: var(--radius);
        box-shadow: 0 5px 25px rgba(0,0,0,0.05);
    }

    .form-wrapper h2 {
        font-family: 'Poppins', sans-serif; font-size: 1.5rem; font-weight: 600;
        margin-bottom: 25px; color: var(--text-dark); text-align: center;
    }

    .input-group { margin-bottom: 15px; position: relative; }
    .input {
        width: 100%; padding: 12px 14px; border: 1px solid #e5e7eb; border-radius: 10px;
        font-size: 0.95rem; background: #fff; font-family: 'Inter', sans-serif;
        transition: border-color 0.2s;
    }
    .input:focus { outline: none; border-color: #5E2A84; }

    .password-wrap { position: relative; }
    .show-pass-btn {
        position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
        background: none; border: none; cursor: pointer; color: #9ca3af; padding: 5px;
    }

    .btn {
        width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: 600; font-size: 0.95rem;
        cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 10px; font-family: 'Inter', sans-serif;
    }
    .btn-primary {
        background: var(--primary-grad); color: white; box-shadow: 0 5px 15px -3px rgba(94, 42, 132, 0.3);
    }
    .btn-google {
        background: white; color: #374151; border: 1px solid #e5e7eb;
    }

    .divider { display: flex; align-items: center; margin: 20px 0; color: #9ca3af; font-size: 0.8rem; font-weight: 500; }
    .divider::before, .divider::after { content: ""; flex: 1; height: 1px; background: #e5e7eb; }
    .divider span { padding: 0 10px; }

    .links-wrapper { text-align: center; margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
    .link { color: #5E2A84; text-decoration: none; font-size: 0.85rem; font-weight: 600; }
    
    #loginMsg { margin-top: 15px; font-size: 0.85rem; text-align: center; min-height: 18px; }

    .spinner { width: 16px; height: 16px; border: 2px solid; border-radius: 50%; display: none; animation: spin 0.8s linear infinite; }
    .spinner-white { border-color: #fff; border-bottom-color: transparent; }
    .spinner-dark { border-color: #333; border-bottom-color: transparent; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ===== MOBILE RESPONSIVE ===== */
    @media (max-width: 768px) {
        .split-container { flex-direction: column; }
        .branding-section { flex: none; padding: 40px 20px; text-align: center; min-height: 250px; }
        .back-nav-white { top: 20px; left: 20px; }
        .app-title { font-size: 1.8rem; }
        .app-subtitle { font-size: 1rem; }
        .blob1, .blob2 { width: 200px; height: 200px; }
        .form-section { flex: none; padding: 30px 20px; background: white; border-top-left-radius: 25px; border-top-right-radius: 25px; margin-top: -25px; z-index: 2; }
        .form-wrapper { box-shadow: none; padding: 10px 0; }
    }
</style>
</head>

<body>

    <div class="split-container">
        
        <div class="branding-section">
            <div class="blob blob1"></div>
            <div class="blob blob2"></div>

            <a href="index.html" class="back-nav-white">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                <span>Kembali</span>
            </a>

            <div class="branding-content">
                <h1 class="app-title">Calculator Gaji <br> HASA UiTM</h1>
                <p class="app-subtitle">Sistem pengiraan gaji yang pantas, mudah, dan tepat untuk kakitangan.</p>
            </div>
        </div>

        <div class="form-section">
            <div class="form-wrapper">
                <h2>Log Masuk</h2>

                <form id="loginForm" novalidate>
                    <div class="input-group">
                        <input id="email" class="input" type="email" placeholder="Alamat Email" required autocomplete="email">
                    </div>

                    <div class="input-group password-wrap">
                        <input id="password" class="input" type="password" placeholder="Kata Laluan" required autocomplete="current-password">
                        <button type="button" class="show-pass-btn" id="showPassBtn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                        </button>
                    </div>

                    <button id="loginBtn" type="submit" class="btn btn-primary">
                        <span>Login</span>
                        <span id="loginSpinner" class="spinner spinner-white"></span>
                    </button>

                    <div class="divider"><span>ATAU</span></div>

                    <button type="button" id="googleBtn" class="btn btn-google">
                        <svg width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g transform="matrix(1, 0, 0, 1, 27.009001, -39.238998)"><path fill="#4285F4" d="M -3.264 51.509 C -3.264 50.719 -3.334 49.969 -3.454 49.239 L -14.754 49.239 L -14.754 53.749 L -8.284 53.749 C -8.574 55.229 -9.424 56.479 -10.684 57.329 L -10.684 60.329 L -6.824 60.329 C -4.564 58.239 -3.264 55.159 -3.264 51.509 Z"/><path fill="#34A853" d="M -14.754 63.239 C -11.514 63.239 -8.804 62.159 -6.824 60.329 L -10.684 57.329 C -11.764 58.049 -13.134 58.489 -14.754 58.489 C -17.884 58.489 -20.534 56.379 -21.484 53.529 L -25.464 53.529 L -25.464 56.619 C -23.494 60.539 -19.444 63.239 -14.754 63.239 Z"/><path fill="#FBBC05" d="M -21.484 53.529 C -21.734 52.809 -21.864 52.039 -21.864 51.239 C -21.864 50.439 -21.734 49.669 -21.484 48.949 L -21.484 45.859 L -25.464 45.859 C -26.284 47.479 -26.754 49.299 -26.754 51.239 C -26.754 53.179 -26.284 54.999 -25.464 56.619 L -21.484 53.529 Z"/><path fill="#EA4335" d="M -14.754 43.989 C -12.984 43.989 -11.404 44.599 -10.154 45.789 L -6.734 42.369 C -8.804 40.429 -11.514 39.239 -14.754 39.239 C -19.444 39.239 -23.494 41.939 -25.464 45.859 L -21.484 48.949 C -20.534 46.099 -17.884 43.989 -14.754 43.989 Z"/></g></svg>
                        <span>Login dengan Google</span>
                        <span id="googleSpinner" class="spinner spinner-dark"></span>
                    </button>
                    
                    <div class="links-wrapper">
                        <a href="reset.html" class="link" style="color:#6b7280; font-weight:500;">Lupa kata laluan?</a>
                        <p style="font-size:0.85rem; color:#6b7280; margin-top:5px;">Belum ada akaun?</p>
                        <a href="signup.html" class="link">Daftar Akaun Baru</a>
                    </div>

                    <div id="loginMsg"></div>
                </form>
            </div>
        </div>
    </div>

<script>
(() => {
    const auth = firebase.auth();
    const db = firebase.firestore();

    const form = document.getElementById('loginForm');
    const emailEl = document.getElementById('email');
    const passInput = document.getElementById('password');
    const loginBtn = document.getElementById('loginBtn');
    const googleBtn = document.getElementById('googleBtn');
    const loginMsg = document.getElementById('loginMsg');
    const showBtn = document.getElementById('showPassBtn');
    
    const loginSpinner = document.getElementById('loginSpinner');
    const googleSpinner = document.getElementById('googleSpinner');

    function setMessage(text, type) {
        loginMsg.textContent = text || '';
        if (type === 'error') loginMsg.style.color = '#ef4444';
        else if (type === 'success') loginMsg.style.color = '#10b981';
        else loginMsg.style.color = '#6b7280';
    }

    function setLoading(isLoading, isGoogle = false) {
        if(isGoogle) {
            googleBtn.disabled = isLoading;
            googleSpinner.style.display = isLoading ? 'inline-block' : 'none';
        } else {
            loginBtn.disabled = isLoading;
            loginSpinner.style.display = isLoading ? 'inline-block' : 'none';
        }
    }

    async function checkUserAndRedirect(user) {
        setMessage('Sedang memproses data...', 'normal');
        try {
            const userRef = db.collection('users').doc(user.uid);
            const doc = await userRef.get();

            // 1. Jika User Sudah Ada
            if (doc.exists) {
                setMessage('Login berjaya! Mengalih...', 'success');
                setTimeout(() => window.location.href = 'greeting.html', 1000);
            } 
            // 2. Jika User Baru (Auto-Register)
            else {
                setMessage('Mendaftar masuk...', 'normal');
                
                // Tentukan Role (Admin vs User)
                let role = 'user';
                if (user.email && user.email.endsWith('@uitm.edu.my')) {
                    role = 'admin';
                }

                // Simpan Data Terus
                await userRef.set({
                    uid: user.uid,
                    email: user.email,
                    fullname: user.displayName ? user.displayName.toUpperCase() : 'PENGGUNA',
                    role: role,
                    photoURL: user.photoURL || '',
                    profileCompleted: true, // Auto complete
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                setMessage('Pendaftaran berjaya! Mengalih...', 'success');
                setTimeout(() => window.location.href = 'greeting.html', 1000);
            }
        } catch (error) {
            console.error(error);
            setMessage("Ralat sistem: " + error.message, 'error');
            setLoading(false, false);
            setLoading(false, true);
        }
    }

    // 1. Email Login
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        setMessage('');
        const email = emailEl.value.trim();
        const password = passInput.value;
        if (!email || !password) return setMessage('Sila isi email dan kata laluan.', 'error');
        
        setLoading(true, false);
        try {
            const userCredential = await auth.signInWithEmailAndPassword(email, password);
            await checkUserAndRedirect(userCredential.user);
        } catch (err) {
            let msg = err.message;
            if(err.code === 'auth/wrong-password') msg = 'Kata laluan salah.';
            if(err.code === 'auth/user-not-found') msg = 'Email tidak dijumpai.';
            setMessage(msg, 'error');
            setLoading(false, false);
        }
    });

    // 2. Google Login (AUTO SAVE)
    googleBtn.addEventListener('click', async () => {
        setMessage('');
        setLoading(true, true);
        const provider = new firebase.auth.GoogleAuthProvider();
        try {
            const result = await auth.signInWithPopup(provider);
            // Function ini akan handle auto-save kalau user tak wujud
            await checkUserAndRedirect(result.user);
        } catch (error) {
            console.error(error);
            setMessage(error.message, 'error');
            setLoading(false, true);
        }
    });

    showBtn.addEventListener('click', () => {
        const type = passInput.type === 'password' ? 'text' : 'password';
        passInput.type = type;
        showBtn.style.color = type === 'text' ? '#5E2A84' : '#9ca3af';
    });
})();
</script>
</body>
</html>
