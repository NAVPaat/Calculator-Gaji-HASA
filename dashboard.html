<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard — HASA UiTM</title>
<link rel="stylesheet" href="style.css">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="firebase-config.js"></script>
<script src="auth.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* ===== MODERN BACKGROUND & RESET ===== */
:root {
    --bg-dark: #0f172a;
    --accent-1: #4f46e5; /* Indigo */
    --accent-2: #ec4899; /* Pink */
    --accent-3: #06b6d4; /* Cyan */
}

* { box-sizing: border-box; }

body {
    margin: 0;
    padding: 0;
    font-family: 'Inter', sans-serif;
    background-color: var(--bg-dark);
    color: #f8fafc;
    min-height: 100vh;
    position: relative;
    overflow-x: hidden;
}

/* --- ANIMATED BACKGROUND --- */
.background-container {
    position: fixed;
    top: 0; left: 0; width: 100vw; height: 100vh;
    z-index: -2;
    overflow: hidden;
    background: var(--bg-dark);
}

/* Gradient Orbs */
.orb {
    position: absolute;
    border-radius: 50%;
    filter: blur(80px);
    opacity: 0.5;
    animation: floatOrb 20s infinite ease-in-out alternate;
}

.orb-1 {
    width: 60vw; height: 60vw;
    background: radial-gradient(circle, var(--accent-1), transparent 70%);
    top: -10%; left: -10%;
    animation-delay: 0s;
}

.orb-2 {
    width: 50vw; height: 50vw;
    background: radial-gradient(circle, var(--accent-2), transparent 70%);
    bottom: -10%; right: -10%;
    animation-delay: -5s;
}

.orb-3 {
    width: 40vw; height: 40vw;
    background: radial-gradient(circle, var(--accent-3), transparent 70%);
    top: 40%; left: 40%;
    opacity: 0.3;
    animation-delay: -10s;
}

@keyframes floatOrb {
    0% { transform: translate(0, 0) scale(1); }
    50% { transform: translate(30px, 40px) scale(1.1); }
    100% { transform: translate(-20px, -30px) scale(0.95); }
}

/* Subtle Grid Overlay */
.grid-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    z-index: -1;
    background-image: 
        linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
}

/* Glassmorphism Card Override */
.card, .stat-card {
    background: rgba(30, 41, 59, 0.6) !important; /* Semi-transparent Slate */
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    color: white;
}
.stat-number { color: #f8fafc !important; }
.stat-label, .stat-sub { color: #94a3b8 !important; }

/* ===== TOP PAYS LIP SUMMARY ===== */
#topPayslipSummary{ margin:12px auto; max-width:980px; }
#topPayslipSummary .stat-card{ padding:10px; min-width:110px; text-align:center; }
#payslipChartTop{ width:260px; height:160px; }
@media (max-width:720px){ #topPayslipSummary{ flex-direction:column; gap:10px; } #payslipChartTop{ width:100%; height:180px; } }

/* ===== STAT CARD LAYOUT ===== */
.stat-card-wrap {position:relative; overflow:hidden}
.stat-card {display:flex; flex-direction:column; gap:6px; padding:18px; border-radius:12px;}
.stat-label {font-size:13px; font-weight:600}
.stat-number {font-size:36px; font-weight:700;}
.stat-sub {font-size:12px;}

@media (max-width:720px){ .stat-number {font-size:28px} }

/* ===== BUTTONS & TEXT ===== */
h2, h3, h4 { color: white; margin-bottom: 8px; }
p, .small { color: #cbd5e1; }

.btn-outline {
    border: 1px solid rgba(255,255,255,0.3);
    color: white;
    padding: 8px 16px;
    border-radius: 8px;
    text-decoration: none;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.2s;
    background: rgba(255,255,255,0.05);
}
.btn-outline:hover {
    background: rgba(255,255,255,0.15);
    border-color: white;
    transform: translateY(-2px);
}

/* ===== GO TOP BUTTON ===== */
#goTopBtn {
    display: none; position: fixed; bottom: 30px; right: 30px; z-index: 99;
    border: none; outline: none; background-color: var(--accent-1); color: white;
    cursor: pointer; padding: 12px 16px; border-radius: 50%; font-size: 18px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: 0.3s;
}
#goTopBtn:hover { background-color: #4338ca; transform: translateY(-3px); }

/* FADE IN */
.fade-in { animation: fadeIn 0.6s ease-out forwards; opacity: 0; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

</style>
</head>
<body class="fade-in">

<div class="background-container">
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>
</div>
<div class="grid-overlay"></div>

<nav class="dashboard-nav">
    <div class="nav-left">
        <img src="image/HASA.png" class="nav-logo">
        <span class="nav-title">DASHBOARD CALCULATOR GAJI</span>
    </div>
    <div class="nav-right">
        <a href="dashboard.html" class="nav-link active">Dashboard</a>
        <a href="contohawam.html" class="nav-link">Kiraan Awam</a>        
        <a href="swasta.html" class="nav-link">Kiraan Swasta</a>
        <button id="logoutBtn" class="logout-btn">Logout</button>
    </div>
</nav>

<div id="topPayslipSummary" class="fx-summary">
  <div class="fx-stats">
    <div class="fx-card awam">
      <div class="fx-glow"></div>
      <div class="fx-label">CETAKAN AWAM</div>
      <div class="fx-value" id="awamCountTop">0</div>
      <div class="fx-sub">Sektor Kerajaan</div>
    </div>

    <div class="fx-card swasta">
      <div class="fx-glow"></div>
      <div class="fx-label">CETAKAN SWASTA</div>
      <div class="fx-value" id="swastaCountTop">0</div>
      <div class="fx-sub">Sektor Korporat</div>
    </div>
  </div>

  <div class="fx-chart">
    <div class="fx-chart-title">AGIHAN CETAKAN</div>
    <canvas id="payslipChartTop"></canvas>
  </div>
</div>

<div class="container grid-2" style="margin-top:20px;">
    <div class="side card">
        <h3 id="userName">Nama Pengguna</h3>
        <div class="small" id="userEmail">email@domain.com</div>
        <div style="height:12px"></div>
        <div class="kv"><div>Role</div><div id="userRole">-</div></div>
        <div class="kv"><div>Daftar</div><div id="userCreated">-</div></div>

        <div style="height:16px"></div>
        <a class="btn btn-outline" href="profile.html" style="width:100%; display:block; text-align:center; margin-bottom:8px;">EDIT PROFILE</a>
        
        <button id="sideLogoutBtn" class="btn btn-outline" style="width:100%; background-color: rgba(225, 29, 72, 0.2); border-color: #e11d48; color: #fda4af;">
            LOGOUT
        </button>
    </div>

    <div class="main-panel">
        <h2>Dashboard</h2>
        <p class="small">Selamat datang — Ini adalah ringkasan ringkas. Anda boleh akses profile, sistem kiraan gaji, atau mobile app via FlutterFlow.</p>

        <div style="height:12px"></div>
        <div class="card">
            <h4>Quick Actions</h4>
            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:8px">
                <a class="btn btn-outline" href="contohawam.html">KIRA GAJI — AWAM</a>
                <a class="btn btn-outline" href="swasta.html">KIRA GAJI — SWASTA</a>
                <a class="btn btn-outline" href="profile.html">EDIT PROFILE</a>
            </div>
        </div>

        <div style="height:12px"></div>
        <div id="payslipStats" class="card stat-card-wrap">
            <h4>Statistik Cetakan</h4>
            <div class="stat-card" style="background: rgba(255,255,255,0.03); margin-top:10px;">
                <div class="stat-label">Jumlah Cetakan Slip Gaji</div>
                <div class="stat-number" id="payslipCount">—</div>
                <div class="stat-sub">Sehingga kini</div>
            </div>
            <div class="small" style="margin-top:12px; opacity:0.7">Ringkasan Awam/Swasta dipaparkan di atas</div>
            <div id="payslipDebug" class="small" style="margin-top:8px; opacity:0.5; font-size:0.8rem">Status: Menunggu...</div>
        </div>

        <div style="height:12px"></div>
        <div id="moreArea" class="card">
            <h4>Data Akaun</h4>
            <div id="accountData" class="small" style="line-height:1.6"></div>
        </div> 
    </div>
</div>

<br>
<footer class="custom-footer" style="text-align:center; color:#94a3b8; padding:20px; font-size:0.9rem;">
    <div class="footer-content">
        © 2025 HASA UiTM — SISTEM KIRAAN GAJI
    </div>
</footer>

<button id="goTopBtn" title="Go to Top">↑</button>

<script>
// ===== LOGOUT LOGIC =====
function setupLogout(buttonId){
  const btn = document.getElementById(buttonId);
  if(!btn) return;

  btn.addEventListener('click', async () => {
    try {
      // Notification
      const notif = document.createElement('div');
      notif.textContent = 'Logout berjaya…';
      notif.style.cssText = "position:fixed; top:20px; left:50%; transform:translateX(-50%); background-color:#10b981; color:white; padding:12px 24px; border-radius:30px; font-weight:600; box-shadow:0 10px 25px rgba(0,0,0,0.3); z-index:9999; opacity:0; transition:opacity 0.3s ease;";
      document.body.appendChild(notif);

      setTimeout(() => notif.style.opacity = 1, 10);

      setTimeout(async () => {
        notif.remove();
        await firebase.auth().signOut();
        location.href = 'login.html';
      }, 1200);

    } catch (error) {
      console.error('Logout gagal:', error);
      alert('Logout gagal. Sila cuba lagi.');
    }
  });
}

setupLogout('logoutBtn');
setupLogout('sideLogoutBtn');
setupLogout('mobileLogoutBtn');


// ===== NAVBAR SCROLL EFFECT =====
const nav = document.querySelector('.dashboard-nav');
window.addEventListener('scroll', () => {
    if(nav) {
        const scrollTop = window.pageYOffset;
        nav.style.background = scrollTop > 50 ? 'rgba(15, 23, 42, 0.9)' : 'rgba(255, 255, 255, 0.1)';
        nav.style.backdropFilter = scrollTop > 50 ? 'blur(10px)' : 'blur(5px)';
    }
});

// ===== AUTH CHANGE =====
onAuthChange(async user => {
    if(!user){ location.href='login.html'; return; }

    const { uid, data } = await getCurrentUserDoc();

    // Fill Info
    document.getElementById('userName').textContent = data?.fullname || user.email;
    document.getElementById('userEmail').textContent = user.email;
    document.getElementById('userCreated').textContent = data?.createdAt ? new Date(data.createdAt.seconds*1000).toLocaleDateString() : '-';

    window.currentUser = { fullname: data?.fullname || user.email, email: user.email, createdAt: data?.createdAt };

    // Role
    let role = 'Pengguna';
    if(user.email.endsWith('@uitm.edu.my')){ role = 'Pentadbir'; }
    document.getElementById('userRole').textContent = role;
    window.currentUser.role = role;

    // Account Data HTML
    document.getElementById('accountData').innerHTML = `
        <div style="margin-bottom:4px"><strong>Nama:</strong> ${data?.fullname || '-'}</div>
        <div style="margin-bottom:4px"><strong>Telefon:</strong> ${data?.phone || '-'}</div>
        <div style="margin-bottom:4px"><strong>Email:</strong> ${data?.email || '-'}</div>
        <div style="margin-bottom:4px"><strong>Role:</strong> ${role}</div>
    `;

    if(typeof updatePayslipStats === 'function') updatePayslipStats();
});

/* ===== PAYSLIP STATS LOGIC ===== */
let _payslipUnsub = null;
let payslipChart = null; 
let currentFilter = 'all'; 

async function updatePayslipStats(){
    const el = document.getElementById('payslipCount');
    const debugEl = document.getElementById('payslipDebug');
    const setDebug = (m) => { if(debugEl) debugEl.textContent = m; };

    if(!el) return;
    el.textContent = '...';

    if(_payslipUnsub){ try{ _payslipUnsub(); }catch(e){} _payslipUnsub = null; }
    if(typeof firebase === 'undefined' || !firebase.firestore){ setDebug('Firebase Error'); return; }
    
    const db = firebase.firestore();
    setDebug('Menyambung ke database...');

    const renderCount = (n) => { el.textContent = n; setDebug(`Dikemaskini: ${new Date().toLocaleTimeString()}`); };

    const updateCountsDisplay = (awam, swasta) => {
        const aTop = document.getElementById('awamCountTop');
        const sTop = document.getElementById('swastaCountTop');
        if(aTop) animateCount(aTop, awam || 0);
        if(sTop) animateCount(sTop, swasta || 0);
        renderPayslipChart(Number(awam) || 0, Number(swasta) || 0);
    };

    // Try finding collection
    const candidateColls = ['printedSlips','prints','print_logs'];
    let found = false;

    for(const coll of candidateColls){
        try {
            const snap = await db.collection(coll).limit(500).get();
            if(!snap.empty){
                found = true;
                // Initial Count
                let c = {awam:0, swasta:0, total:0};
                snap.forEach(d => {
                     c.total++;
                     const t = (d.data().jenis_kiraan || '').toLowerCase();
                     if(t.includes('awam')) c.awam++;
                     else if(t.includes('swasta')) c.swasta++;
                });
                renderCount(snap.size); // Just showing logic for sample, ideally use size
                updateCountsDisplay(c.awam, c.swasta);

                // Realtime
                _payslipUnsub = db.collection(coll).onSnapshot(s => {
                    let rc = {awam:0, swasta:0};
                    s.forEach(d => {
                        const t = (d.data().jenis_kiraan || '').toLowerCase();
                        if(t.includes('awam')) rc.awam++;
                        else if(t.includes('swasta')) rc.swasta++;
                    });
                    renderCount(s.size);
                    updateCountsDisplay(rc.awam, rc.swasta);
                });
                break;
            }
        } catch(e) { console.log(e); }
    }
    
    if(!found) {
        renderCount(0);
        setDebug('Tiada rekod cetakan dijumpai.');
    }
}

// ===== CHART JS =====
function renderPayslipChart(a, b){
    const canvas = document.getElementById('payslipChartTop');
    if(!canvas) return;

    const ctx = canvas.getContext('2d');
    const total = a + b;

    // Center Text Plugin
    const centerTextPlugin = {
        id: 'centerText',
        afterDraw(chart) {
            const { ctx, chartArea } = chart;
            if (!chartArea) return;
            const x = (chartArea.left + chartArea.right) / 2;
            const y = (chartArea.top + chartArea.bottom) / 2;
            
            ctx.save();
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.font = '700 24px Inter';
            ctx.fillStyle = '#ffffff'; // White text for dark bg
            ctx.fillText(chart.centerValue !== undefined ? chart.centerValue : total, x, y - 5);
            ctx.font = '500 12px Inter';
            ctx.fillStyle = '#94a3b8';
            ctx.fillText(chart.centerLabel || 'Jumlah', x, y + 15);
            ctx.restore();
        }
    };

    if(payslipChart){
        payslipChart.data.datasets[0].data = [a, b];
        payslipChart.update();
        return;
    }

    payslipChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Awam', 'Swasta'],
            datasets: [{
                data: [a, b],
                backgroundColor: ['#6366f1', '#ec4899'], // Indigo & Pink
                borderWidth: 0,
                hoverOffset: 10
            }]
        },
        options: {
            cutout: '75%',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: { 
                    backgroundColor: 'rgba(15, 23, 42, 0.9)',
                    titleColor: '#fff',
                    bodyColor: '#cbd5e1',
                    padding: 10,
                    cornerRadius: 8,
                    displayColors: true 
                }
            }
        },
        plugins: [centerTextPlugin]
    });
}

function animateCount(el, target){
    if(!el) return;
    let start = 0; const duration = 1000;
    const startTime = performance.now();
    function tick(now){
        const p = Math.min((now - startTime)/duration, 1);
        const ease = 1 - Math.pow(1 - p, 3);
        el.textContent = Math.floor(ease * target);
        if(p < 1) requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
}

// ===== UI UTILS =====
document.addEventListener("DOMContentLoaded", function() {
    const goTopBtn = document.getElementById("goTopBtn");
    if(goTopBtn){
        window.addEventListener("scroll", () => {
            goTopBtn.style.display = window.scrollY > 200 ? "block" : "none";
        });
        goTopBtn.addEventListener("click", ()=>window.scrollTo({ top: 0, behavior: 'smooth' }));
    }
});

</script>
</body>
</html>
