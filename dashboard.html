<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard â€” HASA UiTM</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="firebase-config.js"></script>
<script src="auth.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* ===== THEME VARIABLES ===== */
:root {
    --bg-main: #f8fafc;
    --bg-card: #ffffff;
    --text-primary: #0f172a;
    --text-secondary: #64748b;
    --brand-blue: #4f46e5;
    --brand-green: #10b981;
    --border-light: #e2e8f0;
    --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.1);
    --shadow-md: 0 10px 15px -3px rgb(0 0 0 / 0.1);
}

* { box-sizing: border-box; }

body {
    margin: 0;
    padding: 0;
    font-family: 'Inter', sans-serif;
    background-color: var(--bg-main);
    color: var(--text-primary);
    min-height: 100vh;
    position: relative;
    overflow-x: hidden;
}

/* =========================================
   ANIMATED BACKGROUND (AURORA EFFECT)
   ========================================= */
.animated-bg {
    position: absolute;
    top: 0; left: 0; width: 100%;
    height: 380px; /* Tinggi header */
    background: linear-gradient(-45deg, #c4b5fd, #67e8f9, #93c5fd, #f0abfc);
    background-size: 400% 400%;
    animation: gradientMove 12s ease infinite; /* Kelajuan pergerakan */
    z-index: -1;
    /* Lengkung moden di bawah */
    border-bottom-left-radius: 40px;
    border-bottom-right-radius: 40px;
    box-shadow: 0 10px 40px rgba(79, 70, 229, 0.15);
}

/* Overlay putih nipis supaya teks mudah dibaca */
.animated-bg::after {
    content: '';
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(5px);
}

@keyframes gradientMove {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

/* ===== LAYOUT ===== */
.container { max-width: 1200px; margin: 0 auto; padding: 20px; }
.grid-2 { display: grid; grid-template-columns: 280px 1fr; gap: 24px; }
@media (max-width: 900px) { .grid-2 { grid-template-columns: 1fr; } }

/* ===== CARDS ===== */
.card, .fx-card {
    background: var(--bg-card);
    border: 1px solid var(--border-light);
    border-radius: 16px;
    padding: 24px;
    box-shadow: var(--shadow-sm);
    transition: all 0.3s ease;
}
.card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }

/* ===== TYPOGRAPHY ===== */
h2 { font-size: 1.8rem; margin: 0 0 10px 0; font-weight: 800; }
h3 { font-size: 1.2rem; margin: 0 0 10px 0; }
h4 { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-secondary); margin: 0 0 15px 0; font-weight: 700; }
p, .small { color: var(--text-secondary); line-height: 1.6; }

/* ===== NAVBAR ===== */
.dashboard-nav {
    display: flex; justify-content: space-between; align-items: center;
    padding: 15px 30px;
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(12px); /* Glass effect */
    border-bottom: 1px solid rgba(255,255,255,0.5);
    position: sticky; top: 0; z-index: 100;
}
.nav-left { display: flex; align-items: center; gap: 12px; }
.nav-logo { height: 38px; }
.nav-title { font-weight: 800; font-size: 1.1rem; color: #1e293b; }
.nav-right { display: flex; gap: 20px; align-items: center; }
.nav-link { text-decoration: none; color: #475569; font-weight: 600; font-size: 0.9rem; transition: 0.2s; }
.nav-link:hover, .nav-link.active { color: var(--brand-blue); }

/* ===== BUTTONS ===== */
.btn-outline {
    display: inline-block;
    border: 2px solid var(--border-light);
    color: var(--text-primary);
    padding: 10px 20px;
    border-radius: 10px;
    text-decoration: none;
    font-size: 13px; font-weight: 700;
    transition: all 0.2s; background: white; text-align: center;
}
.btn-outline:hover {
    border-color: var(--brand-blue); color: var(--brand-blue);
    background: #f8fafc; transform: translateY(-2px);
}
.logout-btn {
    background: #fee2e2; color: #ef4444; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 700; cursor: pointer; transition: 0.2s;
}
.logout-btn:hover { background: #fecaca; }

/* ===== INTERACTIVE STATS ===== */
.fx-summary { display: flex; gap: 24px; margin-bottom: 30px; }
.fx-stats { flex: 1; display: flex; flex-direction: column; gap: 20px; }
.fx-chart { flex: 1.2; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; min-height: 260px; background: rgba(255,255,255,0.9); }

.fx-card {
    flex: 1; display: flex; flex-direction: column; justify-content: center; cursor: pointer;
    background: rgba(255,255,255,0.9); /* Sedikit transparent supaya nampak bg bergerak */
}
.fx-card.awam { border-left: 5px solid var(--brand-blue); }
.fx-card.swasta { border-left: 5px solid var(--brand-green); }

.fx-card:hover { transform: scale(1.02); }
.fx-card.active-filter { background: #f1f5f9 !important; border-color: transparent; }

.fx-value { font-size: 2.8rem; font-weight: 800; color: var(--text-primary); line-height: 1; }
.fx-label { font-size: 0.8rem; font-weight: 700; color: var(--text-secondary); letter-spacing: 1px; }

#payslipChartTop { width: 100%; max-height: 200px; }
.fx-chart-title { position: absolute; top: 20px; left: 24px; font-weight: 800; color: var(--text-secondary); font-size: 0.8rem; }
#resetFilterBtn {
    position: absolute; top: 15px; right: 20px; padding: 5px 12px; background: var(--brand-blue); color: white;
    border: none; border-radius: 20px; font-size: 0.7rem; font-weight: 700; cursor: pointer; display: none;
}

@media (max-width: 800px) { .fx-summary { flex-direction: column; } .fx-stats { flex-direction: row; } }
@media (max-width: 600px) { .fx-stats { flex-direction: column; } }

/* ===== OTHER ===== */
.stat-number { font-size: 3rem; font-weight: 800; color: var(--text-primary); }
.kv { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border-light); font-size: 0.9rem; }
#goTopBtn { display: none; position: fixed; bottom: 30px; right: 30px; width: 45px; height: 45px; background: var(--brand-blue); color: white; border: none; border-radius: 50%; font-size: 20px; cursor: pointer; box-shadow: var(--shadow-md); z-index: 99; }

/* Animation fade in page */
.fade-in { animation: fadeIn 0.8s ease-out forwards; opacity: 0; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

.custom-footer { text-align:center; color: var(--text-secondary); padding:40px 20px; font-size:0.9rem; margin-top: 40px; }
</style>
</head>
<body class="fade-in">

<div class="animated-bg"></div>

<nav class="dashboard-nav">
    <div class="nav-left">
        <img src="image/HASA.png" class="nav-logo" alt="Logo">
        <span class="nav-title">SISTEM KIRAAN GAJI</span>
    </div>
    <div class="nav-right">
        <a href="dashboard.html" class="nav-link active">Dashboard</a>
        <a href="contohawam.html" class="nav-link">Kiraan Awam</a>        
        <a href="swasta.html" class="nav-link">Kiraan Swasta</a>
        <button id="logoutBtn" class="logout-btn">Logout</button>
    </div>
</nav>

<div class="container">
    <div id="topPayslipSummary" class="fx-summary">
      <div class="fx-stats">
        <div class="fx-card awam" id="cardAwam">
          <div class="fx-label">CETAKAN AWAM</div>
          <div class="fx-value" id="awamCountTop">0</div>
          <div class="fx-sub">Sektor Kerajaan</div>
        </div>

        <div class="fx-card swasta" id="cardSwasta">
          <div class="fx-label">CETAKAN SWASTA</div>
          <div class="fx-value" id="swastaCountTop">0</div>
          <div class="fx-sub">Sektor Korporat</div>
        </div>
      </div>

      <div class="fx-chart card">
        <div class="fx-chart-title">AGIHAN CETAKAN</div>
        <button id="resetFilterBtn">â†» Reset</button>
        <canvas id="payslipChartTop"></canvas>
      </div>
    </div>

    <div class="grid-2">
        <div class="side">
            <div class="card">
                <h3 id="userName">Memuatkan...</h3>
                <div class="small" id="userEmail">...</div>
                <div style="height:20px"></div>
                <div class="kv"><div>Peranan</div><div id="userRole">-</div></div>
                <div class="kv"><div>Daftar</div><div id="userCreated">-</div></div>

                <div style="height:25px"></div>
                <a class="btn-outline" href="profile.html" style="width:100%; margin-bottom:10px;">EDIT PROFILE</a>
                <button id="sideLogoutBtn" class="btn-outline" style="width:100%; border-color: #fee2e2; color: #ef4444; background: #fff1f2;">LOGOUT</button>
            </div>
        </div>

        <div class="main-panel">
            <div class="card" style="border:none; background:transparent; box-shadow:none; padding:0; margin-bottom: 20px;">
                <h2 style="color:#1e293b;">Selamat Datang</h2>
                <p class="small" style="font-size:1rem; color:#475569;">Papan pemuka utama untuk mengurus dan memantau rekod kiraan gaji.</p>
            </div>

            <div class="card">
                <h4>Pautan Pantas</h4>
                <div style="display:flex; gap:12px; flex-wrap:wrap;">
                    <a class="btn-outline" href="contohawam.html" style="border-color: var(--brand-blue); color: var(--brand-blue);">ðŸ–© Kiraan Awam</a>
                    <a class="btn-outline" href="swasta.html" style="border-color: var(--brand-green); color: var(--brand-green);">ðŸ–© Kiraan Swasta</a>
                </div>
            </div>

            <div style="height:24px"></div>

            <div id="payslipStats" class="card">
                <h4>Statistik Keseluruhan</h4>
                <div style="text-align: center; padding: 20px 0;">
                    <div class="stat-number" id="payslipCount">â€”</div>
                    <div style="font-size: 1.1rem; color:var(--text-secondary); margin-top:10px;">Jumlah Cetakan Slip Gaji</div>
                </div>
                <div style="border-top: 1px solid var(--border-light); padding-top: 15px; text-align: center;">
                    <div id="payslipDebug" class="small" style="opacity:0.6; font-size:0.8rem">Menunggu data...</div>
                </div>
            </div>

            <div style="height:24px"></div>

            <div id="moreArea" class="card">
                <h4>Maklumat Akaun</h4>
                <div id="accountData" class="small" style="line-height:1.8;"></div>
            </div> 
        </div>
    </div>
</div>

<footer class="custom-footer">
    Â© 2025 HASA UiTM â€” Sistem Kiraan Gaji Kakitangan
</footer>

<button id="goTopBtn" title="Go to Top">â†‘</button>

<script>
/* ========================
   LOGOUT LOGIC
   ======================== */
function setupLogout(buttonId){
  const btn = document.getElementById(buttonId);
  if(!btn) return;
  btn.addEventListener('click', async () => {
    try {
      const notif = document.createElement('div');
      notif.textContent = 'Sedang Log Keluar...';
      notif.style.cssText = "position:fixed; top:30px; left:50%; transform:translateX(-50%); background: #0f172a; color:white; padding:12px 25px; border-radius:50px; font-weight:600; box-shadow: 0 10px 20px rgba(0,0,0,0.2); z-index:9999;";
      document.body.appendChild(notif);
      
      setTimeout(async () => {
        await firebase.auth().signOut();
        location.href = 'login.html';
      }, 1500);
    } catch (e) { alert('Logout gagal.'); }
  });
}
setupLogout('logoutBtn');
setupLogout('sideLogoutBtn');

/* ========================
   AUTH CHANGE
   ======================== */
onAuthChange(async user => {
    if(!user){ location.href='login.html'; return; }
    const { uid, data } = await getCurrentUserDoc();

    document.getElementById('userName').textContent = data?.fullname || user.email.split('@')[0];
    document.getElementById('userEmail').textContent = user.email;
    document.getElementById('userCreated').textContent = data?.createdAt ? new Date(data.createdAt.seconds*1000).toLocaleDateString('en-GB') : '-';

    let role = user.email.endsWith('@uitm.edu.my') ? 'Pentadbir' : 'Pengguna';
    document.getElementById('userRole').textContent = role;

    document.getElementById('accountData').innerHTML = `
        <div style="display:flex; border-bottom:1px solid #eee; padding:8px 0;"><strong style="width:100px">Nama:</strong> ${data?.fullname || '-'}</div>
        <div style="display:flex; border-bottom:1px solid #eee; padding:8px 0;"><strong style="width:100px">Telefon:</strong> ${data?.phone || '-'}</div>
        <div style="display:flex; border-bottom:1px solid #eee; padding:8px 0;"><strong style="width:100px">Email:</strong> ${data?.email || '-'}</div>
    `;

    if(typeof updatePayslipStats === 'function') updatePayslipStats();
});

/* ========================
   STATS & CHART LOGIC
   ======================== */
let _payslipUnsub = null;
let payslipChart = null; 

async function updatePayslipStats(){
    const el = document.getElementById('payslipCount');
    const debugEl = document.getElementById('payslipDebug');
    if(!el) return; el.textContent = '...';

    const db = firebase.firestore();
    const updateUI = (total, awam, swasta) => {
        el.textContent = total;
        animateCount(document.getElementById('awamCountTop'), awam || 0);
        animateCount(document.getElementById('swastaCountTop'), swasta || 0);
        renderPayslipChart(Number(awam) || 0, Number(swasta) || 0);
        if(debugEl) debugEl.textContent = `Kemaskini terakhir: ${new Date().toLocaleTimeString()}`;
    };

    // Cari koleksi
    const candidateColls = ['printedSlips','prints','print_logs'];
    let found = false;

    for(const coll of candidateColls){
        try {
            const snap = await db.collection(coll).limit(1).get();
            if(!snap.empty){
                found = true;
                _payslipUnsub = db.collection(coll).onSnapshot(s => {
                    let c = {awam:0, swasta:0};
                    s.forEach(d => {
                        const t = (d.data().jenis_kiraan || '').toLowerCase();
                        if(t.includes('awam')) c.awam++;
                        else if(t.includes('swasta')) c.swasta++;
                    });
                    updateUI(s.size, c.awam, c.swasta);
                });
                break;
            }
        } catch(e){}
    }
    if(!found) { updateUI(0, 0, 0); if(debugEl) debugEl.textContent = 'Tiada data cetakan.'; }
}

function renderPayslipChart(a, b){
    const canvas = document.getElementById('payslipChartTop');
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    const total = a + b;

    const centerTextPlugin = {
        id: 'centerText',
        afterDraw(chart) {
            const { ctx, chartArea } = chart;
            if (!chartArea) return;
            const x = (chartArea.left + chartArea.right) / 2;
            const y = (chartArea.top + chartArea.bottom) / 2;
            
            ctx.save();
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.font = '800 24px Inter'; ctx.fillStyle = '#0f172a';
            ctx.fillText(chart.centerValue !== undefined ? chart.centerValue : total, x, y - 5);
            ctx.font = '600 12px Inter'; ctx.fillStyle = '#64748b';
            ctx.fillText(chart.centerLabel || 'Jumlah', x, y + 15);
            ctx.restore();
        }
    };

    if(payslipChart){
        payslipChart.data.datasets[0].data = [a, b];
        payslipChart.update();
        if(!canvas.dataset.init) { setupChartInteraction(payslipChart, a, b); canvas.dataset.init = true; }
        return;
    }

    payslipChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Awam', 'Swasta'],
            datasets: [{
                data: [a, b],
                backgroundColor: ['#4f46e5', '#10b981'],
                borderWidth: 2, borderColor: '#ffffff',
                hoverOffset: 10, borderRadius: 5
            }]
        },
        options: {
            cutout: '75%', responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false }, tooltip: { backgroundColor: '#1e293b', padding: 12, cornerRadius: 8 } }
        },
        plugins: [centerTextPlugin]
    });
    setupChartInteraction(payslipChart, a, b);
    canvas.dataset.init = true;
}

function setupChartInteraction(chart, awamTotal, swastaTotal) {
    const cardAwam = document.getElementById('cardAwam');
    const cardSwasta = document.getElementById('cardSwasta');
    const resetBtn = document.getElementById('resetFilterBtn');
    const summaryContainer = document.getElementById('topPayslipSummary');
    const dataset = chart.data.datasets[0];

    const applyFilter = (type) => {
        resetBtn.style.display = 'block';
        cardAwam.classList.remove('active-filter');
        cardSwasta.classList.remove('active-filter');
        if (type === 'awam') {
            cardAwam.classList.add('active-filter');
            dataset.backgroundColor = ['#4f46e5', '#e2e8f0']; 
            chart.centerValue = awamTotal; chart.centerLabel = 'Awam';
        } else {
            cardSwasta.classList.add('active-filter');
            dataset.backgroundColor = ['#e2e8f0', '#10b981'];
            chart.centerValue = swastaTotal; chart.centerLabel = 'Swasta';
        }
        chart.update();
    };

    resetBtn.onclick = () => {
        resetBtn.style.display = 'none';
        cardAwam.classList.remove('active-filter');
        cardSwasta.classList.remove('active-filter');
        dataset.backgroundColor = ['#4f46e5', '#10b981'];
        delete chart.centerValue; chart.centerLabel = 'Jumlah';
        chart.update();
    };

    cardAwam.onclick = () => applyFilter('awam');
    cardSwasta.onclick = () => applyFilter('swasta');
}

function animateCount(el, target){
    if(!el) return;
    let start = 0; const duration = 1000; const startTime = performance.now();
    function tick(now){
        const p = Math.min((now - startTime)/duration, 1);
        const ease = 1 - Math.pow(1 - p, 3);
        el.textContent = Math.floor(ease * target);
        if(p < 1) requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
}

document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("goTopBtn");
    window.onscroll = () => { btn.style.display = window.scrollY > 300 ? "block" : "none"; };
    btn.onclick = () => window.scrollTo({ top: 0, behavior: 'smooth' });
});
</script>
</body>
</html>
