<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Profil Pengguna â€” HASA UiTM</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="firebase-config.js"></script>
<script src="auth.js"></script>

<style>
    /* =========================================
       1. CORE THEME: PURPLE (SINGLE PAGE)
       ========================================= */
    :root {
        --primary: #7C3AED;       /* Violet 600 */
        --primary-dark: #5B21B6;  /* Violet 800 */
        --secondary: #A78BFA;     /* Violet 400 */
        --bg-body: #F5F3FF;       /* Violet 50 */
        --surface: #ffffff;
        --text-main: #334155;
        --text-light: #64748b;
        --border: #e2e8f0;
        --shadow-card: 0 20px 40px -10px rgba(124, 58, 237, 0.15);
        --radius: 24px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }

    body {
        font-family: 'Poppins', sans-serif;
        background-color: var(--bg-body);
        color: var(--text-main);
        height: 100vh; /* Single Page */
        display: flex; flex-direction: column;
        overflow: hidden; 
    }
    body.loaded { opacity: 1; }

    /* BACKGROUND BLOBS */
    .bg-blobs { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: var(--bg-body); overflow: hidden; }
    .blob { position: absolute; filter: blur(80px); opacity: 0.6; z-index: -1; animation: floatBlob 10s infinite alternate; }
    .blob-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: #DDD6FE; }
    .blob-2 { bottom: -10%; right: -10%; width: 60vw; height: 60vw; background: #EDE9FE; }
    @keyframes floatBlob { 0% { transform: translate(0,0); } 100% { transform: translate(20px, 40px); } }

    /* =========================================
       2. NAVBAR (UPDATED FOR SMOOTH MOBILE)
       ========================================= */
    .navbar {
        display: flex; justify-content: space-between; align-items: center;
        padding: 15px 5%; margin: 20px 20px 0 20px;
        background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px);
        border-radius: 50px; box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        position: relative; z-index: 1000; flex-shrink: 0;
    }
    
    .brand { display: flex; align-items: center; gap: 10px; font-weight: 800; font-size: 1.2rem; color: var(--primary); }
    .brand img { height: 32px; }

    .nav-center { display: flex; gap: 30px; }
    .nav-link { color: var(--text-light); font-weight: 600; font-size: 0.95rem; text-decoration: none; transition: 0.3s; position: relative; }
    .nav-link:hover, .nav-link.active { color: var(--primary); }
    .nav-link.active::after { content:''; position: absolute; bottom:-5px; left:50%; transform:translateX(-50%); width: 6px; height: 6px; background: var(--primary); border-radius: 50%; }

    .user-pill {
        display: flex; align-items: center; gap: 12px;
        background: white; padding: 5px 5px 5px 20px;
        border-radius: 50px; cursor: pointer; transition: all 0.3s ease;
        border: 1px solid transparent;
    }
    .text-container { display: flex; flex-direction: column; align-items: flex-end; overflow: hidden; height: 20px; justify-content: center; position: relative; width: 100px; }
    .user-name { font-weight: 600; font-size: 0.9rem; color: var(--text-main); position: absolute; right: 0; transition: 0.3s; text-transform: uppercase; }
    .logout-text { font-weight: 700; font-size: 0.9rem; color: #ef4444; position: absolute; right: 0; transform: translateY(20px); opacity: 0; transition: 0.3s; }
    .avatar { width: 38px; height: 38px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; transition: 0.3s; }

    .user-pill:hover { background: #fee2e2; border-color: #ef4444; }
    .user-pill:hover .user-name { transform: translateY(-20px); opacity: 0; }
    .user-pill:hover .logout-text { transform: translateY(0); opacity: 1; }
    .user-pill:hover .avatar { background: #ef4444; }

    .hamburger { display: none; font-size: 1.5rem; color: var(--text-main); cursor: pointer; }

    /* =========================================
       3. PROFILE CARD LAYOUT
       ========================================= */
    .main-wrapper {
        flex: 1; display: flex; align-items: center; justify-content: center;
        padding: 30px; position: relative; z-index: 10;
    }

    .container { width: 100%; max-width: 1000px; }

    .glass-panel {
        background: white; 
        border-radius: var(--radius); 
        padding: 50px; 
        box-shadow: var(--shadow-card); 
        border: 1px solid white;
        display: flex; gap: 50px; align-items: flex-start;
        min-height: 500px; 
    }

    /* LEFT SIDE: INFO */
    .profile-left { 
        flex: 1; 
        text-align: center; 
        border-right: 1px dashed var(--border); 
        padding-right: 50px; 
        display: flex; flex-direction: column; 
        align-items: center; justify-content: center; 
        height: 100%; 
        align-self: stretch; 
    }
    
    .big-avatar {
        width: 120px; height: 120px; 
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center;
        font-size: 3.5rem; font-weight: 700; margin-bottom: 20px;
        box-shadow: 0 15px 30px rgba(124, 58, 237, 0.3); 
        border: 4px solid white;
    }
    
    .profile-title { font-size: 1.3rem; font-weight: 800; color: var(--text-main); margin-bottom: 5px; letter-spacing: -0.5px; }
    .profile-subtitle { 
        font-size: 0.9rem; color: var(--text-light); 
        background: #F5F3FF; padding: 5px 12px; border-radius: 20px; 
        display: inline-block; margin-top: 5px;
    }

    /* RIGHT SIDE: FORM */
    .profile-right { flex: 2; padding-top: 10px; }

    .form-section-title {
        font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1.5px;
        color: var(--primary); font-weight: 800; margin-bottom: 25px;
        border-bottom: 2px dashed #e2e8f0; padding-bottom: 15px;
    }

    label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; color: var(--text-main); }
    
    input[type="text"], input[type="email"] {
        width: 100%; padding: 14px 18px; 
        border: 1px solid var(--border); border-radius: 14px; 
        background: #f8fafc; color: var(--text-main); 
        font-size: 0.95rem; font-family: 'Poppins', sans-serif; 
        transition: 0.3s; margin-bottom: 20px;
    }
    
    input:focus { 
        background: white; border-color: var(--primary); 
        box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.1); 
    }
    
    input[readonly] { 
        background: #f1f5f9; color: #94a3b8; cursor: not-allowed; 
        border-color: #f1f5f9;
    }

    .row { display: flex; gap: 25px; }
    .col { flex: 1; }

    /* BUTTONS */
    .btn-primary { 
        width: 100%; padding: 16px; border: none; border-radius: 50px;
        font-weight: 700; font-size: 1rem; cursor: pointer; transition: 0.3s;
        background: var(--primary); color: white; margin-top: 15px;
        box-shadow: 0 10px 20px -5px rgba(124, 58, 237, 0.4); 
        display: flex; align-items: center; justify-content: center; gap: 10px;
    }
    .btn-primary:hover { transform: translateY(-3px); background: var(--primary-dark); box-shadow: 0 15px 30px -5px rgba(124, 58, 237, 0.5); }
    .btn-primary:disabled { background: #cbd5e1; cursor: not-allowed; transform: none; box-shadow: none; }

    /* MESSAGES */
    .msg-box { margin-top: 15px; padding: 15px; border-radius: 12px; font-size: 0.9rem; text-align: center; display: none; }
    .msg-success { background: #F3E8FF; color: #6B21A8; border: 1px solid #D8B4FE; }
    .msg-error { background: #FEF2F2; color: #991B1B; border: 1px solid #FECACA; }

    /* RESPONSIVE & MOBILE MENU ANIMATION */
    @media (max-width: 900px) {
        body { height: auto; overflow-y: auto; }
        .navbar { margin: 0; border-radius: 0; padding: 15px; top: 0; }
        
        /* Mobile Nav Container - Hidden State */
        .nav-center { 
            display: flex; 
            flex-direction: column; 
            position: absolute; 
            top: 100%; 
            left: 0; 
            width: 100%; 
            background: white; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.05); 
            gap: 15px; 
            text-align: center;
            
            /* Animation Properties */
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            padding: 0 20px; /* No vertical padding when closed */
            transition: all 0.4s ease-in-out; /* Smooth Slide */
        }
        
        /* Mobile Nav Container - Active State */
        .nav-center.active { 
            max-height: 400px; /* Sufficient height to open */
            opacity: 1;
            padding: 20px; /* Restore padding */
        }
        
        .user-pill { display: none; }
        .hamburger { display: block; }
        
        .main-wrapper { padding: 20px; }
        .glass-panel { flex-direction: column; padding: 30px; gap: 30px; }
        .profile-left { 
            border-right: none; border-bottom: 1px dashed var(--border); 
            padding-right: 0; padding-bottom: 30px; width: 100%; 
        }
        .row { flex-direction: column; gap: 0; }
        input { margin-bottom: 15px; }
    }
</style>
</head>

<body>

    <div class="bg-blobs">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
    </div>

  <nav class="navbar" id="mainNavbar">
        <div class="brand">
            <img src="image/HASA.png" alt="Logo" onerror="this.style.display='none'">
            <span>HASA UiTM</span>
        </div>

        <div class="nav-center" id="navMenu">
            <a href="dashboard.html" class="nav-link" title="Halaman Utama">Dashboard</a>
            <a href="contohawam.html" class="nav-link" title="Kiraan Sektor Awam">Kiraan Awam</a>
            <a href="swasta.html" class="nav-link" title="Kiraan Sektor Swasta">Kiraan Swasta</a>
            <a href="profile.html" class="nav-link active" title="Profil Pengguna">Profile</a>
            <a href="#" id="mobileLogout" class="nav-link" style="color:#ef4444; display:none;">Log Keluar</a>
        </div>

        <div style="display:flex; align-items:center; gap:15px;">
            <div class="user-pill" id="logoutBtn" title="Tekan untuk Log Keluar">
                <div class="text-container">
                    <span class="user-name" id="navName">Loading...</span>
                    <span class="logout-text">Log Keluar</span>
                </div>
                <div class="avatar" id="navAvatar">?</div>
            </div>
            <div class="hamburger" onclick="toggleMenu()">
                <i class="fa-solid fa-bars"></i>
            </div>
        </div>
    </nav>

    <div class="main-wrapper">
        <div class="container">
            
            <div class="glass-panel">
                
                <div class="profile-left">
                    <div class="big-avatar" id="bigAvatar">U</div>
                    <div class="profile-title" id="displayFullname">Pengguna</div>
                    <div class="profile-subtitle">Ahli sejak: <span id="displayDate">-</span></div>
                </div>

                <div class="profile-right">
                    <div class="form-section-title">KEMASKINI MAKLUMAT</div>
                    
                    <form id="profileForm">
                        <div class="row">
                            <div class="col">
                                <label>Nama Penuh</label>
                                <input type="text" id="fullname" placeholder="Masukkan nama penuh..." required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col">
                                <label>Nombor Telefon</label>
                                <input type="text" id="phone" placeholder="Contoh: 012-3456789" required>
                            </div>
                            <div class="col">
                                <label>Alamat Emel</label>
                                <input type="email" id="email" readonly>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col">
                                <label>Peranan</label>
                                <input type="text" id="role" readonly style="text-transform: capitalize;">
                            </div>
                            <div class="col">
                                <label>Tarikh Daftar</label>
                                <input type="text" id="joinedDate" readonly>
                            </div>
                        </div>

                        <div id="profileMsg" class="msg-box"></div>

                        <button type="submit" id="saveBtn" class="btn-primary">
                            <i class="fa-solid fa-save"></i> SIMPAN PERUBAHAN
                        </button>
                    </form>
                </div>

            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            document.body.classList.add("loaded");
            
            // Mobile Menu Logout Link Logic
            const mobileLogout = document.getElementById('mobileLogout');
            if(mobileLogout) {
                mobileLogout.addEventListener('click', () => {
                    if(document.getElementById('logoutBtn')) {
                        document.getElementById('logoutBtn').click();
                    }
                });
            }
        });

        // ===================================
        // SMOOTH HAMBURGER TOGGLE
        // ===================================
        function toggleMenu() {
            const navMenu = document.getElementById('navMenu');
            const mobileLogout = document.getElementById('mobileLogout');
            
            navMenu.classList.toggle('active');
            
            if (navMenu.classList.contains('active')) {
                if(window.innerWidth <= 900) mobileLogout.style.display = 'block';
            }
        }

        // ===================================
        // LOGIC PROFILE (FIREBASE)
        // ===================================
        const logoutBtn = document.getElementById('logoutBtn');
        const profileForm = document.getElementById('profileForm');
        const msgBox = document.getElementById('profileMsg');
        const saveBtn = document.getElementById('saveBtn');

        let currentUserUid = null;

        // 1. Load Data
        onAuthChange(async user => {
            if(!user){ location.href='login.html'; return; }
            currentUserUid = user.uid;
            
            saveBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Memuatkan...';
            saveBtn.disabled = true;

            try {
                const { data } = await getCurrentUserDoc();
                
                // Set Inputs
                document.getElementById('fullname').value = data?.fullname || '';
                document.getElementById('phone').value = data?.phone || '';
                document.getElementById('email').value = user.email;
                
                // Update Side Panel Info
                let displayName = data?.fullname || user.email.split('@')[0];
                document.getElementById('displayFullname').innerText = displayName;
                document.getElementById('bigAvatar').innerText = displayName.charAt(0).toUpperCase();

                // Role Logic
                const role = user.email.endsWith('@uitm.edu.my') ? 'Staf UiTM' : 'Pengguna Awam';
                document.getElementById('role').value = role;

                // Format Date
                let joined = '-';
                if(data?.createdAt && data.createdAt.seconds) {
                    joined = new Date(data.createdAt.seconds * 1000).toLocaleDateString('en-GB');
                }
                document.getElementById('joinedDate').value = joined;
                document.getElementById('displayDate').innerText = joined;

            } catch (e) {
                console.error("Error loading profile", e);
                showMsg('Gagal memuatkan data profil.', 'error');
            } finally {
                saveBtn.innerHTML = '<i class="fa-solid fa-save"></i> SIMPAN PERUBAHAN';
                saveBtn.disabled = false;
            }
        });

        // 2. Auth State Changed (For Navbar Name Update - FIRST NAME ONLY)
        firebase.auth().onAuthStateChanged(async user => {
            const nameEl = document.getElementById('navName');
            const avatarEl = document.getElementById('navAvatar');

            if(nameEl && user) {
                let finalName = user.email.split('@')[0];
                try {
                    const doc = await firebase.firestore().collection('users').doc(user.uid).get();
                    if(doc.exists && doc.data().fullname) {
                        finalName = doc.data().fullname;
                    }
                } catch(e) { console.error("Error fetching name:", e); }

                // --- ADJUSTMENT: AMBIL FIRST NAME SAHAJA ---
                const firstName = finalName.split(' ')[0];
                
                nameEl.innerText = firstName;
                if(avatarEl) avatarEl.innerText = firstName.charAt(0).toUpperCase();
            }
        });

        // 3. Extra Safety Check
        document.addEventListener("DOMContentLoaded", async () => {
            if (typeof loadJawatanFromFirebase === 'function') {
                await loadJawatanFromFirebase();
            }
            if (typeof addExperienceRow === 'function') {
                addExperienceRow();
            }
            if (typeof setupUI === 'function') {
                setupUI();
            }
        });

        // 4. Update Data Logic
        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            msgBox.style.display = 'none';
            saveBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Menyimpan...';
            saveBtn.disabled = true;

            const fullname = document.getElementById('fullname').value.trim();
            const phone = document.getElementById('phone').value.trim();

            if(!fullname || !phone){
                showMsg('Sila lengkapkan nama dan nombor telefon.', 'error');
                resetBtn();
                return;
            }

            try {
                await firebase.firestore().collection('users').doc(currentUserUid).update({
                    fullname,
                    phone,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Update Visual Side Panel (Kekal Nama Penuh di sini)
                document.getElementById('displayFullname').innerText = fullname;
                document.getElementById('bigAvatar').innerText = fullname.charAt(0).toUpperCase();
                
                // Update Navbar Name Immediately (FIRST NAME SAHAJA)
                const firstName = fullname.split(' ')[0];
                document.getElementById('navName').innerText = firstName;
                document.getElementById('navAvatar').innerText = firstName.charAt(0).toUpperCase();

                showMsg('Profil berjaya dikemaskini!', 'success');
                setTimeout(() => msgBox.style.display = 'none', 3000);

            } catch(err){
                showMsg('Ralat sistem. Sila cuba lagi.', 'error');
                console.error(err);
            } finally {
                resetBtn();
            }
        });

        // 5. Logout Logic
        logoutBtn.addEventListener('click', async () => {
            if(confirm("Log keluar dari sistem?")) {
                await firebase.auth().signOut();
                location.href='login.html';
            }
        });

        function showMsg(text, type) {
            msgBox.textContent = text;
            msgBox.className = `msg-box msg-${type}`;
            msgBox.style.display = 'block';
        }

        function resetBtn() {
            saveBtn.innerHTML = '<i class="fa-solid fa-save"></i> SIMPAN PERUBAHAN';
            saveBtn.disabled = false;
        }
    </script>

</body>
</html>
